<script>
  // === Credenciales ===
  const SUPABASE_URL = "https://eqynjddcosvdqjzztznn.supabase.co";
  const SUPABASE_ANON_KEY = "TU_ANON_KEY_AQUI";
  const sb = window.sb || (window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY));

  const out = document.getElementById('out');
  const toggleBtn = document.getElementById('toggle');
  const switchBtn = document.getElementById('switchCam');
  const filePick = document.getElementById('filePick');

  const totalKgEl = document.getElementById('totalKg');
  const countLinesEl = document.getElementById('countLines');
  const fpShortEl = document.getElementById('fpShort');

  let scanner = null;
  let running = false;
  let cameras = [];
  let camIndex = 0;

  // anti spam (aunque tu backend ya está blindado)
  let busy = false;
  const BUSY_COOLDOWN_MS = 900;

  function log(txt, cls=""){
    out.innerHTML = (cls ? `<span class="${cls}">${txt}</span>` : txt);
  }

  function safeParseJson(text){
    const t = (text||"").trim();
    return JSON.parse(t);
  }

  function hashQr(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return "QR_" + (h >>> 0).toString(16);
  }

  // ✅ NUEVO: Canoniza SKU para que "pata morena" -> "PATA_MORENA"
  function canonSku(s){
    return String(s||"")
      .trim()
      .toUpperCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"") // quita acentos
      .replace(/\s+/g,"_"); // espacios -> _
  }

  function normalizePayload(raw, decodedText){
    // QR como array
    if(Array.isArray(raw)){
      const items = raw.map(x => ({
        sku: canonSku(x.producto || x.sku || ""),   // ✅ aquí
        kg: Number(x.cantidad ?? x.kg ?? 0)
      })).filter(it => it.sku && Number.isFinite(it.kg));
      return { qr_id: hashQr(decodedText), items };
    }

    // QR como objeto
    if(raw && typeof raw === "object"){
      let items = raw.items;
      if(!Array.isArray(items) && Array.isArray(raw.productos)) items = raw.productos;

      items = (items || []).map(x => ({
        sku: canonSku(x.sku || x.producto || ""),   // ✅ aquí
        kg: Number(x.kg ?? x.cantidad ?? 0)
      })).filter(it => it.sku && Number.isFinite(it.kg));

      return { qr_id: String(raw.qr_id || hashQr(decodedText)), items };
    }
    return null;
  }

  // ✅ suma de kilos total
  function calcTotalKg(items){
    let sum = 0;
    for(const it of (items||[])){
      const k = Number(it.kg);
      if(Number.isFinite(k)) sum += k;
    }
    return sum;
  }

  function updateTotalsUI(payload, fingerprint){
    const totalKg = calcTotalKg(payload.items);
    totalKgEl.textContent = totalKg.toFixed(2);
    countLinesEl.textContent = String(payload.items.length || 0);
    fpShortEl.textContent = fingerprint ? fingerprint.slice(0, 10) : "—";
  }

  async function procesar(payload, fingerprint){
    log("Procesando venta…");

    // ✅ mandamos fingerprint para idempotencia server-side
    const { data, error } = await sb.rpc('procesar_venta_qr', {
      payload,
      p_fingerprint: fingerprint
    });

    if(error){
      log("ERROR RPC: " + error.message, "bad");
      return;
    }

    if(data?.code === 'DUPLICATE'){
      log("Ticket ya procesado (DUPLICATE). No se descontó otra vez ✅", "ok");
      return;
    }

    if(!data?.ok){
      log("NO OK:\n" + JSON.stringify(data, null, 2), "bad");
      return;
    }

    log("✅ Venta aplicada.\n\n" + JSON.stringify(data, null, 2), "ok");
  }

  async function handleDecoded(decodedText){
    if(busy) return;
    busy = true;

    try{
      const raw = safeParseJson(decodedText);
      const payload = normalizePayload(raw, decodedText);

      if(!payload?.items?.length){
        log("QR inválido: no pude formar items\n\n" + decodedText, "bad");
        return;
      }

      const fingerprint = hashQr(decodedText);

      // ✅ Mostrar total inmediatamente al escanear
      updateTotalsUI(payload, fingerprint);

      // ✅ Procesar venta
      await procesar(payload, fingerprint);

    }catch(e){
      log("No pude leer JSON del QR.\n\n" + e.message + "\n\nContenido:\n" + decodedText, "bad");
    }finally{
      setTimeout(()=> busy = false, BUSY_COOLDOWN_MS);
    }
  }

  async function onScanSuccess(decodedText){
    await handleDecoded(decodedText);
  }

  async function refreshCameras(){
    cameras = await Html5Qrcode.getCameras();
    if(!Array.isArray(cameras)) cameras = [];
    switchBtn.style.display = (cameras.length >= 2) ? "block" : "none";

    const idxBack = cameras.findIndex(c => /back|rear|environment|trasera/i.test(c.label || ""));
    if(idxBack >= 0) camIndex = idxBack;
  }

  async function startWithCurrentCamera(){
    if(!scanner) scanner = new Html5Qrcode("reader");
    if(!cameras.length) await refreshCameras();

    running = true;
    toggleBtn.textContent = "Detener cámara";

    const config = {
      fps: 15,
      qrbox: (vw, vh) => {
        const size = Math.min(vw, vh) * 0.78;
        return { width: Math.floor(size), height: Math.floor(size) };
      },
      disableFlip: true,
      experimentalFeatures: { useBarCodeDetectorIfSupported: true }
    };

    const constraints = cameras.length
      ? { deviceId: { exact: cameras[camIndex].id } }
      : { facingMode: { ideal: "environment" }, width:{ ideal:1920 }, height:{ ideal:1080 } };

    try{
      await scanner.start(constraints, config, onScanSuccess);
      log("Cámara lista. Escanea un ticket. (Total KG se muestra arriba)");
    }catch(e){
      running = false;
      toggleBtn.textContent = "Iniciar cámara";
      log("No pude iniciar cámara. Revisa permisos y HTTPS.", "bad");
    }
  }

  async function start(){
    if(running) return;
    await refreshCameras();
    await startWithCurrentCamera();
  }

  async function stop(){
    if(!running) return;
    running = false;
    toggleBtn.textContent = "Iniciar cámara";
    try{ await scanner.stop(); }catch(e){}
    log("Cámara detenida.");
  }

  async function switchCamera(){
    if(cameras.length < 2){
      log("Solo hay 1 cámara disponible.", "bad");
      return;
    }
    camIndex = (camIndex + 1) % cameras.length;
    const name = cameras[camIndex]?.label || `Cámara ${camIndex+1}`;
    log("Cambiando a: " + name + "…");
    if(running){ await stop(); await start(); }
  }

  // ✅ MODO FOTO (muy confiable)
  filePick.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      if(!scanner) scanner = new Html5Qrcode("reader");
      log("Leyendo foto… (modo seguro)");
      const decodedText = await scanner.scanFile(file, true);
      await handleDecoded(decodedText);
    }catch(err){
      console.error(err);
      log("No pude leer la foto. Tip: más cerca, sin reflejo y el QR grande.", "bad");
    }finally{
      filePick.value = "";
    }
  });

  toggleBtn.addEventListener('click', async ()=>{
    if(!running) await start(); else await stop();
  });

  switchBtn.addEventListener('click', switchCamera);

  refreshCameras();
</script>
