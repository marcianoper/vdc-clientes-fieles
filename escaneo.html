<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>VDC â€” Escanear QR (Mostrador)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e5e7eb}
    header{padding:14px 16px;background:#111827;border-bottom:1px solid rgba(255,255,255,.08);font-weight:900}
    .wrap{max-width:920px;margin:0 auto;padding:14px 16px}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    button,label.btn{width:100%;display:block;text-align:center;padding:12px 14px;border:0;border-radius:14px;font-weight:900;cursor:pointer}
    .btn2{background:#60a5fa;color:#071a2f;margin-top:10px}
    .btn4{background:#22c55e;color:#052e16;margin-top:10px}
    .log{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;opacity:.95}
    .ok{color:#22c55e} .bad{color:#fb7185}
    input[type="file"]{display:none}

    .bigTotal{
      margin-top:12px;
      background:rgba(34,197,94,.15);
      border:1px solid rgba(34,197,94,.3);
      border-radius:18px;
      padding:16px;
      text-align:center;
    }
    .bigTotal h1{
      margin:0;
      font-size:42px;
      color:#22c55e;
    }
  </style>
</head>
<body>
<header>VDC â€” Escanear QR</header>
<div class="wrap">

  <div class="card">
    <div id="reader" style="width:100%"></div>
    <button class="btn2" id="toggle">Iniciar cÃ¡mara</button>
    <label class="btn btn4" for="filePick">ðŸ“¸ Subir foto</label>
    <input id="filePick" type="file" accept="image/*" capture="environment">

    <div class="bigTotal">
      TOTAL KG DEL TICKET
      <h1 id="totalKg">0.00</h1>
    </div>
  </div>

  <div style="height:12px"></div>

  <div class="card">
    <div id="out" class="log">Listo.</div>
  </div>

</div>

<script>
  const SUPABASE_URL = "https://eqynjddcosvdqjzztznn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeW5qZGRjb3N2ZHFqenp0em5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMzYwMzIsImV4cCI6MjA3MTcxMjAzMn0.Q51wsGelUvxRfqsMYRY5JduCGyZ7s6AzOhqsRf3kOhk";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const out = document.getElementById('out');
  const toggleBtn = document.getElementById('toggle');
  const filePick = document.getElementById('filePick');
  const totalKgEl = document.getElementById('totalKg');

  let scanner = null;
  let running = false;
  let busy = false;

  function log(txt, cls=""){
    out.innerHTML = cls ? `<span class="${cls}">${txt}</span>` : txt;
  }

  // ðŸ”¥ NORMALIZADOR CANÃ“NICO
  function canonSku(s){
    return String(s||"")
      .trim()
      .toUpperCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/\s+/g, "_");
  }

  // ðŸ‘€ Mostrar bonito
  function prettySku(s){
    return s.replace(/_/g," ");
  }

  function hashQr(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return "QR_" + (h >>> 0).toString(16);
  }

  function safeParse(text){
    return JSON.parse((text||"").trim());
  }

  function normalizePayload(raw, decodedText){
    const items = [];

    if(Array.isArray(raw)){
      raw.forEach(x=>{
        const sku = canonSku(x.producto || x.sku);
        const kg  = Number(x.cantidad ?? x.kg ?? 0);
        if(sku && kg>0){
          items.push({ sku, kg });
        }
      });
    }

    return { qr_id: hashQr(decodedText), items };
  }

  function calcTotal(items){
    return items.reduce((sum,i)=> sum + Number(i.kg||0), 0);
  }

  async function procesar(payload){
    const { data, error } = await sb.rpc('procesar_venta_qr',{
      payload,
      p_fingerprint: payload.qr_id
    });

    if(error){
      log("ERROR RPC: "+error.message,"bad");
      return;
    }

    if(data?.code==="DUPLICATE"){
      log("Ticket duplicado ignorado âœ…","ok");
      return;
    }

    if(!data?.ok){
      log(JSON.stringify(data,null,2),"bad");
      return;
    }

    log("Venta aplicada correctamente âœ…","ok");
  }

  async function handleDecoded(decodedText){
    if(busy) return;
    busy=true;

    try{
      const raw = safeParse(decodedText);
      const payload = normalizePayload(raw, decodedText);

      if(!payload.items.length){
        log("QR invÃ¡lido","bad");
        return;
      }

      // ðŸ”¥ Mostrar total
      const total = calcTotal(payload.items);
      totalKgEl.textContent = total.toFixed(2);

      await procesar(payload);

    }catch(e){
      log("Error leyendo QR: "+e.message,"bad");
    }

    setTimeout(()=>busy=false,1000);
  }

  async function start(){
    if(running) return;
    if(!scanner) scanner = new Html5Qrcode("reader");
    running=true;
    toggleBtn.textContent="Detener cÃ¡mara";
    await scanner.start({facingMode:"environment"}, {fps:10}, handleDecoded);
  }

  async function stop(){
    if(!running) return;
    running=false;
    toggleBtn.textContent="Iniciar cÃ¡mara";
    await scanner.stop();
  }

  toggleBtn.onclick=()=> running?stop():start();

  filePick.addEventListener("change", async e=>{
    const file = e.target.files?.[0];
    if(!file) return;
    if(!scanner) scanner=new Html5Qrcode("reader");
    const decoded = await scanner.scanFile(file,true);
    await handleDecoded(decoded);
  });
</script>
</body>
</html>
