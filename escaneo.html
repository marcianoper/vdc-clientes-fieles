<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>VDC — Escanear QR (Mostrador)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e5e7eb}
    header{padding:14px 16px;background:#111827;border-bottom:1px solid rgba(255,255,255,.08);font-weight:900}
    .wrap{max-width:920px;margin:0 auto;padding:14px 16px}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    button{width:100%;padding:12px 14px;border:0;border-radius:14px;font-weight:900;cursor:pointer}
    .btn2{background:#60a5fa;color:#071a2f;margin-top:10px}
    .btn3{background:#f59e0b;color:#1f1300;margin-top:10px}
    .log{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;opacity:.95}
    .ok{color:#22c55e} .bad{color:#fb7185} .muted{opacity:.8;font-size:12px}
  </style>
</head>
<body>
<header>VDC — Escanear QR (Mostrador)</header>
<div class="wrap">
  <div class="card">
    <div id="reader" style="width:100%"></div>
    <div class="muted" style="margin-top:10px">Apunta al QR del ticket. Se aplicará la venta automáticamente.</div>
    <button class="btn2" id="toggle">Iniciar cámara</button>
    <button class="btn3" id="switchCam" style="display:none">Cambiar cámara</button>
  </div>

  <div style="height:12px"></div>

  <div class="card">
    <div class="muted">Resultado:</div>
    <div id="out" class="log">Listo.</div>
  </div>
</div>

<script>
  // === Credenciales ===
  const SUPABASE_URL = "https://eqynjddcosvdqjzztznn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeW5qZGRjb3N2ZHFqenp0em5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMzYwMzIsImV4cCI6MjA3MTcxMjAzMn0.Q51wsGelUvxRfqsMYRY5JduCGyZ7s6AzOhqsRf3kOhk";
  const sb = window.sb || (window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY));

  const out = document.getElementById('out');
  const toggleBtn = document.getElementById('toggle');
  const switchBtn = document.getElementById('switchCam');

  let scanner = null;
  let running = false;

  let cameras = [];
  let camIndex = 0;

  let lastQr = "";
  let lastTs = 0;

  function log(txt, cls=""){
    out.innerHTML = (cls ? `<span class="${cls}">${txt}</span>` : txt);
  }

  function safeParseJson(text){
    const t = (text||"").trim();
    return JSON.parse(t);
  }

  async function procesar(payload){
    const now = Date.now();
    const qrId = payload?.qr_id || "";
    if(qrId && qrId === lastQr && (now-lastTs) < 2500) return;
    lastQr = qrId; lastTs = now;

    log("Procesando venta…");

    // ✅ OJO: tu cliente es sb (no "supabase")
    const { data, error } = await sb.rpc('procesar_venta_qr', { payload });

    if(error){
      log("ERROR RPC: " + error.message, "bad");
      return;
    }
    if(!data?.ok){
      log("NO OK: " + JSON.stringify(data, null, 2), "bad");
      return;
    }
    const cls = (data.code === 'OK') ? "ok" : "";
    log(JSON.stringify(data, null, 2), cls);
  }

  async function onScanSuccess(decodedText){
    try{
      const payload = safeParseJson(decodedText);
      if(!payload?.items || !payload?.qr_id){
        log("QR inválido: falta qr_id o items\n\n" + decodedText, "bad");
        return;
      }
      await procesar(payload);
    }catch(e){
      log("No pude leer JSON del QR.\n\n" + e.message + "\n\nContenido:\n" + decodedText, "bad");
    }
  }

  async function refreshCameras(){
    cameras = await Html5Qrcode.getCameras();
    if(!Array.isArray(cameras)) cameras = [];
    // mostrar botón de cambiar si hay 2+
    switchBtn.style.display = (cameras.length >= 2) ? "block" : "none";

    // intenta elegir trasera por nombre (cuando el browser lo permite)
    const idxBack = cameras.findIndex(c =>
      /back|rear|environment|trasera/i.test(c.label || "")
    );
    if(idxBack >= 0) camIndex = idxBack;
  }

  async function startWithCurrentCamera(){
    if(!scanner) scanner = new Html5Qrcode("reader");
    if(!cameras.length) await refreshCameras();

    running = true;
    toggleBtn.textContent = "Detener cámara";

    // ✅ Preferir trasera:
    // 1) si hay lista de cámaras y tenemos id -> deviceId exact
    // 2) si no hay labels/ids, intentamos facingMode environment
    const config = { fps: 12, qrbox: { width: 280, height: 280 } };

    try{
      if(cameras.length){
        const camId = cameras[camIndex]?.id;
        await scanner.start({ deviceId: { exact: camId } }, config, onScanSuccess);
      }else{
        await scanner.start({ facingMode: "environment" }, config, onScanSuccess);
      }
      log("Cámara lista (preferencia: trasera). Escanea un ticket.");
    }catch(err){
      console.error(err);
      // fallback: si falló deviceId, intenta environment
      try{
        await scanner.start({ facingMode: "environment" }, config, onScanSuccess);
        log("Cámara lista (fallback trasera). Escanea un ticket.");
      }catch(e2){
        console.error(e2);
        running = false;
        toggleBtn.textContent = "Iniciar cámara";
        log("No pude iniciar cámara. Revisa permisos del navegador.", "bad");
      }
    }
  }

  async function start(){
    if(running) return;
    await refreshCameras();
    await startWithCurrentCamera();
  }

  async function stop(){
    if(!running) return;
    running = false;
    toggleBtn.textContent = "Iniciar cámara";
    try{ await scanner.stop(); }catch(e){}
    log("Cámara detenida.");
  }

  async function switchCamera(){
    if(cameras.length < 2){
      log("Solo hay 1 cámara disponible.", "bad");
      return;
    }
    camIndex = (camIndex + 1) % cameras.length;

    const name = cameras[camIndex]?.label || `Cámara ${camIndex+1}`;
    log("Cambiando a: " + name + "…");

    if(running){
      await stop();
      await start();
    }
  }

  toggleBtn.addEventListener('click', async ()=>{
    if(!running) await start(); else await stop();
  });

  switchBtn.addEventListener('click', switchCamera);

  // prepara lista de cámaras desde el inicio
  refreshCameras();
</script>
</body>
</html>
