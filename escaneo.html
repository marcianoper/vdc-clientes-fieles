<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>VDC ‚Äî Escanear QR (Mostrador)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e5e7eb}
    header{padding:14px 16px;background:#111827;border-bottom:1px solid rgba(255,255,255,.08);font-weight:900}
    .wrap{max-width:920px;margin:0 auto;padding:14px 16px}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    button,label.btn{width:100%;display:block;text-align:center;padding:12px 14px;border:0;border-radius:14px;font-weight:900;cursor:pointer}
    .btn2{background:#60a5fa;color:#071a2f;margin-top:10px}
    .btn3{background:#f59e0b;color:#1f1300;margin-top:10px}
    .btn4{background:#22c55e;color:#052e16;margin-top:10px}
    .log{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;opacity:.95}
    .ok{color:#22c55e} .bad{color:#fb7185} .muted{opacity:.8;font-size:12px}
    input[type="file"]{display:none}

    /* ‚úÖ Totales bonitos */
    .totals{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:12px;
    }
    .bigTotal{
      background:rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.25);
      border-radius:18px;
      padding:14px;
      text-align:center;
    }
    .bigTotal .t1{opacity:.85;font-weight:900}
    .bigTotal .t2{font-size:44px;line-height:1;margin-top:8px;font-weight:1000;color:#22c55e}
    .bigTotal .t3{opacity:.85;font-weight:900;margin-top:6px}
    .miniGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:720px){ .miniGrid{grid-template-columns:1fr;} }
    .miniCard{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
    }
    .miniCard b{display:block;font-size:12px;opacity:.85}
    .miniCard .val{font-size:20px;font-weight:1000;margin-top:6px}
  </style>
</head>
<body>
<header>VDC ‚Äî Escanear QR (Mostrador)</header>
<div class="wrap">

  <div class="card">
    <div id="reader" style="width:100%"></div>
    <div class="muted" style="margin-top:10px">
      Si el QR del ticket est√° pesado y no lo lee en vivo, usa <b>Subir foto</b> (modo seguro).
    </div>

    <button class="btn2" id="toggle">Iniciar c√°mara</button>
    <button class="btn3" id="switchCam" style="display:none">Cambiar c√°mara</button>

    <label class="btn btn4" for="filePick">üì∏ Subir foto del QR (modo seguro)</label>
    <input id="filePick" type="file" accept="image/*" capture="environment">

    <!-- ‚úÖ Totales -->
    <div class="totals">
      <div class="bigTotal">
        <div class="t1">TOTAL KG DEL TICKET</div>
        <div class="t2" id="totalKg">0.00</div>
        <div class="t3">kg</div>
      </div>

      <div class="miniGrid">
        <div class="miniCard">
          <b># Productos (l√≠neas)</b>
          <div class="val" id="countLines">0</div>
        </div>
        <div class="miniCard">
          <b>Ticket (fingerprint)</b>
          <div class="val" id="fpShort">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <div style="height:12px"></div>

  <div class="card">
    <div class="muted">Resultado:</div>
    <div id="out" class="log">Listo.</div>
  </div>

</div>

<script>
  // === Credenciales ===
  const SUPABASE_URL = "https://eqynjddcosvdqjzztznn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeW5qZGRjb3N2ZHFqenp0em5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMzYwMzIsImV4cCI6MjA3MTcxMjAzMn0.Q51wsGelUvxRfqsMYRY5JduCGyZ7s6AzOhqsRf3kOhk";
  const sb = window.sb || (window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY));

  const out = document.getElementById('out');
  const toggleBtn = document.getElementById('toggle');
  const switchBtn = document.getElementById('switchCam');
  const filePick = document.getElementById('filePick');

  const totalKgEl = document.getElementById('totalKg');
  const countLinesEl = document.getElementById('countLines');
  const fpShortEl = document.getElementById('fpShort');

  let scanner = null;
  let running = false;
  let cameras = [];
  let camIndex = 0;

  // anti spam (aunque tu backend ya est√° blindado)
  let busy = false;
  const BUSY_COOLDOWN_MS = 900;

  // =========================
  // ‚úÖ REGLAS CAJAS COMPLETAS
  // =========================
  const BOX_FULL_KG = 27.22;

  // =========================
  // ‚úÖ CANONIZADOR SKU (CORREGIDO)
  // - PATA MORENA (con espacio) -> PATA_MORENA
  // - CAJA AZUL -> CAJA_MENUDO_NATIONAL
  // - CAJA CANADIAN -> MENUDO_CANADIAN
  // =========================
  function canonSku(productoOriginal){
    let t = String(productoOriginal || "")
      .trim()
      .toUpperCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "");

    // PATA MORENA (espacio / gui√≥n / underscore)
    if(/PATA[\s_-]*MORENA/.test(t)) return "PATA_MORENA";

    // CAJA AZUL (National) (cualquier variante)
    // ej: "CAJA AZUL COMPLETA", "CAJA AZUL X KG"
    if(/^CAJA\s+AZUL\b/.test(t) || t.includes("CAJA AZUL")) return "CAJA_MENUDO_NATIONAL";

    // CAJA CANADIAN
    if(/^CAJA\s+CANADIAN\b/.test(t) || t.includes("CAJA CANADIAN")) return "MENUDO_CANADIAN";

    // (por si alg√∫n d√≠a llega texto con NATIONAL expl√≠cito)
    if(t.includes("NATIONAL")) return "CAJA_MENUDO_NATIONAL";

    // Normaliza espacios -> underscore
    return t.replace(/\s+/g, "_");
  }

  // si es caja completa (1.000) => inventario descuenta 27.22, total visual no la suma
  function applyBoxRules(productoOriginal, qty){
    const name = String(productoOriginal || "").toUpperCase();
    const q = Number(qty);

    const isCajaCompleta =
      name.includes("CAJA") &&
      name.includes("COMPLETA") &&
      Number.isFinite(q) &&
      Math.abs(q - 1) < 1e-9;

    let kgForInv = Number.isFinite(q) ? q : 0;
    let kgForTotal = kgForInv;

    if(isCajaCompleta){
      // Solo National/Canadian completa: el ticket trae 1.000
      // (Washington NO entra aqu√≠ porque trae kg real)
      if(name.includes("AZUL") || name.includes("CANADIAN") || name.includes("NATIONAL")){
        kgForInv = BOX_FULL_KG;  // descuenta 27.22
        kgForTotal = 0;          // ignora en total visual
      }
    }

    return { kgForInv, kgForTotal };
  }

  function log(txt, cls=""){
    out.innerHTML = (cls ? `<span class="${cls}">${txt}</span>` : txt);
  }

  function safeParseJson(text){
    const t = (text||"").trim();
    return JSON.parse(t);
  }

  function hashQr(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return "QR_" + (h >>> 0).toString(16);
  }

  function normalizePayload(raw, decodedText){
    // QR como array
    if(Array.isArray(raw)){
      const itemsUi = raw.map(x => {
        const producto = String(x.producto || x.sku || "").trim();
        const qty = Number(x.cantidad ?? x.kg ?? 0);

        const sku = canonSku(producto);
        const { kgForInv, kgForTotal } = applyBoxRules(producto, qty);

        return { sku, kg: kgForInv, _kgTotal: kgForTotal };
      }).filter(it => it.sku && Number.isFinite(it.kg));

      const itemsForRpc = itemsUi.map(({sku, kg}) => ({ sku, kg }));

      return { qr_id: hashQr(decodedText), items: itemsForRpc, _itemsUi: itemsUi };
    }

    // QR como objeto
    if(raw && typeof raw === "object"){
      let items = raw.items;
      if(!Array.isArray(items) && Array.isArray(raw.productos)) items = raw.productos;

      const itemsUi = (items || []).map(x => {
        const producto = String(x.sku || x.producto || "").trim();
        const qty = Number(x.kg ?? x.cantidad ?? 0);

        const sku = canonSku(producto);
        const { kgForInv, kgForTotal } = applyBoxRules(producto, qty);

        return { sku, kg: kgForInv, _kgTotal: kgForTotal };
      }).filter(it => it.sku && Number.isFinite(it.kg));

      const itemsForRpc = itemsUi.map(({sku, kg}) => ({ sku, kg }));

      return { qr_id: String(raw.qr_id || hashQr(decodedText)), items: itemsForRpc, _itemsUi: itemsUi };
    }
    return null;
  }

  // ‚úÖ suma de kilos total (usa _kgTotal para ignorar cajas completas con 1.000)
  function calcTotalKg(itemsUi){
    let sum = 0;
    for(const it of (itemsUi||[])){
      const k = Number(it._kgTotal ?? it.kg);
      if(Number.isFinite(k)) sum += k;
    }
    return sum;
  }

  function updateTotalsUI(payload, fingerprint){
    const itemsUi = payload._itemsUi || payload.items || [];
    const totalKg = calcTotalKg(itemsUi);

    totalKgEl.textContent = totalKg.toFixed(2);
    countLinesEl.textContent = String((payload.items || []).length || 0);
    fpShortEl.textContent = fingerprint ? fingerprint.slice(0, 10) : "‚Äî";
  }

  async function procesar(payload, fingerprint){
    log("Procesando venta‚Ä¶");

    const { data, error } = await sb.rpc('procesar_venta_qr', {
      payload: { qr_id: payload.qr_id, items: payload.items },
      p_fingerprint: fingerprint
    });

    if(error){
      log("ERROR RPC: " + error.message, "bad");
      return;
    }

    if(data?.code === 'DUPLICATE'){
      log("Ticket ya procesado (DUPLICATE). No se descont√≥ otra vez ‚úÖ", "ok");
      return;
    }

    if(!data?.ok){
      log("NO OK:\n" + JSON.stringify(data, null, 2), "bad");
      return;
    }

    log("‚úÖ Venta aplicada.\n\n" + JSON.stringify(data, null, 2), "ok");
  }

  async function handleDecoded(decodedText){
    if(busy) return;
    busy = true;

    try{
      const raw = safeParseJson(decodedText);
      const payload = normalizePayload(raw, decodedText);

      if(!payload?.items?.length){
        log("QR inv√°lido: no pude formar items\n\n" + decodedText, "bad");
        return;
      }

      const fingerprint = hashQr(decodedText);

      // ‚úÖ Mostrar total inmediatamente al escanear
      updateTotalsUI(payload, fingerprint);

      // ‚úÖ Procesar venta
      await procesar(payload, fingerprint);

    }catch(e){
      log("No pude leer JSON del QR.\n\n" + e.message + "\n\nContenido:\n" + decodedText, "bad");
    }finally{
      setTimeout(()=> busy = false, BUSY_COOLDOWN_MS);
    }
  }

  async function onScanSuccess(decodedText){
    await handleDecoded(decodedText);
  }

  async function refreshCameras(){
    cameras = await Html5Qrcode.getCameras();
    if(!Array.isArray(cameras)) cameras = [];
    switchBtn.style.display = (cameras.length >= 2) ? "block" : "none";

    const idxBack = cameras.findIndex(c => /back|rear|environment|trasera/i.test(c.label || ""));
    if(idxBack >= 0) camIndex = idxBack;
  }

  async function startWithCurrentCamera(){
    if(!scanner) scanner = new Html5Qrcode("reader");
    if(!cameras.length) await refreshCameras();

    running = true;
    toggleBtn.textContent = "Detener c√°mara";

    const config = {
      fps: 15,
      qrbox: (vw, vh) => {
        const size = Math.min(vw, vh) * 0.78;
        return { width: Math.floor(size), height: Math.floor(size) };
      },
      disableFlip: true,
      experimentalFeatures: { useBarCodeDetectorIfSupported: true }
    };

    const constraints = cameras.length
      ? { deviceId: { exact: cameras[camIndex].id } }
      : { facingMode: { ideal: "environment" }, width:{ ideal:1920 }, height:{ ideal:1080 } };

    try{
      await scanner.start(constraints, config, onScanSuccess);
      log("C√°mara lista. Escanea un ticket. (Total KG se muestra arriba)");
    }catch(e){
      running = false;
      toggleBtn.textContent = "Iniciar c√°mara";
      log("No pude iniciar c√°mara. Revisa permisos y HTTPS.", "bad");
    }
  }

  async function start(){
    if(running) return;
    await refreshCameras();
    await startWithCurrentCamera();
  }

  async function stop(){
    if(!running) return;
    running = false;
    toggleBtn.textContent = "Iniciar c√°mara";
    try{ await scanner.stop(); }catch(e){}
    log("C√°mara detenida.");
  }

  async function switchCamera(){
    if(cameras.length < 2){
      log("Solo hay 1 c√°mara disponible.", "bad");
      return;
    }
    camIndex = (camIndex + 1) % cameras.length;
    const name = cameras[camIndex]?.label || `C√°mara ${camIndex+1}`;
    log("Cambiando a: " + name + "‚Ä¶");
    if(running){ await stop(); await start(); }
  }

  // ‚úÖ MODO FOTO (muy confiable)
  filePick.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      if(!scanner) scanner = new Html5Qrcode("reader");
      log("Leyendo foto‚Ä¶ (modo seguro)");
      const decodedText = await scanner.scanFile(file, true);
      await handleDecoded(decodedText);
    }catch(err){
      console.error(err);
      log("No pude leer la foto. Tip: m√°s cerca, sin reflejo y el QR grande.", "bad");
    }finally{
      filePick.value = "";
    }
  });

  toggleBtn.addEventListener('click', async ()=>{
    if(!running) await start(); else await stop();
  });

  switchBtn.addEventListener('click', switchCamera);

  refreshCameras();
</script>
</body>
</html>
