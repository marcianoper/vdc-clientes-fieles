<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VDC360° — Clientes Fieles (QR + Puntos + Tickets)</title>

  <style>
    :root{--brand:#0a7a3b;--bg:#f6f7f8;--card:#fff;--ink:#111;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
    header{background:var(--brand);color:#fff;padding:14px 18px}
    header h1{margin:0;font-size:18px}
    main{max-width:980px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    label{display:block;font-weight:800;margin-top:10px}
    input,select,button,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #d1d5db;font-size:16px}
    textarea{min-height:140px;resize:vertical}
    button{background:var(--brand);color:#fff;border:none;font-weight:900;cursor:pointer;margin-top:12px}
    button.secondary{background:#111}
    button.ghost{background:#fff;color:#111;border:1px solid #d1d5db}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{display:inline-block;background:#eef7ef;border:1px solid #cfe9d1;color:#1f6f26;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px}
    .muted{color:var(--muted)}
    #qrBox{display:grid;place-items:center;padding:12px;border:1px dashed #d1d5db;border-radius:12px;min-height:240px}
    code{background:#f1f5f9;padding:2px 6px;border-radius:8px}
    .err{background:#fff1f2;border:1px solid #fecdd3;color:#b91c1c;padding:10px;border-radius:12px;white-space:pre-wrap}
    .ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:10px;border-radius:12px;white-space:pre-wrap}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}
    th{background:#f9fafb}
    .mini{font-size:12px;color:var(--muted)}
    .right{text-align:right}

    /* Cámara / OCR */
    .camWrap{display:grid;gap:10px;margin-top:10px}
    video{width:100%;border-radius:12px;border:1px solid #e5e7eb;background:#000;max-height:360px}
    canvas{display:none}
    .progressBar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .progressBar > div{height:100%;width:0%;background:var(--brand)}
  </style>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <!-- OCR (Tesseract.js) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body>
<header>
  <h1>VDC360° — Clientes Fieles (QR + Puntos + Tickets)</h1>
</header>

<main>

  <section class="card">
    <h2 style="margin:0 0 6px">1) Buscar / Crear cliente (solo teléfono)</h2>
    <div class="grid">
      <div>
        <label>Teléfono (10 dígitos)</label>
        <input id="tel" inputmode="numeric" placeholder="Ej. 4621234567" />
        <div class="muted" style="margin-top:6px">Tip: puedes pegar con espacios, yo lo limpio.</div>
      </div>
      <div>
        <label>Nombre (opcional)</label>
        <input id="nombre" placeholder="Ej. Taquería Don Chuy" />
      </div>
    </div>

    <div class="row">
      <button id="btnBuscar">Buscar cliente</button>
      <button id="btnCrear" class="secondary">Crear / Actualizar</button>
    </div>

    <div id="msg" class="muted" style="margin-top:10px"></div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">2) QR del cliente</h2>
    <p class="muted" style="margin-top:0">El QR contiene una URL del sitio con <code>?cid=</code> para cargar al cliente automáticamente.</p>

    <div id="qrBox"><span class="muted">Aquí aparecerá el QR</span></div>
    <div class="muted" id="qrText" style="margin-top:10px"></div>

    <div class="row" style="margin-top:10px">
      <span class="pill" id="stCliente">Cliente: —</span>
      <span class="pill" id="stPuntos">Puntos: —</span>
      <span class="pill" id="stSaldo">Saldo kg: —</span>
    </div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">3) Capturar compra por Ticket</h2>
    <p class="muted" style="margin-top:0">
      Puedes pegar el texto (opción 1), o <b>escanear aquí mismo</b> con cámara (OCR).
      Tip: buena luz + ticket derecho = mejor lectura.
    </p>

    <div class="row">
      <button id="btnStartCam" class="ghost">Escanear con cámara (OCR)</button>
      <button id="btnStopCam" class="ghost" disabled>Apagar cámara</button>
      <label class="ghost" style="display:block;margin-top:12px;padding:10px;border-radius:10px;border:1px solid #d1d5db;cursor:pointer">
        Subir foto (alternativa)
        <input id="fileTicket" type="file" accept="image/*" capture="environment" style="display:none" />
      </label>
    </div>

    <div class="camWrap" id="camWrap" style="display:none">
      <video id="video" playsinline></video>
      <canvas id="canvas"></canvas>
      <div class="row">
        <button id="btnSnap" class="ghost">Tomar foto y leer</button>
      </div>
      <div class="mini" id="ocrStatus">—</div>
      <div class="progressBar"><div id="ocrBar"></div></div>
    </div>

    <label>Texto del ticket (pegado / OCR)</label>
    <textarea id="ticketText" placeholder="Pega aquí el texto del ticket..."></textarea>

    <div class="row">
      <button id="btnProcesar" class="ghost">Procesar ticket</button>
      <button id="btnLimpiar" class="ghost">Limpiar</button>
    </div>

    <div class="grid" style="margin-top:10px">
      <div>
        <label>Total kg detectado</label>
        <input id="kgAuto" inputmode="decimal" placeholder="0.00" />
        <div class="mini">Se llena automático; puedes editar si hace falta.</div>
      </div>
      <div>
        <label>Tipo de venta</label>
        <select id="tipo">
          <option value="mostrador">mostrador (SÍ puntos)</option>
          <option value="credito">crédito (NO puntos)</option>
        </select>
        <div class="mini">Para puntos: solo mostrador.</div>
      </div>
    </div>

    <div id="detalleBox" class="muted" style="margin-top:10px">—</div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">4) Guardar venta (guarda encabezado + detalle)</h2>
    <button id="btnGuardar">Guardar venta desde ticket</button>
    <div id="log" class="muted" style="margin-top:10px"></div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">Diagnóstico</h2>
    <div id="diag" class="muted">—</div>
  </section>

</main>

<script>
  /* ===== CONFIG (tus credenciales) ===== */
  const SUPABASE_URL = "https://eqynjddcosvdqjzztznn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeW5qZGRjb3N2ZHFqenp0em5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMzYwMzIsImV4cCI6MjA3MTcxMjAzMn0.Q51wsGelUvxRfqsMYRY5JduCGyZ7s6AzOhqsRf3kOhk";

  const sb = (window.supabase && window.supabase.createClient)
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    : null;

  /* ===== TABLAS ===== */
  const T_CLIENTES = "clientes";
  const T_VENTAS   = "ventas";
  const T_ITEMS    = "ventas_items"; // tabla detalle (crear en Supabase)

  /* ===== Estado ===== */
  let currentClient = null;
  let ticketItems = []; // [{producto, kg}]
  let camStream = null;

  /* ===== Helpers ===== */
  const $ = (id)=>document.getElementById(id);

  function setMsg(type, text){
    const el = $("msg");
    if(!el) return;
    el.className = type === "err" ? "err" : (type==="ok" ? "ok" : "muted");
    el.textContent = text;
  }

  function setLog(type, text){
    const el = $("log");
    if(!el) return;
    el.className = type === "err" ? "err" : (type==="ok" ? "ok" : "muted");
    el.textContent = text;
  }

  function cleanPhone(s){
    return String(s || "").replace(/\D/g, "").slice(-10);
  }

  function renderStatus(){
    $("stCliente").textContent = "Cliente: " + (currentClient ? (currentClient.nombre || currentClient.telefono) : "—");
    $("stPuntos").textContent  = "Puntos: " + (currentClient ? currentClient.puntos : "—");
    $("stSaldo").textContent   = "Saldo kg: " + (currentClient ? Number(currentClient.saldo_kg).toFixed(3) : "—");
  }

  function siteBaseUrl(){
    const u = new URL(window.location.href);
    return u.origin + u.pathname.replace(/index\.html$/,'');
  }

  async function renderQR(){
    const box = $("qrBox");
    box.innerHTML = "";
    $("qrText").textContent = "";

    if(!currentClient){
      box.innerHTML = '<span class="muted">Primero crea/selecciona un cliente</span>';
      return;
    }

    const payload = `${siteBaseUrl()}?cid=${currentClient.id}`;
    const img = document.createElement("img");
    img.alt = "QR del cliente";
    img.style.width = "240px";
    img.style.height = "240px";
    img.src = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(payload)}`;
    box.appendChild(img);
    $("qrText").innerHTML = `URL en QR: <code>${payload}</code>`;
  }

  function formatErr(err){
    if(!err) return "Error desconocido";
    if(typeof err === "string") return err;
    if(err.message) return err.message;
    if(err.error_description) return err.error_description;
    try { return JSON.stringify(err, null, 2); } catch { return String(err); }
  }

  function toNum(s){
    const v = Number(String(s ?? "").replace(",", ".").trim());
    return Number.isFinite(v) ? v : NaN;
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function normalizeProductName(s){
    return String(s || "")
      .replace(/\s+/g, " ")
      .replace(/[•·]/g, " ")
      .trim();
  }

  /* ===== PARSER (soporta: con 'kg' y tu POS Cantidad/P.U/Importe) ===== */
  function parseTicketText(raw){
    const text = String(raw || "").replace(/\r/g, "");
    const lines = text.split("\n").map(l=>l.trim()).filter(Boolean);

    // Reglas de "cajas" a kg fijo (ajusta si aplica)
    const FIXED_KG = [
      { match: /CAJA\s+CANADIAN/i, kg_per_unit: 27.22 },
      { match: /CAJA\s+MENUDO\s+NATIONAL/i, kg_per_unit: 27.22 },
      { match: /CAJA\s+WASHINGTON/i, kg_per_unit: 27.22 },
    ];

    const isNumericCode = (s)=>/^\d{6,}$/.test(String(s||"").replace(/\s/g,""));
    const parseMoneyOrQty = (s)=>{
      const v = Number(String(s).replace(/,/g,"").trim());
      return Number.isFinite(v) ? v : NaN;
    };

    // A) Si un día tu ticket trae "kg"
    const itemsKgText = [];
    const kgRegex = /(\d+(?:[.,]\d{1,3})?)\s*(kg|kgr|kilo|kilos)\b/i;
    for(const line of lines){
      const m = line.match(kgRegex);
      if(!m) continue;
      const kg = Number(String(m[1]).replace(",", "."));
      if(!Number.isFinite(kg) || kg<=0) continue;
      let producto = line.replace(kgRegex, " ").replace(/[:\-]+$/g, "").trim();
      if(/\btotal\b/i.test(producto) && producto.length <= 12) continue;
      if(producto) itemsKgText.push({ producto, kg });
    }
    if(itemsKgText.length){
      const map = new Map();
      for(const it of itemsKgText){
        const key = it.producto.toLowerCase();
        map.set(key, (map.get(key)||0) + it.kg);
      }
      return [...map.entries()].map(([k,kg])=>({
        producto: k.charAt(0).toUpperCase()+k.slice(1),
        kg: Number(kg)
      })).sort((a,b)=>b.kg-a.kg);
    }

    // B) Formato POS como tu foto:
    // PRODUCTO
    // CODIGO
    // CANTIDAD  PU  IMPORTE
    const rawItems = [];
    for(let i=0;i<lines.length;i++){
      const productoLine = lines[i];
      const codeLine = lines[i+1] || "";
      const numsLine = lines[i+2] || "";

      if(isNumericCode(codeLine)){
        const parts = numsLine.split(/\s+/).filter(Boolean);
        const nums = parts.map(parseMoneyOrQty).filter(n=>Number.isFinite(n));
        if(nums.length >= 3){
          const cantidad = nums[0];
          if(Number.isFinite(cantidad) && cantidad > 0){
            rawItems.push({ producto: productoLine, cantidad });
            i = i + 2;
          }
        }
      }
    }

    // Convertir cantidad->kg
    const out = [];
    for(const it of rawItems){
      let producto = normalizeProductName(it.producto);
      let kg = null;

      const fixed = FIXED_KG.find(r=>r.match.test(producto));
      if(fixed){
        kg = it.cantidad * fixed.kg_per_unit;
      }else{
        if(/^CAJA\b/i.test(producto)) continue; // si no sabemos kg por caja, no inventamos
        kg = it.cantidad; // para BOFE/LIBRO/PATA... la cantidad es kg
      }

      if(Number.isFinite(kg) && kg > 0){
        out.push({ producto, kg: Number(kg) });
      }
    }

    // agrupar por producto
    const map = new Map();
    for(const it of out){
      const key = it.producto.toLowerCase();
      map.set(key, (map.get(key)||0) + it.kg);
    }
    return [...map.entries()].map(([k,kg])=>({
      producto: k.charAt(0).toUpperCase()+k.slice(1),
      kg: Number(kg)
    })).sort((a,b)=>b.kg-a.kg);
  }

  function calcTotalKg(items){
    return items.reduce((acc,it)=>acc + (Number(it.kg)||0), 0);
  }

  function renderDetalleEditable(){
    const box = $("detalleBox");
    if(!ticketItems.length){
      box.className = "muted";
      box.textContent = "—";
      return;
    }

    const rows = ticketItems.map((it, idx)=>`
      <tr>
        <td style="width:65%">
          <input data-idx="${idx}" data-field="producto" value="${escapeHtml(it.producto)}" />
        </td>
        <td style="width:25%">
          <input data-idx="${idx}" data-field="kg" inputmode="decimal" value="${Number(it.kg).toFixed(3)}" />
        </td>
        <td class="right" style="width:10%">
          <button class="ghost" data-del="${idx}" style="margin:0;padding:8px;border-radius:10px">X</button>
        </td>
      </tr>
    `).join("");

    box.className = "";
    box.innerHTML = `
      <div class="mini">Puedes corregir nombres y kilos antes de guardar.</div>
      <table>
        <thead>
          <tr><th>Producto</th><th>Kg</th><th class="right">Del</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="row" style="margin-top:10px">
        <button id="btnAgregarLinea" class="ghost">+ Agregar línea</button>
      </div>
    `;

    box.querySelectorAll('input[data-idx]').forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const idx = Number(inp.getAttribute("data-idx"));
        const field = inp.getAttribute("data-field");
        if(!ticketItems[idx]) return;

        if(field === "kg"){
          const v = toNum(inp.value);
          ticketItems[idx].kg = Number.isFinite(v) ? v : 0;
        }else{
          ticketItems[idx].producto = normalizeProductName(inp.value);
        }
        $("kgAuto").value = calcTotalKg(ticketItems).toFixed(2);
      });
    });

    box.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const idx = Number(btn.getAttribute("data-del"));
        ticketItems.splice(idx, 1);
        $("kgAuto").value = calcTotalKg(ticketItems).toFixed(2);
        renderDetalleEditable();
      });
    });

    const addBtn = $("btnAgregarLinea");
    if(addBtn){
      addBtn.addEventListener("click", ()=>{
        ticketItems.push({ producto:"Producto", kg:0 });
        renderDetalleEditable();
      });
    }
  }

  /* ===== Acciones Cliente ===== */
  async function buscarClientePorTelefono(){
    if(!sb) throw new Error("Supabase no cargó. Revisa internet o CDN.");

    const tel = cleanPhone($("tel").value);
    if(tel.length !== 10) throw new Error("Teléfono inválido (deben ser 10 dígitos).");

    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .eq("telefono", tel)
      .maybeSingle();

    if(error) throw error;

    currentClient = data || null;
    renderStatus();
    await renderQR();

    setMsg(data ? "ok" : "muted", data ? "Cliente encontrado." : "No existe: crea el cliente.");
  }

  async function crearOActualizarCliente(){
    if(!sb) throw new Error("Supabase no cargó. Revisa internet o CDN.");

    const tel = cleanPhone($("tel").value);
    const nombre = ($("nombre").value || "").trim() || null;
    if(tel.length !== 10) throw new Error("Teléfono inválido (deben ser 10 dígitos).");

    const payload = { telefono: tel };
    if(nombre) payload.nombre = nombre;

    const { data, error } = await sb
      .from(T_CLIENTES)
      .upsert(payload, { onConflict: "telefono" })
      .select("id,telefono,nombre,puntos,saldo_kg")
      .single();

    if(error) throw error;

    currentClient = data;
    renderStatus();
    await renderQR();

    setMsg("ok", "Cliente creado/actualizado y QR generado.");
  }

  /* ===== Procesar ticket ===== */
  function procesarTicket(){
    const raw = $("ticketText").value || "";
    const items = parseTicketText(raw);

    ticketItems = items;
    const total = calcTotalKg(ticketItems);

    $("kgAuto").value = Number.isFinite(total) ? total.toFixed(2) : "";
    renderDetalleEditable();

    if(!items.length){
      setLog("err", "No pude detectar productos. Tip: pega texto completo o escanea con buena luz.");
    }else{
      setLog("ok", `Ticket procesado. Líneas detectadas: ${items.length}. Total kg: ${total.toFixed(2)}.`);
    }
  }

  function limpiarTicket(){
    $("ticketText").value = "";
    $("kgAuto").value = "";
    ticketItems = [];
    renderDetalleEditable();
    setLog("muted","Listo.");
  }

  /* ===== Guardar venta + detalle + puntos ===== */
  async function guardarVentaDesdeTicket(){
    if(!sb) throw new Error("Supabase no cargó. Revisa internet o CDN.");
    if(!currentClient) throw new Error("Primero crea/selecciona un cliente.");

    const tipo = $("tipo").value;
    const rawTicket = ($("ticketText").value || "").trim();

    const kg = toNum($("kgAuto").value);
    if(!Number.isFinite(kg) || kg <= 0) throw new Error("Total kg inválido.");

    const items = (ticketItems || [])
      .map(it=>({ producto: normalizeProductName(it.producto), kg: Number(it.kg) }))
      .filter(it=>it.producto && Number.isFinite(it.kg) && it.kg > 0);

    const ventaInsert = {
      tipo,
      cliente_id: currentClient.id,
      total_kg: kg,
      puntos_otorgados: 0,
      raw_ticket: rawTicket || null,
      captura: "ticket_ocr"
    };

    const { data: venta, error: e1 } = await sb
      .from(T_VENTAS)
      .insert(ventaInsert)
      .select("id,tipo,total_kg,puntos_otorgados")
      .single();

    if(e1) throw e1;

    if(items.length){
      const payloadItems = items.map(it=>({
        venta_id: venta.id,
        producto: it.producto,
        kg: it.kg
      }));

      const { error: e2 } = await sb
        .from(T_ITEMS)
        .insert(payloadItems);

      if(e2) throw e2;
    }

    let puntosGanados = 0;
    let nuevoSaldo = Number(currentClient.saldo_kg);

    if(tipo === "mostrador"){
      const acumulado = Number(currentClient.saldo_kg) + kg;
      puntosGanados = Math.floor(acumulado / 100);
      nuevoSaldo = acumulado % 100;

      const { data: cli2, error: e3 } = await sb
        .from(T_CLIENTES)
        .update({
          puntos: currentClient.puntos + puntosGanados,
          saldo_kg: nuevoSaldo
        })
        .eq("id", currentClient.id)
        .select("id,telefono,nombre,puntos,saldo_kg")
        .single();

      if(e3) throw e3;
      currentClient = cli2;

      const { error: e4 } = await sb
        .from(T_VENTAS)
        .update({ puntos_otorgados: puntosGanados })
        .eq("id", venta.id);

      if(e4) throw e4;
    }

    renderStatus();
    setLog("ok",
      `✅ Venta guardada.
Cliente: ${currentClient.nombre || currentClient.telefono}
Tipo: ${tipo}
Total kg: ${kg.toFixed(2)}
Puntos ganados: ${puntosGanados}
Items guardados: ${items.length}
Venta ID: ${venta.id}`
    );

    limpiarTicket();
  }

  /* ===== OCR ===== */
  function setOcrUI(status, progress){
    $("ocrStatus").textContent = status || "—";
    const p = Math.max(0, Math.min(1, Number(progress||0)));
    $("ocrBar").style.width = (p*100).toFixed(0) + "%";
  }

  async function runOCRFromCanvas(){
    if(typeof Tesseract === "undefined") throw new Error("OCR no cargó (Tesseract). Revisa internet/CDN.");

    setOcrUI("Leyendo ticket... (OCR)", 0.02);
    const canvas = $("canvas");

    const { data: { text } } = await Tesseract.recognize(
      canvas,
      "spa",
      {
        logger: (m)=>{
          if(m && m.status){
            const prog = (typeof m.progress === "number") ? m.progress : 0;
            setOcrUI(`OCR: ${m.status} ${(prog*100).toFixed(0)}%`, prog);
          }
        }
      }
    );

    const cleaned = (text || "")
      .replace(/\r/g, "")
      .replace(/[ \t]+\n/g, "\n")
      .trim();

    $("ticketText").value = cleaned;
    setOcrUI("OCR terminado ✅ (revisa el texto y luego Procesar ticket)", 1);
    setLog("ok", "OCR listo. Ahora dale a “Procesar ticket”.");
  }

  async function runOCRFromFile(file){
    const img = await fileToImage(file);
    drawToCanvas(img);
    await runOCRFromCanvas();
  }

  function fileToImage(file){
    return new Promise((resolve,reject)=>{
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = ()=>{ URL.revokeObjectURL(url); resolve(img); };
      img.onerror = (e)=>{ URL.revokeObjectURL(url); reject(e); };
      img.src = url;
    });
  }

  function drawToCanvas(img){
    const canvas = $("canvas");
    const ctx = canvas.getContext("2d");

    // escala para mejorar OCR (no demasiado grande)
    const maxW = 1400;
    const scale = Math.min(1, maxW / img.width);
    const w = Math.round(img.width * scale);
    const h = Math.round(img.height * scale);

    canvas.width = w;
    canvas.height = h;
    ctx.drawImage(img, 0, 0, w, h);
  }

  async function startCamera(){
    // Requiere HTTPS en el celular (GitHub Pages / Vercel ok)
    if(!navigator.mediaDevices?.getUserMedia) throw new Error("Este navegador no soporta cámara por web.");

    $("camWrap").style.display = "grid";
    $("btnStartCam").disabled = true;
    $("btnStopCam").disabled = false;

    const video = $("video");
    camStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } },
      audio: false
    });
    video.srcObject = camStream;
    await video.play();
    setOcrUI("Cámara lista. Pon el ticket centrado y toma la foto.", 0);
  }

  function stopCamera(){
    try{
      if(camStream){
        camStream.getTracks().forEach(t=>t.stop());
        camStream = null;
      }
    }catch(_){}
    $("video").srcObject = null;
    $("camWrap").style.display = "none";
    $("btnStartCam").disabled = false;
    $("btnStopCam").disabled = true;
    setOcrUI("—", 0);
  }

  function snapToCanvas(){
    const video = $("video");
    const canvas = $("canvas");
    const ctx = canvas.getContext("2d");

    // toma frame del video
    const w = video.videoWidth || 1280;
    const h = video.videoHeight || 720;

    // reduce tamaño para OCR
    const maxW = 1400;
    const scale = Math.min(1, maxW / w);
    canvas.width = Math.round(w * scale);
    canvas.height = Math.round(h * scale);
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  }

  /* ===== Arranque + Diagnóstico ===== */
  function diag(){
    const d = [];
    d.push("Supabase cargado: " + (!!sb));
    d.push("QRCode cargado: " + (typeof QRCode !== "undefined"));
    d.push("OCR cargado: " + (typeof Tesseract !== "undefined"));
    d.push("Base URL del sitio: " + siteBaseUrl());
    d.push("HTTPS recomendado para cámara.");
    $("diag").textContent = d.join("\n");
  }

  async function cargarClientePorQuery(){
    const u = new URL(window.location.href);
    const cid = u.searchParams.get("cid");
    if(!cid || !sb) return;

    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .eq("id", cid)
      .maybeSingle();

    if(error){
      console.error(error);
      setMsg("err", "Error cargando cliente por QR: " + formatErr(error));
      return;
    }
    if(!data){
      setMsg("err", "Este QR no encontró cliente (cid no existe).");
      return;
    }
    currentClient = data;
    renderStatus();
    await renderQR();
    setMsg("ok", "Cliente cargado desde QR.");
  }

  /* ===== Listeners ===== */
  $("btnBuscar").addEventListener("click", async ()=>{
    setMsg("muted","Buscando...");
    try{ await buscarClientePorTelefono(); }
    catch(err){ console.error(err); setMsg("err", formatErr(err)); }
  });

  $("btnCrear").addEventListener("click", async ()=>{
    setMsg("muted","Guardando...");
    try{ await crearOActualizarCliente(); }
    catch(err){ console.error(err); setMsg("err", formatErr(err)); }
  });

  $("btnProcesar").addEventListener("click", ()=>{
    try{ procesarTicket(); }
    catch(err){ console.error(err); setLog("err", formatErr(err)); }
  });

  $("btnLimpiar").addEventListener("click", ()=>{
    limpiarTicket();
  });

  $("btnGuardar").addEventListener("click", async ()=>{
    setLog("muted","Guardando venta...");
    try{ await guardarVentaDesdeTicket(); }
    catch(err){ console.error(err); setLog("err", formatErr(err)); }
  });

  $("btnStartCam").addEventListener("click", async ()=>{
    try{ await startCamera(); }
    catch(err){ console.error(err); setLog("err", "No pude abrir cámara: " + formatErr(err)); stopCamera(); }
  });

  $("btnStopCam").addEventListener("click", ()=>{
    stopCamera();
  });

  $("btnSnap").addEventListener("click", async ()=>{
    try{
      if(!camStream) throw new Error("Cámara no está encendida.");
      setLog("muted","Tomando foto...");
      snapToCanvas();
      await runOCRFromCanvas();
    }catch(err){
      console.error(err);
      setLog("err", "OCR falló: " + formatErr(err));
    }
  });

  $("fileTicket").addEventListener("change", async (e)=>{
    try{
      const f = e.target.files?.[0];
      if(!f) return;
      setLog("muted","Leyendo foto (OCR)...");
      await runOCRFromFile(f);
    }catch(err){
      console.error(err);
      setLog("err", "OCR falló: " + formatErr(err));
    }finally{
      e.target.value = "";
    }
  });

  // seguridad: apagar cámara si cierras/pierdes foco
  window.addEventListener("beforeunload", stopCamera);
  document.addEventListener("visibilitychange", ()=>{
    if(document.hidden) stopCamera();
  });

  diag();
  renderStatus();
  renderDetalleEditable();
  cargarClientePorQuery();
</script>
</body>
</html>
