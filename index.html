<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VDC360° — Clientes Fieles (Puntos + Tickets)</title>

  <style>
    :root{--brand:#0a7a3b;--bg:#f6f7f8;--card:#fff;--ink:#111;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
    header{background:var(--brand);color:#fff;padding:14px 18px}
    header h1{margin:0;font-size:18px}
    main{max-width:980px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    label{display:block;font-weight:800;margin-top:10px}
    input,select,button,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #d1d5db;font-size:16px}
    textarea{min-height:140px;resize:vertical}
    button{background:var(--brand);color:#fff;border:none;font-weight:900;cursor:pointer;margin-top:12px}
    button.secondary{background:#111}
    button.ghost{background:#fff;color:#111;border:1px solid #d1d5db}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{display:inline-block;background:#eef7ef;border:1px solid #cfe9d1;color:#1f6f26;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px}
    .muted{color:var(--muted)}
    code{background:#f1f5f9;padding:2px 6px;border-radius:8px}
    .err{background:#fff1f2;border:1px solid #fecdd3;color:#b91c1c;padding:10px;border-radius:12px;white-space:pre-wrap}
    .ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:10px;border-radius:12px;white-space:pre-wrap}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}
    th{background:#f9fafb}
    .mini{font-size:12px;color:var(--muted)}
    .right{text-align:right}

    /* Cámara / OCR */
    .camWrap{display:grid;gap:10px;margin-top:10px}
    video{width:100%;border-radius:12px;border:1px solid #e5e7eb;background:#000;max-height:360px}
    canvas{display:none}
    .progressBar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .progressBar > div{height:100%;width:0%;background:var(--brand)}
  </style>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body>
<header>
  <h1>VDC360° — Clientes Fieles (Puntos + Tickets)</h1>
</header>

<main>

  <section class="card">
    <h2 style="margin:0 0 6px">1) Buscar / Crear cliente (solo teléfono)</h2>

    <div class="grid">
      <div>
        <label>Teléfono (10 dígitos)</label>

        <!-- ✅ AUTOCOMPLETE con teléfonos guardados -->
        <input id="tel" list="telList" inputmode="numeric" placeholder="Ej. 4621234567" autocomplete="off" />
        <datalist id="telList"></datalist>

        <div class="muted" style="margin-top:6px">Tip: pica el campo y te mostrará teléfonos guardados. Puedes escribir y te filtra.</div>
      </div>

      <div>
        <label>Nombre (opcional)</label>
        <input id="nombre" placeholder="Ej. Taquería Don Chuy" />
        <div class="mini">Se llena automático si seleccionas un teléfono existente.</div>
      </div>
    </div>

    <div class="row">
      <button id="btnBuscar">Buscar cliente</button>
      <button id="btnCrear" class="secondary">Crear / Actualizar</button>
      <button id="btnRecargar" class="ghost" style="width:auto">↻ Recargar teléfonos</button>
    </div>

    <div class="row" style="margin-top:10px">
      <span class="pill" id="stCliente">Cliente: —</span>
      <span class="pill" id="stPuntos">Puntos: —</span>
      <span class="pill" id="stSaldo">Saldo kg: —</span>
    </div>

    <div id="msg" class="muted" style="margin-top:10px"></div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">2) Capturar compra por Ticket (OCR)</h2>

    <div class="row">
      <button id="btnStartCam" class="ghost">Escanear con cámara</button>
      <button id="btnStopCam" class="ghost" disabled>Apagar cámara</button>
      <label class="ghost" style="display:block;margin-top:12px;padding:10px;border-radius:10px;border:1px solid #d1d5db;cursor:pointer">
        Subir foto
        <input id="fileTicket" type="file" accept="image/*" capture="environment" style="display:none" />
      </label>
    </div>

    <div class="camWrap" id="camWrap" style="display:none">
      <video id="video" playsinline></video>
      <canvas id="canvas"></canvas>
      <div class="row">
        <button id="btnSnap" class="ghost">Tomar foto y leer</button>
      </div>
      <div class="mini" id="ocrStatus">—</div>
      <div class="progressBar"><div id="ocrBar"></div></div>
    </div>

    <label>Texto del ticket (vista filtrada)</label>
    <textarea id="ticketText" placeholder="Aquí verás números chicos. El OCR completo se guarda atrás para detectar productos + kg."></textarea>

    <div class="row">
      <button id="btnProcesar" class="ghost">Procesar ticket</button>
      <button id="btnLimpiar" class="ghost">Limpiar</button>
    </div>

    <div class="grid" style="margin-top:10px">
      <div>
        <label>Total kg detectado</label>
        <input id="kgAuto" inputmode="decimal" placeholder="0.00" />
      </div>
      <div>
        <label>Tipo de venta</label>
        <select id="tipo">
          <option value="mostrador">mostrador (SÍ puntos)</option>
          <option value="credito">crédito (NO puntos)</option>
        </select>
      </div>
    </div>

    <div id="detalleBox" class="muted" style="margin-top:10px">—</div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">3) Guardar venta</h2>
    <button id="btnGuardar">Guardar venta desde ticket</button>
    <div id="log" class="muted" style="margin-top:10px"></div>
  </section>

</main>

<script>
  /* ===== CONFIG ===== */
  const SUPABASE_URL = "https://eqynjddcosvdqjzztznn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeW5qZGRjb3N2ZHFqenp0em5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMzYwMzIsImV4cCI6MjA3MTcxMjAzMn0.Q51wsGelUvxRfqsMYRY5JduCGyZ7s6AzOhqsRf3kOhk";

  const sb = (window.supabase && window.supabase.createClient)
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    : null;

  const T_CLIENTES = "clientes";
  const T_VENTAS   = "ventas";
  const T_ITEMS    = "ventas_items";

  let currentClient = null;
  let ticketItems = [];
  let camStream = null;
  let rawOcrText = "";

  /* ===== Productos ===== */
  const PRODUCT_CATALOG = [
    { key: "Panza", aliases: [/^PANZA\b/i] },
    { key: "Higado", aliases: [/^HIGADO\b/i] },
    { key: "Libro", aliases: [/^LIBRO\b/i] },
    { key: "Corazon", aliases: [/^CORAZON\b/i] },
    { key: "Tripa", aliases: [/^TRIPA\b/i] },
    { key: "Bofe", aliases: [/^BOFE\b/i] },
    { key: "Cabeza", aliases: [/^CABEZA\b/i, /^CABEZA\s+DE\s+RES\b/i, /^CABEZA\s+DE\s+RASTRO\b/i, /^CABEZA\s+RASTRO\b/i] },
    { key: "Pata Blanca", aliases: [/^PATA\s*BLANCA\b/i] },
    { key: "Pata Morena", aliases: [/^PATA\s*MORENA\b/i, /^PATAS\s*MORENA\b/i] },
    { key: "Caja Washington", aliases: [/^WASHINGTON\b/i, /^CAJA\s+WASHINGTON\b/i] },
    { key: "Caja Menudo National", aliases: [/^NATIONAL\b/i, /^CAJA\s+MENUDO\s+NATIONAL\b/i, /^CAJA\s+NATIONAL\b/i] },
    { key: "Caja Canadian", aliases: [/^CANADIAN\b/i, /^CAJA\s+CANADIAN\b/i, /^MENUDO\s+CANADIAN\b/i, /^CAJA\s+CANADIAN\s+COMPLETA\b/i] },
  ];
  const KG_PER_BOX = 27.22;
  const MAX_KG_LINE = 60.00;
  const MAX_BOXES_ALLOWED = 500;

  /* ===== Helpers ===== */
  const $ = (id)=>document.getElementById(id);
  function setMsg(type, text){
    const el = $("msg");
    el.className = type === "err" ? "err" : (type==="ok" ? "ok" : "muted");
    el.textContent = text;
  }
  function setLog(type, text){
    const el = $("log");
    el.className = type === "err" ? "err" : (type==="ok" ? "ok" : "muted");
    el.textContent = text;
  }
  function formatErr(err){
    if(!err) return "Error desconocido";
    if(typeof err === "string") return err;
    if(err.message) return err.message;
    try { return JSON.stringify(err, null, 2); } catch { return String(err); }
  }
  function cleanPhone(s){ return String(s||"").replace(/\D/g,"").slice(-10); }
  function toNum(s){ const v = Number(String(s??"").replace(",", ".").trim()); return Number.isFinite(v) ? v : NaN; }
  function normalizeLine(s){ return String(s||"").replace(/[•·]/g," ").replace(/\s+/g," ").trim(); }
  function escapeHtml(s){
    return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function renderStatus(){
    $("stCliente").textContent = "Cliente: " + (currentClient ? (currentClient.nombre || currentClient.telefono) : "—");
    $("stPuntos").textContent  = "Puntos: " + (currentClient ? currentClient.puntos : "—");
    $("stSaldo").textContent   = "Saldo kg: " + (currentClient ? Number(currentClient.saldo_kg).toFixed(3) : "—");
  }

  function mapToCatalogProduct(line){
    const l = normalizeLine(line).toUpperCase();
    for(const p of PRODUCT_CATALOG){
      for(const rx of p.aliases){
        if(rx.test(l)) return p.key;
      }
    }
    return null;
  }
  function isBoxProduct(productKey){
    return /^Caja\b/i.test(productKey) || /Washington|National|Canadian/i.test(productKey);
  }

  function filterSmallNumbersOnly(text){
    const tokens = String(text||"").replace(/\r/g,"").split(/\s+/).filter(Boolean);
    const keep = [];
    for(const t of tokens){
      const s = t.replace(/,/g,"");
      const m = s.match(/^(\d{1,6})(?:\.(\d{1,6}))?$/);
      if(!m) continue;
      if(m[1].length > 2) continue;
      keep.push(s);
    }
    return keep.join("\n");
  }

  function parseTicketText(raw){
    const text = String(raw||"").replace(/\r/g,"");
    const lines = text.split("\n").map(l=>l.trim()).filter(Boolean);

    const isNumericCode = (s)=>/^\d{6,}$/.test(String(s||"").replace(/\s/g,""));
    const parseNum = (s)=>{
      const v = Number(String(s).replace(/,/g,"").trim());
      return Number.isFinite(v) ? v : NaN;
    };

    const out = [];

    for(let i=0;i<lines.length;i++){
      const productoLine = lines[i];
      const codeLine = lines[i+1] || "";
      const numsLine = lines[i+2] || "";

      if(!isNumericCode(codeLine)) continue;

      const mapped = mapToCatalogProduct(productoLine);
      if(!mapped){ i = i + 2; continue; }

      const parts = numsLine.split(/\s+/).filter(Boolean);
      const nums = parts.map(parseNum).filter(n=>Number.isFinite(n));
      if(nums.length < 1){ i = i + 2; continue; }

      const cantidad = nums[0];
      if(!Number.isFinite(cantidad) || cantidad <= 0){ i = i + 2; continue; }

      if(isBoxProduct(mapped)){
        if(cantidad > MAX_BOXES_ALLOWED){ i = i + 2; continue; }
        out.push({ producto: mapped, kg: cantidad * KG_PER_BOX });
      }else{
        if(cantidad > MAX_KG_LINE){ i = i + 2; continue; }
        out.push({ producto: mapped, kg: cantidad });
      }

      i = i + 2;
    }

    const map = new Map();
    for(const it of out){
      const key = it.producto.toLowerCase();
      map.set(key, (map.get(key)||0) + it.kg);
    }

    return [...map.entries()]
      .map(([k,kg])=>({ producto: k.charAt(0).toUpperCase()+k.slice(1), kg: Number(kg) }))
      .sort((a,b)=>b.kg-a.kg);
  }

  function calcTotalKg(items){ return items.reduce((a,it)=>a+(Number(it.kg)||0),0); }

  function renderDetalleEditable(){
    const box = $("detalleBox");
    if(!ticketItems.length){ box.className="muted"; box.textContent="—"; return; }

    const rows = ticketItems.map((it, idx)=>`
      <tr>
        <td style="width:65%"><input data-idx="${idx}" data-field="producto" value="${escapeHtml(it.producto)}" /></td>
        <td style="width:25%"><input data-idx="${idx}" data-field="kg" inputmode="decimal" value="${Number(it.kg).toFixed(3)}" /></td>
        <td class="right" style="width:10%"><button class="ghost" data-del="${idx}" style="margin:0;padding:8px;border-radius:10px">X</button></td>
      </tr>
    `).join("");

    box.className="";
    box.innerHTML = `
      <div class="mini">Puedes corregir nombres y kilos antes de guardar.</div>
      <table>
        <thead><tr><th>Producto</th><th>Kg</th><th class="right">Del</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="row" style="margin-top:10px">
        <button id="btnAgregarLinea" class="ghost">+ Agregar línea</button>
      </div>
    `;

    box.querySelectorAll('input[data-idx]').forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const idx = Number(inp.dataset.idx);
        const field = inp.dataset.field;
        if(!ticketItems[idx]) return;
        if(field==="kg"){ const v = toNum(inp.value); ticketItems[idx].kg = Number.isFinite(v) ? v : 0; }
        else ticketItems[idx].producto = normalizeLine(inp.value);
        $("kgAuto").value = calcTotalKg(ticketItems).toFixed(2);
      });
    });

    box.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const idx = Number(btn.dataset.del);
        ticketItems.splice(idx,1);
        $("kgAuto").value = calcTotalKg(ticketItems).toFixed(2);
        renderDetalleEditable();
      });
    });

    $("btnAgregarLinea").addEventListener("click", ()=>{
      ticketItems.push({ producto:"Producto", kg:0 });
      renderDetalleEditable();
    });
  }

  /* ===== ✅ NUEVO: llenar datalist con teléfonos guardados ===== */
  let clientsCache = []; // [{id, telefono, nombre, puntos, saldo_kg}]

  function fillDatalist(){
    const dl = $("telList");
    dl.innerHTML = "";

    // Mostramos label bonito: "4621234567 — Taquería Don Chuy"
    // y value = teléfono (para que se pegue el teléfono al input)
    const opts = clientsCache.map(c=>{
      const label = `${c.telefono}${c.nombre ? " — " + c.nombre : ""}`;
      return `<option value="${escapeHtml(c.telefono)}" label="${escapeHtml(label)}"></option>`;
    }).join("");

    dl.innerHTML = opts;
  }

  async function loadPhones(){
    if(!sb) throw new Error("Supabase no cargó.");

    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .order("telefono", { ascending: true })
      .limit(2000);

    if(error) throw error;

    clientsCache = data || [];
    fillDatalist();
  }

  function findClientInCacheByPhone(phone10){
    return clientsCache.find(c=>String(c.telefono||"") === phone10) || null;
  }

  async function selectClientByPhone(phone10){
    // Primero intentamos cache (rápido)
    const cached = findClientInCacheByPhone(phone10);
    if(cached){
      currentClient = cached;
      $("nombre").value = cached.nombre || "";
      renderStatus();
      setMsg("ok","Cliente seleccionado ✅ (lista). Ya puedes escanear el ticket.");
      return;
    }
    // Si no está en cache, buscamos en DB
    await buscarClientePorTelefono();
  }

  /* ===== Cliente ===== */
  async function buscarClientePorTelefono(){
    if(!sb) throw new Error("Supabase no cargó.");
    const tel = cleanPhone($("tel").value);
    if(tel.length !== 10) throw new Error("Teléfono inválido (deben ser 10 dígitos).");

    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .eq("telefono", tel)
      .maybeSingle();
    if(error) throw error;

    currentClient = data || null;
    renderStatus();

    if(data){
      $("nombre").value = data.nombre || "";
      setMsg("ok","Cliente encontrado ✅");
    }else{
      setMsg("muted","No existe: crea el cliente.");
    }
  }

  async function crearOActualizarCliente(){
    if(!sb) throw new Error("Supabase no cargó.");
    const tel = cleanPhone($("tel").value);
    const nombre = ($("nombre").value || "").trim() || null;
    if(tel.length !== 10) throw new Error("Teléfono inválido (deben ser 10 dígitos).");

    const payload = { telefono: tel };
    if(nombre) payload.nombre = nombre;

    const { data, error } = await sb
      .from(T_CLIENTES)
      .upsert(payload, { onConflict: "telefono" })
      .select("id,telefono,nombre,puntos,saldo_kg")
      .single();
    if(error) throw error;

    currentClient = data;
    renderStatus();
    setMsg("ok","Cliente creado/actualizado ✅");

    await loadPhones();
  }

  /* ===== Ticket ===== */
  function procesarTicket(){
    const raw = (rawOcrText && rawOcrText.trim()) ? rawOcrText : ($("ticketText").value || "");
    ticketItems = parseTicketText(raw);
    const total = calcTotalKg(ticketItems);
    $("kgAuto").value = Number.isFinite(total) ? total.toFixed(2) : "";
    renderDetalleEditable();

    if(!ticketItems.length) setLog("err","No pude detectar productos del catálogo. Escanea con buena luz.");
    else setLog("ok",`Ticket procesado. Líneas: ${ticketItems.length}. Total kg: ${total.toFixed(2)}.`);
  }

  function limpiarTicket(){
    $("ticketText").value = "";
    $("kgAuto").value = "";
    ticketItems = [];
    rawOcrText = "";
    renderDetalleEditable();
    setLog("muted","Listo.");
  }

  async function guardarVentaDesdeTicket(){
    if(!sb) throw new Error("Supabase no cargó.");
    if(!currentClient) throw new Error("Selecciona un cliente primero.");

    const tipo = $("tipo").value;
    const rawTicket = (rawOcrText && rawOcrText.trim()) ? rawOcrText.trim() : ($("ticketText").value || "").trim();

    const kg = toNum($("kgAuto").value);
    if(!Number.isFinite(kg) || kg <= 0) throw new Error("Total kg inválido.");

    const items = (ticketItems || [])
      .map(it=>({ producto: normalizeLine(it.producto), kg: Number(it.kg) }))
      .filter(it=>it.producto && Number.isFinite(it.kg) && it.kg > 0);

    const { data: venta, error: e1 } = await sb
      .from(T_VENTAS)
      .insert({
        tipo,
        cliente_id: currentClient.id,
        total_kg: kg,
        puntos_otorgados: 0,
        raw_ticket: rawTicket || null,
        captura: "ticket_ocr"
      })
      .select("id")
      .single();
    if(e1) throw e1;

    if(items.length){
      const payloadItems = items.map(it=>({ venta_id: venta.id, producto: it.producto, kg: it.kg }));
      const { error: e2 } = await sb.from(T_ITEMS).insert(payloadItems);
      if(e2) throw e2;
    }

    let puntosGanados = 0;
    let nuevoSaldo = Number(currentClient.saldo_kg);

    if(tipo === "mostrador"){
      const acumulado = Number(currentClient.saldo_kg) + kg;
      puntosGanados = Math.floor(acumulado / 100);
      nuevoSaldo = acumulado % 100;

      const { data: cli2, error: e3 } = await sb
        .from(T_CLIENTES)
        .update({ puntos: currentClient.puntos + puntosGanados, saldo_kg: nuevoSaldo })
        .eq("id", currentClient.id)
        .select("id,telefono,nombre,puntos,saldo_kg")
        .single();
      if(e3) throw e3;

      currentClient = cli2;
    }

    renderStatus();
    setLog("ok",`✅ Venta guardada. Items: ${items.length}. Puntos ganados: ${puntosGanados}.`);
    await loadPhones();
    limpiarTicket();
  }

  /* ===== OCR ===== */
  function setOcrUI(status, progress){
    $("ocrStatus").textContent = status || "—";
    const p = Math.max(0, Math.min(1, Number(progress||0)));
    $("ocrBar").style.width = (p*100).toFixed(0) + "%";
  }

  function drawToCanvas(img){
    const canvas = $("canvas");
    const ctx = canvas.getContext("2d");
    const maxW = 1400;
    const scale = Math.min(1, maxW / img.width);
    canvas.width = Math.round(img.width * scale);
    canvas.height = Math.round(img.height * scale);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  }

  function fileToImage(file){
    return new Promise((resolve,reject)=>{
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = ()=>{ URL.revokeObjectURL(url); resolve(img); };
      img.onerror = (e)=>{ URL.revokeObjectURL(url); reject(e); };
      img.src = url;
    });
  }

  async function runOCRFromCanvas(){
    if(typeof Tesseract === "undefined") throw new Error("OCR no cargó (Tesseract).");

    setOcrUI("Leyendo ticket... (OCR)", 0.02);

    const { data: { text } } = await Tesseract.recognize(
      $("canvas"),
      "spa",
      {
        logger: (m)=>{
          if(m && m.status){
            const prog = (typeof m.progress === "number") ? m.progress : 0;
            setOcrUI(`OCR: ${m.status} ${(prog*100).toFixed(0)}%`, prog);
          }
        }
      }
    );

    const cleaned = (text || "").replace(/\r/g, "").replace(/[ \t]+\n/g, "\n").trim();
    rawOcrText = cleaned;
    $("ticketText").value = filterSmallNumbersOnly(cleaned) || cleaned;

    setOcrUI("OCR terminado ✅", 1);
    procesarTicket();
  }

  async function runOCRFromFile(file){
    const img = await fileToImage(file);
    drawToCanvas(img);
    await runOCRFromCanvas();
  }

  async function startCamera(){
    $("camWrap").style.display = "grid";
    $("btnStartCam").disabled = true;
    $("btnStopCam").disabled = false;

    const video = $("video");
    camStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } },
      audio: false
    });
    video.srcObject = camStream;
    await video.play();
    setOcrUI("Cámara lista. Centra el ticket y toma foto.", 0);
  }

  function stopCamera(){
    try{ if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream = null; } }catch(_){}
    $("video").srcObject = null;
    $("camWrap").style.display = "none";
    $("btnStartCam").disabled = false;
    $("btnStopCam").disabled = true;
    setOcrUI("—", 0);
  }

  function snapToCanvas(){
    const video = $("video");
    const canvas = $("canvas");
    const ctx = canvas.getContext("2d");

    const w = video.videoWidth || 1280;
    const h = video.videoHeight || 720;

    const maxW = 1400;
    const scale = Math.min(1, maxW / w);
    canvas.width = Math.round(w * scale);
    canvas.height = Math.round(h * scale);
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  }

  /* ===== Listeners ===== */
  $("btnBuscar").addEventListener("click", async ()=>{
    setMsg("muted","Buscando...");
    try{ await buscarClientePorTelefono(); }
    catch(err){ console.error(err); setMsg("err", formatErr(err)); }
  });

  $("btnCrear").addEventListener("click", async ()=>{
    setMsg("muted","Guardando...");
    try{ await crearOActualizarCliente(); }
    catch(err){ console.error(err); setMsg("err", formatErr(err)); }
  });

  $("btnRecargar").addEventListener("click", async ()=>{
    setMsg("muted","Recargando teléfonos...");
    try{ await loadPhones(); setMsg("ok","Teléfonos recargados ✅"); }
    catch(err){ console.error(err); setMsg("err", formatErr(err)); }
  });

  // ✅ Cuando el usuario selecciona un número del datalist o lo termina de escribir
  $("tel").addEventListener("change", async ()=>{
    const tel10 = cleanPhone($("tel").value);
    if(tel10.length !== 10) return;
    $("tel").value = tel10;
    setMsg("muted","Cargando cliente...");
    try{ await selectClientByPhone(tel10); }
    catch(err){ console.error(err); setMsg("err", formatErr(err)); }
  });

  // opcional: al salir del input (blur) también carga
  $("tel").addEventListener("blur", async ()=>{
    const tel10 = cleanPhone($("tel").value);
    if(tel10.length !== 10) return;
    $("tel").value = tel10;
    if(currentClient && String(currentClient.telefono) === tel10) return;
    setMsg("muted","Cargando cliente...");
    try{ await selectClientByPhone(tel10); }
    catch(err){ console.error(err); setMsg("err", formatErr(err)); }
  });

  $("btnProcesar").addEventListener("click", ()=>{ try{ procesarTicket(); }catch(err){ setLog("err", formatErr(err)); } });
  $("btnLimpiar").addEventListener("click", limpiarTicket);

  $("btnGuardar").addEventListener("click", async ()=>{
    setLog("muted","Guardando venta...");
    try{ await guardarVentaDesdeTicket(); }
    catch(err){ console.error(err); setLog("err", formatErr(err)); }
  });

  $("btnStartCam").addEventListener("click", async ()=>{
    try{ await startCamera(); }
    catch(err){ console.error(err); setLog("err","No pude abrir cámara: " + formatErr(err)); stopCamera(); }
  });
  $("btnStopCam").addEventListener("click", stopCamera);

  $("btnSnap").addEventListener("click", async ()=>{
    try{
      if(!camStream) throw new Error("Cámara no encendida.");
      snapToCanvas();
      await runOCRFromCanvas();
    }catch(err){
      console.error(err);
      setLog("err","OCR falló: " + formatErr(err));
    }
  });

  $("fileTicket").addEventListener("change", async (e)=>{
    try{
      const f = e.target.files?.[0];
      if(!f) return;
      await runOCRFromFile(f);
    }catch(err){
      console.error(err);
      setLog("err","OCR falló: " + formatErr(err));
    }finally{
      e.target.value = "";
    }
  });

  window.addEventListener("beforeunload", stopCamera);
  document.addEventListener("visibilitychange", ()=>{ if(document.hidden) stopCamera(); });

  /* ===== Init ===== */
  (async ()=>{
    renderStatus();
    renderDetalleEditable();
    try{
      if(!sb) throw new Error("Supabase no cargó. Revisa internet/CDN.");
      await loadPhones();
      setMsg("muted","Pica el teléfono para elegir uno guardado o escribe uno nuevo.");
    }catch(err){
      console.error(err);
      setMsg("err", formatErr(err));
    }
  })();
</script>
</body>
</html>
