<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>VDC360¬∞ ‚Äî Cliente (QR) + Ticket (QR) + Inventario</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root{
      /* ‚úÖ Tema amigable (claro) */
      --bg:#f6f7f8;
      --paper:#ffffff;
      --paper2:#f9fafb;
      --line:#e5e7eb;

      --ink:#0f172a;
      --muted:#64748b;

      --brand:#16a34a;
      --brand2:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;

      --shadow: 0 14px 36px rgba(2,6,23,.10);
      --r:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 520px at 10% -10%, rgba(34,197,94,.12), transparent 60%),
                  radial-gradient(1000px 520px at 90% 10%, rgba(245,158,11,.10), transparent 60%),
                  var(--bg);
      color:var(--ink);
    }

    header{
      background:linear-gradient(90deg, rgba(22,163,74,.95), rgba(34,197,94,.95));
      color:#fff;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.18);
      position:sticky; top:0; z-index:5;
    }
    .headRow{max-width:1040px;margin:0 auto;display:flex;gap:10px;align-items:center;justify-content:space-between}
    header b{font-weight:1000}
    header .chip{
      background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.22);
      padding:6px 10px;border-radius:999px;
      font-weight:900;font-size:12px;
    }

    .wrap{max-width:1040px;margin:0 auto;padding:14px 16px;display:grid;gap:12px}

    .card{
      background:var(--paper);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
    }

    .titleRow{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap}
    h3{margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:4px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:820px){.grid{grid-template-columns:1fr}}

    label{display:block;font-weight:900;margin-top:10px}
    input,select,textarea,button{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--paper2);
      color:var(--ink);
      font-size:16px;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    input:focus,select:focus,textarea:focus{box-shadow:0 0 0 4px rgba(34,197,94,.14);border-color:rgba(34,197,94,.55)}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}

    button{
      border:0;
      background:var(--brand);
      color:#052e16;
      font-weight:1000;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(22,163,74,.18);
    }
    button.secondary{
      background:#0f172a;
      color:#fff;
      box-shadow:none;
    }
    button.ghost{
      background:transparent;
      color:var(--ink);
      border:1px solid var(--line);
      box-shadow:none;
    }
    button.warn{background:var(--warn);color:#1f1300;box-shadow:none}
    button:disabled{opacity:.5;cursor:not-allowed}

    .muted{color:var(--muted);font-size:12px}
    .pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--paper2);
      font-weight:900;
      font-size:12px;
      color:var(--ink);
    }

    /* QR cliente */
    #qrClienteBox{
      display:grid;place-items:center;
      border:1px dashed #cbd5e1;
      border-radius:16px;
      min-height:240px;
      margin-top:10px;
      padding:12px;
      background:linear-gradient(180deg, rgba(34,197,94,.06), transparent);
    }
    #qrClienteBox img{width:220px;height:220px;border-radius:12px;background:#fff}
    code{background:rgba(2,6,23,.06);padding:2px 6px;border-radius:10px;border:1px solid rgba(2,6,23,.08)}

    /* Totales */
    .totals{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    .bigTotal{
      background:rgba(34,197,94,.10);
      border:1px solid rgba(34,197,94,.22);
      border-radius:18px;
      padding:14px;
      text-align:center;
    }
    .bigTotal .t1{opacity:.85;font-weight:1000}
    .bigTotal .t2{font-size:44px;line-height:1;margin-top:8px;font-weight:1100;color:var(--brand)}
    .bigTotal .t3{opacity:.85;font-weight:1000;margin-top:6px}
    .miniGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .miniGrid{grid-template-columns:1fr;} }
    .miniCard{
      background:var(--paper2);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
    }
    .miniCard b{display:block;font-size:12px;color:var(--muted)}
    .miniCard .val{font-size:18px;font-weight:1100;margin-top:6px}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
    th{background:var(--paper2)}
    .right{text-align:right}

    input[type="file"]{display:none}

    /* Resultado operador (simple) */
    .toast{
      display:none;
      margin-top:10px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow);
    }
    .toast.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.08)}
    .toast.bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.06)}
    .toast .t{font-weight:1100}
    .toast .d{margin-top:6px;color:var(--muted);font-size:12px;white-space:pre-wrap}

    /* Ocultables por rol */
    .adminOnly{display:block}
    .opOnly{display:none}

    /* Modal login */
    .modalBg{
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      place-items:center;
      z-index:50;
      padding:16px;
    }
    .modal{
      width:min(520px,100%);
      background:#fff;
      border-radius:22px;
      border:1px solid var(--line);
      box-shadow:0 30px 80px rgba(0,0,0,.25);
      padding:16px;
    }
    .modal h4{margin:0 0 6px}
    .modal .sub{margin:0 0 10px}
    .seg{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;
    }
    .seg button{flex:1; min-width:140px}
  </style>
</head>

<body>
<header>
  <div class="headRow">
    <div>
      <b>VDC360¬∞ ‚Äî QR Cliente + QR Ticket</b>
      <div class="muted" style="color:rgba(255,255,255,.85)">Guardar compra + descontar inventario</div>
    </div>
    <div class="row" style="max-width:520px;align-items:center">
      <span class="chip" id="roleChip">Modo: ‚Äî</span>
      <button class="ghost" id="btnCambiarUsuario" type="button" style="background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.22);color:#fff;box-shadow:none">
        Cambiar usuario
      </button>
    </div>
  </div>
</header>

<div class="wrap">

  <!-- 1) Cliente -->
  <section class="card">
    <div class="titleRow">
      <div>
        <h3>1) Cliente</h3>
        <div class="sub">Cada cliente tiene su QR √∫nico para cargarlo autom√°tico.</div>
      </div>
      <div class="pills">
        <span class="pill" id="stCliente">Cliente: ‚Äî</span>
        <span class="pill" id="stPuntos">Puntos: ‚Äî</span>
        <span class="pill" id="stSaldo">Saldo kg: ‚Äî</span>
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div>
        <label>Nombre</label>
        <input id="nombre" placeholder="Ej. Taquer√≠a Don Chuy" list="nombreList" />
        <datalist id="nombreList"></datalist>
        <div class="muted">Tip: escribe y selecciona del autocompletado.</div>
      </div>
      <div>
        <label>Tel√©fono</label>
        <input id="tel" inputmode="numeric" placeholder="4621234567" />
        <div class="muted">Se autocompleta si eliges cliente existente.</div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnBuscar" type="button">Buscar</button>
      <button id="btnCrear" class="secondary" type="button">Crear / Actualizar</button>
      <button id="btnReloadNames" class="ghost" type="button">‚Üª Recargar</button>
    </div>

    <div id="msg" class="muted" style="margin-top:10px">‚Äî</div>

    <!-- QR Cliente -->
    <div class="grid" style="margin-top:12px">
      <div>
        <div id="qrClienteBox"><span class="muted">Selecciona un cliente para generar su QR</span></div>

        <!-- ‚úÖ ADMIN ONLY: muestra URL -->
        <div class="adminOnly">
          <div class="muted" id="qrClienteText" style="margin-top:10px"></div>
          <div class="row" style="margin-top:10px">
            <button id="btnCopiarUrl" class="ghost" type="button">Copiar URL del QR</button>
            <button id="btnAbrirUrl" class="ghost" type="button">Abrir URL</button>
          </div>
        </div>

        <!-- ‚úÖ OP ONLY: mensaje simple -->
        <div class="opOnly">
          <div class="muted" style="margin-top:10px">
            QR listo para imprimir o guardar. (Operador no ve URL)
          </div>
        </div>
      </div>

      <div class="muted">
        Uso recomendado:
        <ul>
          <li>Impr√≠melo y p√©galo en la libreta del cliente</li>
          <li>O gu√°rdalo en WhatsApp del cliente como ‚ÄúMi QR VDC‚Äù</li>
        </ul>
        <div class="muted">
          Tip: para cargar cliente r√°pido, abre esta misma p√°gina con el QR del cliente.
        </div>
      </div>
    </div>
  </section>

  <!-- 2) QR Ticket -->
  <section class="card">
    <div class="titleRow">
      <div>
        <h3>2) Escanear QR del Ticket</h3>
        <div class="sub">Primero selecciona cliente. Luego escanea el QR del ticket para aplicar inventario y guardar compra.</div>
      </div>
      <div class="row" style="min-width:260px;max-width:420px">
        <button class="ghost" id="toggle" type="button">Iniciar c√°mara</button>
        <button class="warn" id="switchCam" type="button" style="display:none">Cambiar c√°mara</button>
      </div>
    </div>

    <div id="reader" style="width:100%;margin-top:10px"></div>

    <div class="muted" style="margin-top:10px">
      Si el QR est√° pesado y no lo lee en vivo, usa <b>Subir foto</b> (modo seguro).
    </div>

    <label class="ghost" for="filePick" style="margin-top:10px;display:block;text-align:center;cursor:pointer">
      üì∏ Subir foto del QR (modo seguro)
      <input id="filePick" type="file" accept="image/*" capture="environment">
    </label>

    <!-- ‚úÖ ADMIN ONLY: debug payload -->
    <div class="adminOnly" style="margin-top:10px">
      <label>Contenido del QR (debug)</label>
      <textarea id="qrPayload" placeholder='Aqu√≠ se pega / aparecer√° lo escaneado...'></textarea>
      <div class="row" style="margin-top:10px">
        <button id="btnProcesarPegado" class="warn" type="button">Procesar QR pegado</button>
        <button id="btnLimpiar" class="ghost" type="button">Limpiar</button>
      </div>
    </div>

    <!-- Totales -->
    <div class="totals">
      <div class="bigTotal">
        <div class="t1">TOTAL KG DEL TICKET</div>
        <div class="t2" id="totalKg">0.00</div>
        <div class="t3">kg</div>
      </div>

      <!-- ‚úÖ ADMIN ONLY: fingerprint y l√≠neas -->
      <div class="miniGrid adminOnly">
        <div class="miniCard">
          <b># Productos (l√≠neas)</b>
          <div class="val" id="countLines">0</div>
        </div>
        <div class="miniCard">
          <b>Ticket (fingerprint)</b>
          <div class="val" id="fpShort">‚Äî</div>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div>
        <label>Tipo de venta</label>
        <select id="tipo">
          <option value="mostrador">mostrador (S√ç puntos)</option>
          <option value="credito">cr√©dito (NO puntos)</option>
        </select>
        <div class="muted">Puntos solo en mostrador.</div>
      </div>

      <!-- ‚úÖ ADMIN ONLY: editable kg -->
      <div class="adminOnly">
        <label>Total kg (editable)</label>
        <input id="kgAuto" inputmode="decimal" placeholder="0.00" />
        <div class="muted">Admin puede corregir kilos antes de guardar.</div>
      </div>

      <!-- ‚úÖ OP ONLY: kg fijo (solo lectura) -->
      <div class="opOnly">
        <label>Total kg</label>
        <input id="kgAutoOp" disabled />
        <div class="muted">Operador no puede editar.</div>
      </div>
    </div>

    <!-- ‚úÖ ADMIN ONLY: detalle editable -->
    <div id="detalleBox" class="adminOnly muted" style="margin-top:10px">‚Äî</div>

    <!-- ‚úÖ Operador: respuesta simple -->
    <div id="opToast" class="toast" aria-live="polite"></div>
  </section>

  <!-- 3) Log (admin) -->
  <section class="card adminOnly">
    <div class="muted">Resultado (t√©cnico):</div>
    <div id="out" class="log">Listo.</div>
  </section>

</div>

<!-- Modal cambiar usuario -->
<div class="modalBg" id="modalBg">
  <div class="modal">
    <h4>Cambiar usuario</h4>
    <p class="sub muted">Operador = solo OK. Admin = todo el detalle.</p>

    <div class="seg">
      <button id="btnSetOp" class="ghost" type="button">Soy Operador</button>
      <button id="btnSetAdmin" class="secondary" type="button">Soy Admin</button>
    </div>

    <div id="pinBox" style="display:none;margin-top:12px">
      <label>PIN Admin</label>
      <input id="adminPin" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <div class="muted">Tip: este PIN solo es UI (no es seguridad real). Luego lo blindamos con Auth/Roles.</div>
      <div class="row" style="margin-top:10px">
        <button id="btnOkPin" class="secondary" type="button">Entrar como Admin</button>
        <button id="btnCancelPin" class="ghost" type="button">Cancelar</button>
      </div>
      <div id="pinMsg" class="muted" style="margin-top:10px"></div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnCloseModal" class="ghost" type="button">Cerrar</button>
    </div>
  </div>
</div>

<script>
  // =========================
  // === Credenciales ===
  // =========================
  const SUPABASE_URL = "https://eqynjddcosvdqjzztznn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeW5qZGRjb3N2ZHFqenp0em5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMzYwMzIsImV4cCI6MjA3MTcxMjAzMn0.Q51wsGelUvxRfqsMYRY5JduCGyZ7s6AzOhqsRf3kOhk";
  const sb = window.sb || (window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY));

  // =========================
  // === Tablas clientes/ventas ===
  // =========================
  const T_CLIENTES = "clientes";

  // =========================
  // === Roles UI ===
  // =========================
  const ADMIN_PIN = "1234"; // üîí c√°mbialo
  const ROLE_KEY = "vdc_role_ui"; // "admin" | "op"
  let role = localStorage.getItem(ROLE_KEY) || "op";

  // =========================
  // === UI refs ===
  // =========================
  const $ = (id)=>document.getElementById(id);

  const roleChip = $("roleChip");
  const btnCambiarUsuario = $("btnCambiarUsuario");

  const modalBg = $("modalBg");
  const btnSetOp = $("btnSetOp");
  const btnSetAdmin = $("btnSetAdmin");
  const pinBox = $("pinBox");
  const adminPin = $("adminPin");
  const pinMsg = $("pinMsg");
  const btnOkPin = $("btnOkPin");
  const btnCancelPin = $("btnCancelPin");
  const btnCloseModal = $("btnCloseModal");

  const toggleBtn = $("toggle");
  const switchBtn = $("switchCam");
  const filePick = $("filePick");

  const totalKgEl = $("totalKg");
  const countLinesEl = $("countLines");
  const fpShortEl = $("fpShort");

  const opToast = $("opToast");

  const out = $("out"); // admin only

  // =========================
  // === Estado ===
  // =========================
  let currentClient = null;
  let clientsCache = [];

  let scanner = null;
  let running = false;
  let cameras = [];
  let camIndex = 0;

  // anti spam
  let busy = false;
  const BUSY_COOLDOWN_MS = 900;

  // items actuales
  let ticketItemsUi = [];      // [{producto, sku, kg, _kgTotal}]
  let ticketItemsInv = [];     // [{sku, kg}]
  let lastClientQrUrl = "";

  // =========================
  // ‚úÖ REGLAS CAJAS COMPLETAS
  // =========================
  const BOX_FULL_KG = 27.22;

  function normalizeLine(s){ return String(s||"").replace(/\s+/g," ").trim(); }
  function toNum(s){
    const v = Number(String(s ?? "").replace(",", ".").trim());
    return Number.isFinite(v) ? v : NaN;
  }
  function cleanPhone(s){ return String(s||"").replace(/\D/g,"").slice(-10); }
  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function logAdmin(txt, cls=""){
    if(!out) return;
    out.innerHTML = cls ? `<span class="${cls}">${txt}</span>` : txt;
  }

  function showOpToast(type, title, details){
    opToast.style.display = "block";
    opToast.className = "toast " + (type === "ok" ? "ok" : "bad");
    opToast.innerHTML = `
      <div class="t">${escapeHtml(title || "")}</div>
      <div class="d">${escapeHtml(details || "")}</div>
    `;
    setTimeout(()=>{ opToast.style.display = "none"; }, 4500);
  }

  function setMsg(type, text){
    const el = $("msg");
    el.className = "muted";
    el.textContent = text;
  }

  function renderStatus(){
    $("stCliente").textContent = "Cliente: " + (currentClient ? (currentClient.nombre || currentClient.telefono) : "‚Äî");
    $("stPuntos").textContent  = "Puntos: " + (currentClient ? currentClient.puntos : "‚Äî");
    $("stSaldo").textContent   = "Saldo kg: " + (currentClient ? Number(currentClient.saldo_kg||0).toFixed(3) : "‚Äî");
  }

  // =========================
  // ‚úÖ Aplicar rol (mostrar/ocultar secciones)
  // =========================
  function applyRoleUI(){
    roleChip.textContent = "Modo: " + (role === "admin" ? "Admin" : "Operador");

    document.querySelectorAll(".adminOnly").forEach(el=>{
      el.style.display = (role === "admin") ? "" : "none";
    });
    document.querySelectorAll(".opOnly").forEach(el=>{
      el.style.display = (role === "admin") ? "none" : "";
    });

    // En operador, el input kgAutoOp refleja kgAuto
    if(role !== "admin"){
      const opKg = $("kgAutoOp");
      const adminKg = $("kgAuto");
      if(opKg){
        opKg.value = adminKg ? (adminKg.value || "") : "";
      }
    }
  }

  // Modal handlers
  function openModal(){ modalBg.style.display = "grid"; pinBox.style.display="none"; pinMsg.textContent=""; adminPin.value=""; }
  function closeModal(){ modalBg.style.display = "none"; pinBox.style.display="none"; pinMsg.textContent=""; adminPin.value=""; }

  btnCambiarUsuario.addEventListener("click", openModal);
  btnCloseModal.addEventListener("click", closeModal);

  btnSetOp.addEventListener("click", ()=>{
    role = "op";
    localStorage.setItem(ROLE_KEY, role);
    applyRoleUI();
    closeModal();
  });

  btnSetAdmin.addEventListener("click", ()=>{
    pinBox.style.display = "block";
    adminPin.focus();
  });

  btnCancelPin.addEventListener("click", ()=>{
    pinBox.style.display = "none";
    pinMsg.textContent = "";
    adminPin.value = "";
  });

  btnOkPin.addEventListener("click", ()=>{
    if(String(adminPin.value||"").trim() === ADMIN_PIN){
      role = "admin";
      localStorage.setItem(ROLE_KEY, role);
      applyRoleUI();
      closeModal();
    }else{
      pinMsg.style.color = "#ef4444";
      pinMsg.textContent = "PIN incorrecto.";
    }
  });

  modalBg.addEventListener("click", (e)=>{
    if(e.target === modalBg) closeModal();
  });

  // =========================
  // ‚úÖ URL base (para QR cliente)
  // =========================
  function siteBaseUrl(){
    const u = new URL(window.location.href);
    return u.origin + u.pathname;
  }

  async function renderClientQR(){
    const box = $("qrClienteBox");
    const txt = $("qrClienteText");
    box.innerHTML = "";
    if(txt) txt.textContent = "";

    if(!currentClient?.id){
      box.innerHTML = `<span class="muted">Selecciona un cliente para generar su QR</span>`;
      lastClientQrUrl = "";
      return;
    }

    const url = `${siteBaseUrl()}?cid=${encodeURIComponent(currentClient.id)}`;
    lastClientQrUrl = url;

    const img = document.createElement("img");
    img.alt = "QR del cliente";
    img.src = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(url)}`;
    box.appendChild(img);

    if(txt) txt.innerHTML = `URL en QR: <code>${url}</code>`;
  }

  const btnCopiarUrl = $("btnCopiarUrl");
  const btnAbrirUrl = $("btnAbrirUrl");

  if(btnCopiarUrl){
    btnCopiarUrl.addEventListener("click", async ()=>{
      if(!lastClientQrUrl) return setMsg("bad","No hay URL. Selecciona cliente primero.");
      try{
        await navigator.clipboard.writeText(lastClientQrUrl);
        setMsg("ok","URL copiada ‚úÖ");
      }catch{
        setMsg("bad","No pude copiar (permiso del navegador).");
      }
    });
  }

  if(btnAbrirUrl){
    btnAbrirUrl.addEventListener("click", ()=>{
      if(!lastClientQrUrl) return setMsg("bad","No hay URL. Selecciona cliente primero.");
      window.open(lastClientQrUrl, "_blank");
    });
  }

  // =========================
  // ‚úÖ CANONIZADOR SKU (tu versi√≥n)
  // =========================
  function canonSku(productoOriginal){
    let t = String(productoOriginal || "")
      .trim()
      .toUpperCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "");

    if(/PATA[\s_-]*MORENA/.test(t)) return "PATA_MORENA";
    if(/^CAJA\s+AZUL\b/.test(t) || t.includes("CAJA AZUL")) return "CAJA_MENUDO_NATIONAL";
    if(/^CAJA\s+CANADIAN\b/.test(t) || t.includes("CAJA CANADIAN")) return "MENUDO_CANADIAN";
    if(t.includes("NATIONAL")) return "CAJA_MENUDO_NATIONAL";
    return t.replace(/\s+/g, "_");
  }

  function applyBoxRules(productoOriginal, qty){
    const name = String(productoOriginal || "").toUpperCase();
    const q = Number(qty);

    const isCajaCompleta =
      name.includes("CAJA") &&
      name.includes("COMPLETA") &&
      Number.isFinite(q) &&
      Math.abs(q - 1) < 1e-9;

    let kgForInv = Number.isFinite(q) ? q : 0;
    let kgForTotal = kgForInv;

    if(isCajaCompleta){
      if(name.includes("AZUL") || name.includes("CANADIAN") || name.includes("NATIONAL")){
        kgForInv = BOX_FULL_KG;
        kgForTotal = 0;
      }
    }
    return { kgForInv, kgForTotal };
  }

  function hashQr(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return "QR_" + (h >>> 0).toString(16);
  }

  function safeParseJson(text){ return JSON.parse((text||"").trim()); }

  function normalizePayload(raw, decodedText){
    if(Array.isArray(raw)){
      const itemsUi = raw.map(x => {
        const producto = String(x.producto || x.sku || "").trim();
        const qty = Number(x.cantidad ?? x.kg ?? 0);
        const sku = canonSku(producto);
        const { kgForInv, kgForTotal } = applyBoxRules(producto, qty);
        return { producto: producto || sku, sku, kg: kgForInv, _kgTotal: kgForTotal };
      }).filter(it => it.sku && Number.isFinite(it.kg));

      const itemsForRpc = itemsUi.map(({sku, kg}) => ({ sku, kg }));
      return { qr_id: hashQr(decodedText), items: itemsForRpc, _itemsUi: itemsUi };
    }

    if(raw && typeof raw === "object"){
      let items = raw.items;
      if(!Array.isArray(items) && Array.isArray(raw.productos)) items = raw.productos;

      const itemsUi = (items || []).map(x => {
        const producto = String(x.sku || x.producto || "").trim();
        const qty = Number(x.kg ?? x.cantidad ?? 0);
        const sku = canonSku(producto);
        const { kgForInv, kgForTotal } = applyBoxRules(producto, qty);
        return { producto: producto || sku, sku, kg: kgForInv, _kgTotal: kgForTotal };
      }).filter(it => it.sku && Number.isFinite(it.kg));

      const itemsForRpc = itemsUi.map(({sku, kg}) => ({ sku, kg }));
      return { qr_id: String(raw.qr_id || hashQr(decodedText)), items: itemsForRpc, _itemsUi: itemsUi };
    }
    return null;
  }

  function calcTotalKgVisual(itemsUi){
    let sum = 0;
    for(const it of (itemsUi||[])){
      const k = Number(it._kgTotal ?? it.kg);
      if(Number.isFinite(k)) sum += k;
    }
    return sum;
  }

  function updateTotalsUI(payload, fingerprint){
    const itemsUi = payload._itemsUi || [];
    const totalKg = calcTotalKgVisual(itemsUi);

    totalKgEl.textContent = totalKg.toFixed(2);

    if(countLinesEl) countLinesEl.textContent = String((payload.items || []).length || 0);
    if(fpShortEl) fpShortEl.textContent = fingerprint ? fingerprint.slice(0, 10) : "‚Äî";

    // Admin: editable
    const kgAdmin = $("kgAuto");
    if(kgAdmin) kgAdmin.value = totalKg.toFixed(2);

    // Operador: solo lectura
    const kgOp = $("kgAutoOp");
    if(kgOp) kgOp.value = totalKg.toFixed(2);
  }

  function renderDetalleEditable(){
    const box = $("detalleBox");
    if(!box) return;

    if(!ticketItemsUi.length){
      box.className = "muted";
      box.textContent = "‚Äî";
      return;
    }

    const rows = ticketItemsUi.map((it, idx)=>`
      <tr>
        <td style="width:55%">
          <input data-idx="${idx}" data-field="producto" value="${escapeHtml(it.producto)}" />
          <div class="muted">sku: ${escapeHtml(it.sku)}</div>
        </td>
        <td style="width:25%">
          <input data-idx="${idx}" data-field="kg" inputmode="decimal" value="${Number(it.kg).toFixed(3)}" />
          <div class="muted">total: ${Number(it._kgTotal ?? it.kg).toFixed(3)}</div>
        </td>
        <td class="right" style="width:20%">
          <button class="ghost" data-del="${idx}" style="margin:0;padding:10px;border-radius:12px">X</button>
        </td>
      </tr>
    `).join("");

    box.className = "";
    box.innerHTML = `
      <div class="muted">Admin puede corregir antes de guardar (afecta venta + inventario).</div>
      <table>
        <thead><tr><th>Producto</th><th>Kg</th><th class="right">Del</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;

    box.querySelectorAll('input[data-idx]').forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const idx = Number(inp.getAttribute("data-idx"));
        const field = inp.getAttribute("data-field");
        if(!ticketItemsUi[idx]) return;

        if(field === "kg"){
          const v = toNum(inp.value);
          ticketItemsUi[idx].kg = Number.isFinite(v) ? v : 0;
          ticketItemsUi[idx]._kgTotal = ticketItemsUi[idx].kg;
        }else{
          ticketItemsUi[idx].producto = normalizeLine(inp.value);
          ticketItemsUi[idx].sku = canonSku(ticketItemsUi[idx].producto);
        }

        ticketItemsInv = ticketItemsUi.map(it=>({ sku: it.sku, kg: Number(it.kg)||0 }))
          .filter(it=>it.sku && Number.isFinite(it.kg) && it.kg>0);

        const total = calcTotalKgVisual(ticketItemsUi);
        const kgAdmin = $("kgAuto");
        if(kgAdmin) kgAdmin.value = total.toFixed(2);
        const kgOp = $("kgAutoOp");
        if(kgOp) kgOp.value = total.toFixed(2);

        totalKgEl.textContent = total.toFixed(2);
        if(countLinesEl) countLinesEl.textContent = String(ticketItemsInv.length);
      });
    });

    box.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const idx = Number(btn.getAttribute("data-del"));
        ticketItemsUi.splice(idx, 1);

        ticketItemsInv = ticketItemsUi.map(it=>({ sku: it.sku, kg: Number(it.kg)||0 }))
          .filter(it=>it.sku && Number.isFinite(it.kg) && it.kg>0);

        const total = calcTotalKgVisual(ticketItemsUi);
        const kgAdmin = $("kgAuto");
        if(kgAdmin) kgAdmin.value = total.toFixed(2);
        const kgOp = $("kgAutoOp");
        if(kgOp) kgOp.value = total.toFixed(2);

        totalKgEl.textContent = total.toFixed(2);
        if(countLinesEl) countLinesEl.textContent = String(ticketItemsInv.length);

        renderDetalleEditable();
      });
    });
  }

  // =========================
  // ‚úÖ 1) INVENTARIO: RPC procesar_venta_qr
  // =========================
  async function descontarInventarioConRPC(payload, fingerprint){
    const { data, error } = await sb.rpc('procesar_venta_qr', {
      payload: { qr_id: payload.qr_id, items: payload.items },
      p_fingerprint: fingerprint
    });
    if(error) return { ok:false, error: error.message };
    if(data?.code === 'DUPLICATE') return { ok:false, duplicate:true, data };
    if(!data?.ok) return { ok:false, error: "NO OK:\n" + JSON.stringify(data, null, 2), data };
    return { ok:true, data };
  }

  // =========================
  // ‚úÖ 2) Guardar venta + puntos: RPC guardar_venta_cliente_qr
  // =========================
  async function guardarVentaClienteDesdeQR(decodedText, fingerprint){
    if(!currentClient) throw new Error("Primero selecciona un cliente.");

    const tipo = $("tipo").value;

    const kgAdmin = $("kgAuto");
    const kgOp = $("kgAutoOp");
    const kg = toNum( (kgAdmin && role==="admin") ? kgAdmin.value : (kgOp ? kgOp.value : "") );

    if(!Number.isFinite(kg) || kg <= 0) throw new Error("Total kg inv√°lido.");

    const items = (ticketItemsInv || [])
      .map(it => ({ sku: String(it.sku||"").trim(), kg: Number(it.kg)||0 }))
      .filter(it => it.sku && Number.isFinite(it.kg) && it.kg > 0);

    const { data, error } = await sb.rpc("guardar_venta_cliente_qr", {
      p_cliente_id: currentClient.id,
      p_tipo: tipo,
      p_total_kg: kg,
      p_items: items,
      p_fingerprint: fingerprint,
      p_raw: decodedText
    });

    if(error) throw new Error("RPC guardar_venta_cliente_qr: " + error.message);

    if(data?.code === "DUPLICATE"){
      return { duplicate:true, venta_id: data.venta_id, puntosGanados: 0, itemsCount: items.length };
    }
    if(!data?.ok){
      throw new Error("NO OK: " + JSON.stringify(data, null, 2));
    }

    // refresca cliente
    const { data: cli2 } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .eq("id", currentClient.id)
      .single();

    if(cli2) currentClient = cli2;

    renderStatus();
    await renderClientQR();

    return {
      venta_id: data.venta_id,
      puntosGanados: Number(data.puntos_ganados||0),
      itemsCount: items.length
    };
  }

  // =========================
  // ‚úÖ Pipeline unido
  // =========================
  async function handleDecoded(decodedText){
    if(busy) return;
    busy = true;

    try{
      if(!currentClient){
        if(role === "admin"){
          logAdmin("Selecciona un cliente primero (o abre con ?cid=).", "warnTxt");
        }else{
          showOpToast("bad", "Falta cliente", "Selecciona cliente primero.");
        }
        return;
      }

      // Admin debug payload
      const payloadBox = $("qrPayload");
      if(payloadBox) payloadBox.value = decodedText;

      const raw = safeParseJson(decodedText);
      const payload = normalizePayload(raw, decodedText);

      if(!payload?.items?.length){
        if(role === "admin"){
          logAdmin("QR inv√°lido: no pude formar items\n\n" + decodedText, "badTxt");
        }else{
          showOpToast("bad", "QR inv√°lido", "No pude leer los productos.");
        }
        return;
      }

      const fingerprint = hashQr(decodedText);

      updateTotalsUI(payload, fingerprint);
      ticketItemsUi = payload._itemsUi || [];
      ticketItemsInv = payload.items || [];

      if(role === "admin"){
        renderDetalleEditable();
        logAdmin("1) Descontando inventario‚Ä¶", "muted");
      }else{
        showOpToast("ok", "Procesando‚Ä¶", "Aplicando inventario y guardando compra.");
      }

      const invRes = await descontarInventarioConRPC(payload, fingerprint);

      if(invRes.duplicate){
        if(role === "admin"){
          logAdmin("Ticket ya procesado (DUPLICATE). No se descont√≥ otra vez ‚úÖ\n(No se guard√≥ venta cliente para evitar duplicado)", "okTxt");
        }else{
          showOpToast("ok", "Ya procesado", "Este ticket ya estaba aplicado ‚úÖ");
        }
        return;
      }

      if(!invRes.ok){
        if(role === "admin"){
          logAdmin("ERROR INVENTARIO:\n" + (invRes.error || "‚Äî"), "badTxt");
        }else{
          showOpToast("bad", "Error", "No se pudo descontar inventario.");
        }
        return;
      }

      if(role === "admin"){
        logAdmin("2) Guardando venta del cliente‚Ä¶", "muted");
      }

      const saveRes = await guardarVentaClienteDesdeQR(decodedText, fingerprint);

      if(role === "admin"){
        logAdmin(
          "‚úÖ LISTO\n" +
          "Inventario: descontado ‚úÖ\n" +
          `Venta guardada ‚úÖ (ID: ${saveRes.venta_id})\n` +
          `Items: ${saveRes.itemsCount}\n` +
          `Puntos ganados: ${saveRes.puntosGanados}\n\n` +
          "Respuesta inventario:\n" + JSON.stringify(invRes.data, null, 2),
          "okTxt"
        );
      }else{
        const kg = $("kgAutoOp")?.value || "";
        showOpToast("ok", "‚úÖ OK ‚Äî Venta aplicada", `Cliente: ${currentClient?.nombre || "‚Äî"}\nTotal: ${kg} kg`);
      }

    }catch(e){
      if(role === "admin"){
        logAdmin("ERROR:\n" + (e?.message || String(e)) + "\n\nContenido:\n" + decodedText, "badTxt");
      }else{
        showOpToast("bad", "Error", "No se pudo procesar el ticket.");
      }
    }finally{
      setTimeout(()=> busy = false, BUSY_COOLDOWN_MS);
    }
  }

  // =========================
  // Scanner QR
  // =========================
  async function onScanSuccess(decodedText){ await handleDecoded(decodedText); }

  async function refreshCameras(){
    cameras = await Html5Qrcode.getCameras();
    if(!Array.isArray(cameras)) cameras = [];
    switchBtn.style.display = (cameras.length >= 2) ? "block" : "none";
    const idxBack = cameras.findIndex(c => /back|rear|environment|trasera/i.test(c.label || ""));
    if(idxBack >= 0) camIndex = idxBack;
  }

  async function startWithCurrentCamera(){
    if(!scanner) scanner = new Html5Qrcode("reader");
    if(!cameras.length) await refreshCameras();

    running = true;
    toggleBtn.textContent = "Detener c√°mara";

    const config = {
      fps: 15,
      qrbox: (vw, vh) => {
        const size = Math.min(vw, vh) * 0.78;
        return { width: Math.floor(size), height: Math.floor(size) };
      },
      disableFlip: true,
      experimentalFeatures: { useBarCodeDetectorIfSupported: true }
    };

    const constraints = cameras.length
      ? { deviceId: { exact: cameras[camIndex].id } }
      : { facingMode: { ideal: "environment" }, width:{ ideal:1920 }, height:{ ideal:1080 } };

    try{
      await scanner.start(constraints, config, onScanSuccess);
      if(role === "admin") logAdmin("C√°mara lista. Escanea un ticket (cliente seleccionado).", "muted");
      else showOpToast("ok", "C√°mara lista", "Escanea el QR del ticket.");
    }catch(e){
      running = false;
      toggleBtn.textContent = "Iniciar c√°mara";
      if(role === "admin") logAdmin("No pude iniciar c√°mara. Revisa permisos y HTTPS.", "badTxt");
      else showOpToast("bad", "C√°mara", "No pude abrir la c√°mara.");
    }
  }

  async function start(){ if(running) return; await refreshCameras(); await startWithCurrentCamera(); }
  async function stop(){
    if(!running) return;
    running = false;
    toggleBtn.textContent = "Iniciar c√°mara";
    try{ await scanner.stop(); }catch(e){}
    if(role === "admin") logAdmin("C√°mara detenida.", "muted");
  }
  async function switchCamera(){
    if(cameras.length < 2){
      if(role === "admin") logAdmin("Solo hay 1 c√°mara disponible.", "badTxt");
      else showOpToast("bad", "C√°mara", "Solo hay 1 c√°mara.");
      return;
    }
    camIndex = (camIndex + 1) % cameras.length;
    if(running){ await stop(); await start(); }
  }

  filePick.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      if(!scanner) scanner = new Html5Qrcode("reader");
      if(role === "admin") logAdmin("Leyendo foto‚Ä¶ (modo seguro)", "muted");
      else showOpToast("ok", "Leyendo foto‚Ä¶", "Procesando QR.");
      const decodedText = await scanner.scanFile(file, true);
      await handleDecoded(decodedText);
    }catch(err){
      console.error(err);
      if(role === "admin") logAdmin("No pude leer la foto. Tip: QR grande, sin reflejo, m√°s cerca.", "badTxt");
      else showOpToast("bad", "No se pudo", "Toma la foto m√°s cerca y sin reflejo.");
    }finally{
      filePick.value = "";
    }
  });

  toggleBtn.addEventListener('click', async ()=>{ if(!running) await start(); else await stop(); });
  switchBtn.addEventListener('click', switchCamera);

  // =========================
  // Clientes: datalist + CRUD + cargar por ?cid=
  // =========================
  async function loadNameDatalist(){
    const dl = $("nombreList");
    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .order("nombre", { ascending: true })
      .limit(5000);

    if(error){ console.error(error); return; }

    clientsCache = (data || []).filter(c => (c.nombre || "").trim().length > 0);
    dl.innerHTML = "";
    for(const c of clientsCache){
      const opt = document.createElement("option");
      opt.value = c.nombre;
      opt.label = `${c.nombre} ‚Äî ${c.telefono || ""}`;
      dl.appendChild(opt);
    }
  }

  function findClientByName(name){
    const n = normalizeLine(name).toLowerCase();
    return clientsCache.find(c => normalizeLine(c.nombre || "").toLowerCase() === n) || null;
  }

  $("nombre").addEventListener("input", async ()=>{
    const c = findClientByName($("nombre").value);
    if(c){
      $("tel").value = c.telefono || "";
      currentClient = c;
      renderStatus();
      await renderClientQR();
      setMsg("ok","Cliente cargado ‚úÖ");
    }
  });

  async function buscarClientePorNombreOTel(){
    const nombre = normalizeLine($("nombre").value);
    const tel = cleanPhone($("tel").value);
    if(!nombre) throw new Error("Nombre es obligatorio.");

    const cached = findClientByName(nombre);
    if(cached){
      currentClient = cached;
      $("tel").value = cached.telefono || tel;
      renderStatus();
      await renderClientQR();
      setMsg("ok","Cliente encontrado ‚úÖ");
      return;
    }

    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .ilike("nombre", nombre)
      .maybeSingle();

    if(error) throw error;

    currentClient = data || null;
    if(data) $("tel").value = data.telefono || tel;
    renderStatus();
    await renderClientQR();

    setMsg("ok", data ? "Cliente encontrado ‚úÖ" : "No existe: crea el cliente.");
  }

  async function crearOActualizarCliente(){
    const nombre = normalizeLine($("nombre").value);
    const tel = cleanPhone($("tel").value);

    if(!nombre) throw new Error("Nombre es obligatorio.");
    if(tel && tel.length !== 10) throw new Error("Tel√©fono inv√°lido (si lo pones debe ser de 10 d√≠gitos).");

    const payload = { nombre };
    if(tel) payload.telefono = tel;

    let res;
    if(tel){
      res = await sb.from(T_CLIENTES).upsert(payload, { onConflict: "telefono" })
        .select("id,telefono,nombre,puntos,saldo_kg").single();
    }else{
      res = await sb.from(T_CLIENTES).insert(payload)
        .select("id,telefono,nombre,puntos,saldo_kg").single();
    }

    if(res.error) throw res.error;

    currentClient = res.data;
    renderStatus();
    await renderClientQR();
    setMsg("ok", "Cliente creado/actualizado ‚úÖ");
    await loadNameDatalist();
  }

  $("btnBuscar").addEventListener("click", async ()=>{
    setMsg("muted","Buscando...");
    try{ await buscarClientePorNombreOTel(); }
    catch(e){ console.error(e); setMsg("bad", e.message || String(e)); }
  });

  $("btnCrear").addEventListener("click", async ()=>{
    setMsg("muted","Guardando...");
    try{ await crearOActualizarCliente(); }
    catch(e){ console.error(e); setMsg("bad", e.message || String(e)); }
  });

  $("btnReloadNames").addEventListener("click", async ()=>{
    setMsg("muted","Recargando...");
    await loadNameDatalist();
    setMsg("ok","Listo ‚úÖ");
  });

  // admin-only processing pasted QR
  const btnProcesarPegado = $("btnProcesarPegado");
  const btnLimpiar = $("btnLimpiar");
  if(btnProcesarPegado){
    btnProcesarPegado.addEventListener("click", async ()=>{
      const txt = ($("qrPayload")?.value || "").trim();
      if(!txt) return logAdmin("Pega el contenido del QR primero.", "warnTxt");
      await handleDecoded(txt);
    });
  }
  if(btnLimpiar){
    btnLimpiar.addEventListener("click", ()=>{
      const payloadBox = $("qrPayload");
      if(payloadBox) payloadBox.value = "";
      totalKgEl.textContent = "0.00";
      if(countLinesEl) countLinesEl.textContent = "0";
      if(fpShortEl) fpShortEl.textContent = "‚Äî";
      const kgAdmin = $("kgAuto");
      if(kgAdmin) kgAdmin.value = "";
      const kgOp = $("kgAutoOp");
      if(kgOp) kgOp.value = "";

      ticketItemsUi = [];
      ticketItemsInv = [];
      renderDetalleEditable();
      logAdmin("Listo.", "muted");
    });
  }

  async function cargarClientePorQuery(){
    const u = new URL(window.location.href);
    const cid = u.searchParams.get("cid");
    if(!cid) return;

    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .eq("id", cid)
      .maybeSingle();

    if(error){ console.error(error); setMsg("bad", "Error cargando cid: " + error.message); return; }
    if(!data){ setMsg("bad", "Este cid no existe."); return; }

    currentClient = data;
    $("nombre").value = data.nombre || "";
    $("tel").value = data.telefono || "";
    renderStatus();
    await renderClientQR();
    setMsg("ok", "Cliente cargado desde QR ‚úÖ");
  }

  // init
  (async function init(){
    applyRoleUI();
    renderStatus();
    renderDetalleEditable();
    await loadNameDatalist();
    await cargarClientePorQuery();
    await refreshCameras();

    if(role === "admin"){
      logAdmin("Listo. Selecciona cliente y escanea QR del ticket.", "muted");
    }else{
      showOpToast("ok", "Listo", "Selecciona cliente y escanea el QR del ticket.");
    }
  })();
</script>

</body>
</html>
