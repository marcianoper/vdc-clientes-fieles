<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VDC360° — Cliente Fiel 1(QR + Puntos)</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    :root{--brand:#0a7a3b;--bg:#f6f7f8;--card:#fff;--ink:#111;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
    header{background:var(--brand);color:#fff;padding:14px 18px}
    header h1{margin:0;font-size:18px}
    main{max-width:980px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;font-weight:700;margin-top:10px}
    input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid #d1d5db;font-size:16px}
    button{background:var(--brand);color:#fff;border:none;font-weight:800;cursor:pointer;margin-top:12px}
    button.secondary{background:#111}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{display:inline-block;background:#eef2ff;border:1px solid #c7d2fe;color:#1e3a8a;padding:6px 10px;border-radius:999px;font-weight:700}
    .muted{color:var(--muted)}
    #qrBox{display:grid;place-items:center;padding:12px;border:1px dashed #d1d5db;border-radius:12px;min-height:220px}
    code{background:#f1f5f9;padding:2px 6px;border-radius:8px}
  </style>
</head>

<body>
<header>
  <h1>VDC360° — Cliente Fiel (QR + Puntos)</h1>
</header>

<main>

  <section class="card">
    <h2 style="margin:0 0 6px">1) Buscar / Crear cliente (solo teléfono)</h2>
    <div class="grid">
      <div>
        <label>Teléfono (10 dígitos)</label>
        <input id="tel" inputmode="numeric" placeholder="Ej. 4621234567" />
      </div>
      <div>
        <label>Nombre (opcional)</label>
        <input id="nombre" placeholder="Ej. Taquería Don Chuy" />
      </div>
    </div>
    <div class="row">
      <button id="btnBuscar">Buscar cliente</button>
      <button id="btnCrear" class="secondary">Crear / Actualizar</button>
    </div>
    <p class="muted" style="margin:10px 0 0">
      Si el cliente ya existe, “Crear/Actualizar” solo actualiza el nombre (si lo mandas).
    </p>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">2) QR del cliente</h2>
    <p class="muted" style="margin-top:0">
      Este QR contiene un ID (no datos sensibles). Tú lo escaneas en mostrador y listo.
    </p>
    <div id="qrBox"><span class="muted">Aquí aparecerá el QR</span></div>
    <p class="muted" id="qrText" style="margin:10px 0 0"></p>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">3) Cerrar venta (mostrador/crédito)</h2>
    <div class="grid">
      <div>
        <label>Tipo de venta</label>
        <select id="tipo">
          <option value="mostrador">mostrador (SÍ puntos)</option>
          <option value="credito">crédito (NO puntos)</option>
        </select>
      </div>
      <div>
        <label>Total kg del ticket</label>
        <input id="kg" inputmode="decimal" placeholder="Ej. 125.50" />
      </div>
    </div>
    <button id="btnCerrar">Cerrar venta y aplicar puntos</button>

    <div style="margin-top:12px">
      <span class="pill" id="stCliente">Cliente: —</span>
      <span class="pill" id="stPuntos">Puntos: —</span>
      <span class="pill" id="stSaldo">Saldo kg: —</span>
    </div>

    <p class="muted" id="log" style="margin:10px 0 0"></p>
  </section>

</main>

<script>
  // 1) CONFIG
  const SUPABASE_URL = "https://eqynjddcosvdqjzztznn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeW5qZGRjb3N2ZHFqenp0em5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMzYwMzIsImV4cCI6MjA3MTcxMjAzMn0.Q51wsGelUvxRfqsMYRY5JduCGyZ7s6AzOhqsRf3kOhk";

  const SUPABASE = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

  // Estado
  let currentClient = null; // {id, telefono, nombre, puntos, saldo_kg}

  // Helpers
  const $ = (id) => document.getElementById(id);
  const cleanPhone = (s) => (s || "").replace(/\D/g, "").slice(-10);

  function renderStatus(){
    $("stCliente").textContent = "Cliente: " + (currentClient ? (currentClient.nombre || currentClient.telefono) : "—");
    $("stPuntos").textContent  = "Puntos: " + (currentClient ? currentClient.puntos : "—");
    $("stSaldo").textContent   = "Saldo kg: " + (currentClient ? Number(currentClient.saldo_kg).toFixed(3) : "—");
  }

  async function renderQR(){
    const box = $("qrBox");
    box.innerHTML = "";
    $("qrText").textContent = "";

    if(!currentClient){
      box.innerHTML = '<span class="muted">Primero selecciona/crea un cliente</span>';
      return;
    }

    // El QR puede contener un "payload" simple, por ejemplo:
    // vdc://cliente?id=<uuid>
    const payload = `vdc://cliente?id=${currentClient.id}`;
    const canvas = document.createElement("canvas");
    await QRCode.toCanvas(canvas, payload, { width: 220, margin: 1 });
    box.appendChild(canvas);
    $("qrText").innerHTML = `Payload: <code>${payload}</code>`;
  }

  async function buscarClientePorTelefono(){
    const tel = cleanPhone($("tel").value);
    if(tel.length !== 10) throw new Error("Teléfono inválido (deben ser 10 dígitos).");

    const { data, error } = await sb
      .from("clientes")
      .select("id,telefono,nombre,puntos,saldo_kg")
      .eq("telefono", tel)
      .maybeSingle();

    if(error) throw error;
    currentClient = data || null;
    renderStatus();
    await renderQR();
    $("log").textContent = data ? "Cliente encontrado." : "No existe: crea el cliente.";
  }

  async function crearOActualizarCliente(){
    const tel = cleanPhone($("tel").value);
    const nombre = ($("nombre").value || "").trim() || null;
    if(tel.length !== 10) throw new Error("Teléfono inválido (deben ser 10 dígitos).");

    // UPSERT por telefono (requiere UNIQUE en telefono)
    const payload = { telefono: tel };
    if(nombre) payload.nombre = nombre;

    const { data, error } = await sb
      .from("clientes")
      .upsert(payload, { onConflict: "telefono" })
      .select("id,telefono,nombre,puntos,saldo_kg")
      .single();

    if(error) throw error;
    currentClient = data;
    renderStatus();
    await renderQR();
    $("log").textContent = "Cliente creado/actualizado.";
  }

  async function cerrarVentaYAplicarPuntos(){
    const tipo = $("tipo").value;
    const kg = Number(String($("kg").value).replace(",", "."));
    if(!Number.isFinite(kg) || kg <= 0) throw new Error("Total kg inválido.");
    if(!currentClient){
      throw new Error("Primero selecciona/crea un cliente (para acumular puntos).");
    }

    // 1) Insertar venta (con puntos_otorgados=0 por ahora)
    const ventaBase = {
      tipo,
      cliente_id: currentClient.id,
      total_kg: kg,
      puntos_otorgados: 0
    };

    const { data: venta, error: e1 } = await sb
      .from("ventas")
      .insert(ventaBase)
      .select("id,fecha,tipo,cliente_id,total_kg,puntos_otorgados")
      .single();
    if(e1) throw e1;

    // 2) Si es MOSTRADOR, calcular y aplicar puntos
    let puntosGanados = 0;
    let nuevoSaldo = Number(currentClient.saldo_kg);

    if(tipo === "mostrador"){
      const acumulado = Number(currentClient.saldo_kg) + kg;
      puntosGanados = Math.floor(acumulado / 100);
      nuevoSaldo = acumulado % 100;

      // actualizar cliente
      const { data: cli2, error: e2 } = await sb
        .from("clientes")
        .update({
          puntos: currentClient.puntos + puntosGanados,
          saldo_kg: nuevoSaldo
        })
        .eq("id", currentClient.id)
        .select("id,telefono,nombre,puntos,saldo_kg")
        .single();
      if(e2) throw e2;
      currentClient = cli2;

      // guardar auditoría en venta
      const { error: e3 } = await sb
        .from("ventas")
        .update({ puntos_otorgados: puntosGanados })
        .eq("id", venta.id);
      if(e3) throw e3;
    }

    renderStatus();
    $("log").textContent =
      `Venta cerrada (${tipo}). Kg: ${kg.toFixed(3)}. Puntos ganados: ${puntosGanados}. Saldo kg: ${Number(currentClient.saldo_kg).toFixed(3)}.`;
  }

  // Eventos
  $("btnBuscar").addEventListener("click", async () => {
    $("log").textContent = "Buscando...";
    try{ await buscarClientePorTelefono(); } catch(err){ $("log").textContent = err.message; }
  });

  $("btnCrear").addEventListener("click", async () => {
    $("log").textContent = "Guardando...";
    try{ await crearOActualizarCliente(); } catch(err){ $("log").textContent = err.message; }
  });

  $("btnCerrar").addEventListener("click", async () => {
    $("log").textContent = "Cerrando venta...";
    try{ await cerrarVentaYAplicarPuntos(); } catch(err){ $("log").textContent = err.message; }
  });

  renderStatus();
</script>
</body>
</html>
