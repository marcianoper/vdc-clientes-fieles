<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VDC360° — Clientes Fieles (QR + Puntos + Tickets)</title>

  <style>
    :root{--brand:#0a7a3b;--bg:#f6f7f8;--card:#fff;--ink:#111;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
    header{background:var(--brand);color:#fff;padding:14px 18px}
    header h1{margin:0;font-size:18px}
    main{max-width:980px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    label{display:block;font-weight:800;margin-top:10px}
    input,select,button,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #d1d5db;font-size:16px}
    textarea{min-height:140px;resize:vertical}
    button{background:var(--brand);color:#fff;border:none;font-weight:900;cursor:pointer;margin-top:12px}
    button.secondary{background:#111}
    button.ghost{background:#fff;color:#111;border:1px solid #d1d5db}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{display:inline-block;background:#eef7ef;border:1px solid #cfe9d1;color:#1f6f26;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px}
    .muted{color:var(--muted)}
    #qrBox{display:grid;place-items:center;padding:12px;border:1px dashed #d1d5db;border-radius:12px;min-height:240px}
    code{background:#f1f5f9;padding:2px 6px;border-radius:8px}
    .err{background:#fff1f2;border:1px solid #fecdd3;color:#b91c1c;padding:10px;border-radius:12px;white-space:pre-wrap}
    .ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:10px;border-radius:12px;white-space:pre-wrap}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}
    th{background:#f9fafb}
    .mini{font-size:12px;color:var(--muted)}
    .right{text-align:right}

    .camWrap{display:grid;gap:10px;margin-top:10px}
    video{width:100%;border-radius:12px;border:1px solid #e5e7eb;background:#000;max-height:360px}
    canvas{display:none}
    .progressBar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .progressBar > div{height:100%;width:0%;background:var(--brand)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}

    details{border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-top:10px;background:#fff}
    details summary{cursor:pointer;font-weight:900}
    pre{white-space:pre-wrap;word-break:break-word;background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body>
<header>
  <h1>VDC360° — Clientes Fieles (QR + Puntos + Tickets)</h1>
</header>

<main>

  <section class="card">
    <h2 style="margin:0 0 6px">1) Buscar / Crear cliente (solo teléfono)</h2>

    <div class="grid">
      <div>
        <label>Teléfono (10 dígitos)</label>
        <input id="tel" inputmode="numeric" placeholder="Ej. 4621234567" list="telList" />
        <datalist id="telList"></datalist>
        <div class="hint">Tip: pica el campo y te mostrará teléfonos guardados. Puedes escribir y te filtra.</div>
      </div>

      <div>
        <label>Nombre (opcional)</label>
        <input id="nombre" placeholder="Ej. Taquería Don Chuy" />
        <div class="hint">Se llena automático si seleccionas un teléfono existente.</div>
      </div>
    </div>

    <div class="row">
      <button id="btnBuscar">Buscar cliente</button>
      <button id="btnCrear" class="secondary">Crear / Actualizar</button>
      <button id="btnReloadPhones" class="ghost" type="button">↻ Recargar teléfonos</button>
    </div>

    <div id="msg" class="muted" style="margin-top:10px"></div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">2) QR del cliente</h2>
    <p class="muted" style="margin-top:0">El QR contiene una URL del sitio con <code>?cid=</code> para cargar al cliente automáticamente.</p>

    <div id="qrBox"><span class="muted">Aquí aparecerá el QR</span></div>
    <div class="muted" id="qrText" style="margin-top:10px"></div>

    <div class="row" style="margin-top:10px">
      <span class="pill" id="stCliente">Cliente: —</span>
      <span class="pill" id="stPuntos">Puntos: —</span>
      <span class="pill" id="stSaldo">Saldo kg: —</span>
    </div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">3) Capturar compra por Ticket</h2>
    <p class="muted" style="margin-top:0">
      Puedes pegar el texto o <b>escanear aquí mismo</b> con cámara (OCR).
      La caja mostrará una <b>vista filtrada</b> (solo números chicos), pero el sistema procesa el OCR completo.
    </p>

    <div class="row">
      <button id="btnStartCam" class="ghost">Escanear con cámara (OCR)</button>
      <button id="btnStopCam" class="ghost" disabled>Apagar cámara</button>
      <label class="ghost" style="display:block;margin-top:12px;padding:10px;border-radius:10px;border:1px solid #d1d5db;cursor:pointer">
        Subir foto (alternativa)
        <input id="fileTicket" type="file" accept="image/*" capture="environment" style="display:none" />
      </label>
    </div>

    <div class="camWrap" id="camWrap" style="display:none">
      <video id="video" playsinline></video>
      <canvas id="canvas"></canvas>
      <div class="row">
        <button id="btnSnap" class="ghost">Tomar foto y leer</button>
      </div>
      <div class="mini" id="ocrStatus">—</div>
      <div class="progressBar"><div id="ocrBar"></div></div>
    </div>

    <label>Texto del ticket (vista filtrada / pegado)</label>
    <textarea id="ticketText" placeholder="Aquí aparecerán solo números chicos. El OCR completo se guarda internamente."></textarea>

    <div class="row">
      <button id="btnProcesar" class="ghost">Procesar ticket</button>
      <button id="btnLimpiar" class="ghost">Limpiar</button>
      <button id="btnVerOCR" class="ghost" type="button">Ver OCR completo</button>
    </div>

    <details id="rawBox" style="display:none">
      <summary>OCR completo detectado</summary>
      <pre id="rawPre"></pre>
    </details>

    <div class="grid" style="margin-top:10px">
      <div>
        <label>Total kg detectado</label>
        <input id="kgAuto" inputmode="decimal" placeholder="0.00" />
        <div class="mini">Se llena automático; puedes editar si hace falta.</div>
      </div>
      <div>
        <label>Tipo de venta</label>
        <select id="tipo">
          <option value="mostrador">mostrador (SÍ puntos)</option>
          <option value="credito">crédito (NO puntos)</option>
        </select>
        <div class="mini">Para puntos: solo mostrador.</div>
      </div>
    </div>

    <div id="detalleBox" class="muted" style="margin-top:10px">—</div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">4) Guardar venta (guarda encabezado + detalle)</h2>
    <button id="btnGuardar">Guardar venta desde ticket</button>
    <div id="log" class="muted" style="margin-top:10px"></div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">Diagnóstico</h2>
    <div id="diag" class="muted">—</div>
  </section>

</main>

<script>
  /* ===== CONFIG (tus credenciales) ===== */
  const SUPABASE_URL = "https://eqynjddcosvdqjzztznn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeW5qZGRjb3N2ZHFqenp0em5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMzYwMzIsImV4cCI6MjA3MTcxMjAzMn0.Q51wsGelUvxRfqsMYRY5JduCGyZ7s6AzOhqsRf3kOhk";

  const sb = (window.supabase && window.supabase.createClient)
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    : null;

  /* ===== TABLAS ===== */
  const T_CLIENTES = "clientes";
  const T_VENTAS   = "ventas";
  const T_ITEMS    = "ventas_items";

  /* ===== Estado ===== */
  let currentClient = null;
  let ticketItems = [];
  let camStream = null;

  let rawOcrText = "";         // ✅ OCR COMPLETO
  let filteredOcrView = "";    // ✅ vista filtrada (números chicos)

  /* ===== Catálogo ===== */
  const PRODUCT_CATALOG = [
    { key: "Panza",         aliases: [/\bPANZA\b/i] },
    { key: "Higado",        aliases: [/\bHIGADO\b/i] },
    { key: "Libro",         aliases: [/\bLIBRO\b/i] },
    { key: "Corazon",       aliases: [/\bCORAZON\b/i] },
    { key: "Tripa",         aliases: [/\bTRIPA\b/i] },
    { key: "Bofe",          aliases: [/\bBOFE\b/i] },
    { key: "Cabeza",        aliases: [/\bCABEZA\b/i, /\bCABEZA\s+DE\s+RES\b/i, /\bCABEZA\s+DE\s+RASTRO\b/i, /\bCABEZA\s+RASTRO\b/i] },
    { key: "Pata Blanca",   aliases: [/\bPATA\s*BLANCA\b/i] },
    { key: "Pata Morena",   aliases: [/\bPATA\s*MORENA\b/i, /\bPATAS\s*MORENA\b/i] },
    { key: "Caja Washington",      aliases: [/\bWASHINGTON\b/i, /\bCAJA\s+WASHINGTON\b/i] },
    { key: "Caja Menudo National", aliases: [/\bNATIONAL\b/i, /\bCAJA\s+MENUDO\s+NATIONAL\b/i, /\bCAJA\s+NATIONAL\b/i, /\bCAJA\s+MENUDO\s+NACIONAL\b/i] },
    { key: "Caja Canadian",        aliases: [/\bCANADIAN\b/i, /\bCAJA\s+CANADIAN\b/i, /\bMENUDO\s+CANADIAN\b/i, /\bCAJA\s+CANADIAN\s+COMPLETA\b/i] },
  ];

  const KG_PER_BOX = 27.22;
  const MAX_KG_LINE = 60.00;
  const MAX_BOXES_ALLOWED = 500;

  /* ===== Helpers ===== */
  const $ = (id)=>document.getElementById(id);

  function setMsg(type, text){
    const el = $("msg");
    if(!el) return;
    el.className = type === "err" ? "err" : (type==="ok" ? "ok" : "muted");
    el.textContent = text;
  }

  function setLog(type, text){
    const el = $("log");
    if(!el) return;
    el.className = type === "err" ? "err" : (type==="ok" ? "ok" : "muted");
    el.textContent = text;
  }

  function cleanPhone(s){
    return String(s || "").replace(/\D/g, "").slice(-10);
  }

  function renderStatus(){
    $("stCliente").textContent = "Cliente: " + (currentClient ? (currentClient.nombre || currentClient.telefono) : "—");
    $("stPuntos").textContent  = "Puntos: " + (currentClient ? currentClient.puntos : "—");
    $("stSaldo").textContent   = "Saldo kg: " + (currentClient ? Number(currentClient.saldo_kg).toFixed(3) : "—");
  }

  function siteBaseUrl(){
    const u = new URL(window.location.href);
    return u.origin + u.pathname.replace(/index\.html$/,'');
  }

  async function renderQR(){
    const box = $("qrBox");
    box.innerHTML = "";
    $("qrText").textContent = "";

    if(!currentClient){
      box.innerHTML = '<span class="muted">Primero crea/selecciona un cliente</span>';
      return;
    }

    const payload = `${siteBaseUrl()}?cid=${currentClient.id}`;
    const img = document.createElement("img");
    img.alt = "QR del cliente";
    img.style.width = "240px";
    img.style.height = "240px";
    img.src = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(payload)}`;
    box.appendChild(img);
    $("qrText").innerHTML = `URL en QR: <code>${payload}</code>`;
  }

  function formatErr(err){
    if(!err) return "Error desconocido";
    if(typeof err === "string") return err;
    if(err.message) return err.message;
    if(err.error_description) return err.error_description;
    try { return JSON.stringify(err, null, 2); } catch { return String(err); }
  }

  function toNum(s){
    const v = Number(String(s ?? "").replace(",", ".").trim());
    return Number.isFinite(v) ? v : NaN;
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function normalizeLine(s){
    return String(s||"")
      .replace(/[•·]/g," ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function normalizeForMatch(s){
    return String(s||"")
      .toUpperCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^A-Z0-9\s]/g," ")
      .replace(/\s+/g," ")
      .trim();
  }

  function mapToCatalogProduct(line){
    const l = normalizeForMatch(line);
    for(const p of PRODUCT_CATALOG){
      for(const rx of p.aliases){
        if(rx.test(l)) return p.key;
      }
    }
    return null;
  }

  function isBoxProduct(productKey){
    return /^Caja\b/i.test(productKey) || /Washington|National|Canadian/i.test(productKey);
  }

  /* ✅ Vista filtrada: solo números con parte entera <= 2 dígitos */
  function filterSmallNumbersOnly(text){
    const tokens = String(text || "")
      .replace(/\r/g, "")
      .split(/\s+/)
      .filter(Boolean);

    const keep = [];
    for(const t of tokens){
      const s = t.replace(/,/g, "");
      const m = s.match(/^(\d{1,6})(?:\.(\d{1,6}))?$/);
      if(!m) continue;
      const intPart = m[1];
      if(intPart.length > 2) continue;
      keep.push(s);
    }
    return keep.join("\n");
  }

  /* ✅ SIEMPRE parsea con OCR COMPLETO si existe */
  function getTicketTextForParsing(){
    return (rawOcrText && rawOcrText.trim()) ? rawOcrText : ($("ticketText").value || "");
  }

  /* ===== PARSER (robusto) ===== */
  function parseTicketText(raw){
    const text = String(raw || "").replace(/\r/g, "");
    const lines = text.split("\n").map(l=>l.trim()).filter(Boolean);

    const stripLongCodes = (s)=> String(s||"").replace(/\b\d{6,}\b/g, " ");

    function extractNumbers(line){
      const cleaned = String(line||"")
        .replace(/,/g,"")
        .replace(/[^\d.\s]/g," ");
      return cleaned
        .split(/\s+/).filter(Boolean)
        .map(x=>Number(x))
        .filter(n=>Number.isFinite(n) && n > 0);
    }

    function pickCantidadForProduct(productKey, nums){
      if(!nums || !nums.length) return null;
      if(isBoxProduct(productKey)){
        const ints = nums.filter(n=>n <= MAX_BOXES_ALLOWED && Math.abs(n - Math.round(n)) < 1e-6);
        if(ints.length) return ints[0];
        const any = nums.find(n=>n <= MAX_BOXES_ALLOWED);
        return any ?? null;
      }else{
        const any = nums.find(n=>n <= MAX_KG_LINE);
        return any ?? null;
      }
    }

    const out = [];

    // A) Formato ideal: PRODUCTO / CODIGO / NUMS
    const isNumericCodeLine = (s)=>/^\d{6,}$/.test(String(s||"").replace(/\s/g,""));
    for(let i=0;i<lines.length;i++){
      const productoLine = lines[i];
      const codeLine = lines[i+1] || "";
      const numsLine = lines[i+2] || "";

      if(!isNumericCodeLine(codeLine)) continue;

      const mapped = mapToCatalogProduct(productoLine);
      if(!mapped){ i += 2; continue; }

      const nums = extractNumbers(numsLine);
      const cantidad = pickCantidadForProduct(mapped, nums);
      if(!cantidad){ i += 2; continue; }

      if(isBoxProduct(mapped)) out.push({ producto: mapped, kg: cantidad * KG_PER_BOX });
      else out.push({ producto: mapped, kg: cantidad });

      i += 2;
    }

    // B) OCR aplanado: PRODUCTO + ... + cantidad en la misma línea
    for(const line of lines){
      const mapped = mapToCatalogProduct(line);
      if(!mapped) continue;

      const lineNoCodes = stripLongCodes(line);
      const nums = extractNumbers(lineNoCodes);
      const cantidad = pickCantidadForProduct(mapped, nums);
      if(!cantidad) continue;

      if(isBoxProduct(mapped)) out.push({ producto: mapped, kg: cantidad * KG_PER_BOX });
      else out.push({ producto: mapped, kg: cantidad });
    }

    // Agrupar por producto
    const map = new Map();
    for(const it of out){
      const key = it.producto.toLowerCase();
      map.set(key, (map.get(key)||0) + it.kg);
    }

    return [...map.entries()]
      .map(([k,kg])=>({ producto: k.charAt(0).toUpperCase()+k.slice(1), kg: Number(kg) }))
      .sort((a,b)=>b.kg-a.kg);
  }

  function calcTotalKg(items){
    return items.reduce((acc,it)=>acc + (Number(it.kg)||0), 0);
  }

  function renderDetalleEditable(){
    const box = $("detalleBox");
    if(!ticketItems.length){
      box.className = "muted";
      box.textContent = "—";
      return;
    }

    const rows = ticketItems.map((it, idx)=>`
      <tr>
        <td style="width:65%">
          <input data-idx="${idx}" data-field="producto" value="${escapeHtml(it.producto)}" />
        </td>
        <td style="width:25%">
          <input data-idx="${idx}" data-field="kg" inputmode="decimal" value="${Number(it.kg).toFixed(3)}" />
        </td>
        <td class="right" style="width:10%">
          <button class="ghost" data-del="${idx}" style="margin:0;padding:8px;border-radius:10px">X</button>
        </td>
      </tr>
    `).join("");

    box.className = "";
    box.innerHTML = `
      <div class="mini">Puedes corregir nombres y kilos antes de guardar.</div>
      <table>
        <thead><tr><th>Producto</th><th>Kg</th><th class="right">Del</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="row" style="margin-top:10px">
        <button id="btnAgregarLinea" class="ghost">+ Agregar línea</button>
      </div>
    `;

    box.querySelectorAll('input[data-idx]').forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const idx = Number(inp.getAttribute("data-idx"));
        const field = inp.getAttribute("data-field");
        if(!ticketItems[idx]) return;

        if(field === "kg"){
          const v = toNum(inp.value);
          ticketItems[idx].kg = Number.isFinite(v) ? v : 0;
        }else{
          ticketItems[idx].producto = normalizeLine(inp.value);
        }
        $("kgAuto").value = calcTotalKg(ticketItems).toFixed(2);
      });
    });

    box.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const idx = Number(btn.getAttribute("data-del"));
        ticketItems.splice(idx, 1);
        $("kgAuto").value = calcTotalKg(ticketItems).toFixed(2);
        renderDetalleEditable();
      });
    });

    const addBtn = $("btnAgregarLinea");
    if(addBtn){
      addBtn.addEventListener("click", ()=>{
        ticketItems.push({ producto:"Producto", kg:0 });
        renderDetalleEditable();
      });
    }
  }

  /* ===== Teléfonos guardados ===== */
  async function cargarTelefonosGuardados(){
    if(!sb) return;
    const { data, error } = await sb.from(T_CLIENTES).select("telefono,nombre").order("telefono",{ascending:true});
    if(error){ console.error(error); return; }

    const dl = $("telList");
    dl.innerHTML = "";
    (data || []).forEach(row=>{
      const opt = document.createElement("option");
      opt.value = row.telefono || "";
      opt.label = (row.nombre ? `${row.telefono} — ${row.nombre}` : row.telefono);
      dl.appendChild(opt);
    });
  }

  async function onTelefonoInputAutofill(){
    const tel = cleanPhone($("tel").value);
    if(tel.length !== 10) return;
    try{
      const { data, error } = await sb
        .from(T_CLIENTES)
        .select("id,telefono,nombre,puntos,saldo_kg")
        .eq("telefono", tel)
        .maybeSingle();
      if(error) throw error;
      if(data){
        $("nombre").value = data.nombre || "";
        currentClient = data;
        renderStatus();
        await renderQR();
        setMsg("ok", "Cliente encontrado ✅");
      }
    }catch(e){ console.error(e); }
  }

  async function buscarClientePorTelefono(){
    if(!sb) throw new Error("Supabase no cargó. Revisa internet o CDN.");
    const tel = cleanPhone($("tel").value);
    if(tel.length !== 10) throw new Error("Teléfono inválido (deben ser 10 dígitos).");

    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .eq("telefono", tel)
      .maybeSingle();

    if(error) throw error;

    currentClient = data || null;
    if(data) $("nombre").value = data.nombre || "";
    renderStatus();
    await renderQR();

    setMsg(data ? "ok" : "muted", data ? "Cliente encontrado." : "No existe: crea el cliente.");
  }

  async function crearOActualizarCliente(){
    if(!sb) throw new Error("Supabase no cargó. Revisa internet o CDN.");

    const tel = cleanPhone($("tel").value);
    const nombre = ($("nombre").value || "").trim() || null;
    if(tel.length !== 10) throw new Error("Teléfono inválido (deben ser 10 dígitos).");

    const payload = { telefono: tel };
    if(nombre) payload.nombre = nombre;

    const { data, error } = await sb
      .from(T_CLIENTES)
      .upsert(payload, { onConflict: "telefono" })
      .select("id,telefono,nombre,puntos,saldo_kg")
      .single();

    if(error) throw error;

    currentClient = data;
    renderStatus();
    await renderQR();

    setMsg("ok", "Cliente creado/actualizado y QR generado.");
    await cargarTelefonosGuardados();
  }

  /* ===== Procesar ticket ===== */
  function procesarTicket(){
    const raw = getTicketTextForParsing();
    const items = parseTicketText(raw);

    ticketItems = items;
    const total = calcTotalKg(ticketItems);

    $("kgAuto").value = Number.isFinite(total) ? total.toFixed(2) : "";
    renderDetalleEditable();

    if(!items.length){
      setLog("err", "No pude detectar productos. Abre 'Ver OCR completo' y confirma si aparecen palabras como BOFE, LIBRO, PANZA...");
    }else{
      setLog("ok", `Ticket procesado. Líneas detectadas: ${items.length}. Total kg: ${total.toFixed(2)}.`);
    }
  }

  function limpiarTicket(){
    $("ticketText").value = "";
    $("kgAuto").value = "";
    ticketItems = [];
    rawOcrText = "";
    filteredOcrView = "";
    $("rawPre").textContent = "";
    $("rawBox").style.display = "none";
    renderDetalleEditable();
    setLog("muted","Listo.");
  }

  /* ===== Guardar venta + detalle + puntos ===== */
  async function guardarVentaDesdeTicket(){
    if(!sb) throw new Error("Supabase no cargó. Revisa internet o CDN.");
    if(!currentClient) throw new Error("Primero crea/selecciona un cliente.");

    const tipo = $("tipo").value;
    const rawTicket = getTicketTextForParsing().trim();

    const kg = toNum($("kgAuto").value);
    if(!Number.isFinite(kg) || kg <= 0) throw new Error("Total kg inválido.");

    const items = (ticketItems || [])
      .map(it=>({ producto: normalizeLine(it.producto), kg: Number(it.kg) }))
      .filter(it=>it.producto && Number.isFinite(it.kg) && it.kg > 0);

    const ventaInsert = {
      tipo,
      cliente_id: currentClient.id,
      total_kg: kg,
      puntos_otorgados: 0,
      raw_ticket: rawTicket || null,
      captura: "ticket_ocr"
    };

    const { data: venta, error: e1 } = await sb
      .from(T_VENTAS)
      .insert(ventaInsert)
      .select("id,tipo,total_kg,puntos_otorgados")
      .single();

    if(e1) throw e1;

    if(items.length){
      const payloadItems = items.map(it=>({ venta_id: venta.id, producto: it.producto, kg: it.kg }));
      const { error: e2 } = await sb.from(T_ITEMS).insert(payloadItems);
      if(e2) throw e2;
    }

    let puntosGanados = 0;
    let nuevoSaldo = Number(currentClient.saldo_kg);

    if(tipo === "mostrador"){
      const acumulado = Number(currentClient.saldo_kg) + kg;
      puntosGanados = Math.floor(acumulado / 100);
      nuevoSaldo = acumulado % 100;

      const { data: cli2, error: e3 } = await sb
        .from(T_CLIENTES)
        .update({ puntos: currentClient.puntos + puntosGanados, saldo_kg: nuevoSaldo })
        .eq("id", currentClient.id)
        .select("id,telefono,nombre,puntos,saldo_kg")
        .single();

      if(e3) throw e3;
      currentClient = cli2;

      const { error: e4 } = await sb.from(T_VENTAS).update({ puntos_otorgados: puntosGanados }).eq("id", venta.id);
      if(e4) throw e4;
    }

    renderStatus();
    setLog("ok",
      `✅ Venta guardada.
Cliente: ${currentClient.nombre || currentClient.telefono}
Tipo: ${tipo}
Total kg: ${kg.toFixed(2)}
Puntos ganados: ${puntosGanados}
Items guardados: ${items.length}
Venta ID: ${venta.id}`
    );

    limpiarTicket();
  }

  /* ===== OCR ===== */
  function setOcrUI(status, progress){
    const st = $("ocrStatus");
    if(st) st.textContent = status || "—";
    const p = Math.max(0, Math.min(1, Number(progress||0)));
    $("ocrBar").style.width = (p*100).toFixed(0) + "%";
  }

  function preprocessCanvasForOCR(){
    // mejora contraste para texto
    const canvas = $("canvas");
    const ctx = canvas.getContext("2d");
    const img = ctx.getImageData(0,0,canvas.width,canvas.height);
    const d = img.data;

    // gris + threshold suave
    for(let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      let v = (r*0.299 + g*0.587 + b*0.114);
      // contraste
      v = (v - 128) * 1.25 + 128;
      // binariza suave
      const t = v > 160 ? 255 : 0;
      d[i]=d[i+1]=d[i+2]=t;
    }
    ctx.putImageData(img,0,0);
  }

  async function runOCRFromCanvas(){
    if(typeof Tesseract === "undefined") throw new Error("OCR no cargó (Tesseract). Revisa internet/CDN.");

    setOcrUI("Leyendo ticket... (OCR)", 0.02);

    // ✅ preprocesa para que agarre letras
    preprocessCanvasForOCR();

    const canvas = $("canvas");

    const { data: { text } } = await Tesseract.recognize(
      canvas,
      "spa",
      {
        logger: (m)=>{
          if(m && m.status){
            const prog = (typeof m.progress === "number") ? m.progress : 0;
            setOcrUI(`OCR: ${m.status} ${(prog*100).toFixed(0)}%`, prog);
          }
        },
        // ✅ configura para tickets
        tessedit_pageseg_mode: 6,
        tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzÁÉÍÓÚÜÑáéíóúüñ0123456789.,:/-() "
      }
    );

    const cleaned = (text || "")
      .replace(/\r/g, "")
      .replace(/[ \t]+\n/g, "\n")
      .trim();

    rawOcrText = cleaned; // ✅ AQUÍ vive el texto completo

    filteredOcrView = filterSmallNumbersOnly(cleaned);
    $("ticketText").value = filteredOcrView || cleaned;

    setOcrUI("OCR terminado ✅", 1);

    // muestra raw en debug
    $("rawPre").textContent = rawOcrText || "(vacío)";
    $("rawBox").style.display = rawOcrText ? "block" : "none";

    try { procesarTicket(); } catch(e){ console.error(e); }
  }

  async function runOCRFromFile(file){
    const img = await fileToImage(file);
    drawToCanvas(img);
    await runOCRFromCanvas();
  }

  function fileToImage(file){
    return new Promise((resolve,reject)=>{
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = ()=>{ URL.revokeObjectURL(url); resolve(img); };
      img.onerror = (e)=>{ URL.revokeObjectURL(url); reject(e); };
      img.src = url;
    });
  }

  function drawToCanvas(img){
    const canvas = $("canvas");
    const ctx = canvas.getContext("2d");

    const maxW = 1600; // un poco más para letras
    const scale = Math.min(1, maxW / img.width);
    const w = Math.round(img.width * scale);
    const h = Math.round(img.height * scale);

    canvas.width = w;
    canvas.height = h;
    ctx.drawImage(img, 0, 0, w, h);
  }

  async function startCamera(){
    if(!navigator.mediaDevices?.getUserMedia) throw new Error("Este navegador no soporta cámara por web.");

    $("camWrap").style.display = "grid";
    $("btnStartCam").disabled = true;
    $("btnStopCam").disabled = false;

    const video = $("video");
    camStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } },
      audio: false
    });
    video.srcObject = camStream;
    await video.play();
    setOcrUI("Cámara lista. Pon el ticket centrado y toma la foto.", 0);
  }

  function stopCamera(){
    try{ if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream = null; } }catch(_){}
    $("video").srcObject = null;
    $("camWrap").style.display = "none";
    $("btnStartCam").disabled = false;
    $("btnStopCam").disabled = true;
    setOcrUI("—", 0);
  }

  function snapToCanvas(){
    const video = $("video");
    const canvas = $("canvas");
    const ctx = canvas.getContext("2d");

    const w = video.videoWidth || 1280;
    const h = video.videoHeight || 720;

    const maxW = 1600;
    const scale = Math.min(1, maxW / w);
    canvas.width = Math.round(w * scale);
    canvas.height = Math.round(h * scale);
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  }

  function diag(){
    const d = [];
    d.push("Supabase cargado: " + (!!sb));
    d.push("OCR cargado: " + (typeof Tesseract !== "undefined"));
    d.push("Base URL del sitio: " + siteBaseUrl());
    d.push("HTTPS recomendado para cámara.");
    $("diag").textContent = d.join("\n");
  }

  async function cargarClientePorQuery(){
    const u = new URL(window.location.href);
    const cid = u.searchParams.get("cid");
    if(!cid || !sb) return;

    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .eq("id", cid)
      .maybeSingle();

    if(error){
      console.error(error);
      setMsg("err", "Error cargando cliente por QR: " + formatErr(error));
      return;
    }
    if(!data){
      setMsg("err", "Este QR no encontró cliente (cid no existe).");
      return;
    }
    currentClient = data;
    $("tel").value = data.telefono || "";
    $("nombre").value = data.nombre || "";
    renderStatus();
    await renderQR();
    setMsg("ok", "Cliente cargado desde QR.");
  }

  /* ===== Listeners ===== */
  $("btnBuscar").addEventListener("click", async ()=>{
    setMsg("muted","Buscando...");
    try{ await buscarClientePorTelefono(); }
    catch(err){ console.error(err); setMsg("err", formatErr(err)); }
  });

  $("btnCrear").addEventListener("click", async ()=>{
    setMsg("muted","Guardando...");
    try{ await crearOActualizarCliente(); }
    catch(err){ console.error(err); setMsg("err", formatErr(err)); }
  });

  $("btnProcesar").addEventListener("click", ()=>{
    try{ procesarTicket(); }
    catch(err){ console.error(err); setLog("err", formatErr(err)); }
  });

  $("btnLimpiar").addEventListener("click", ()=> limpiarTicket());

  $("btnGuardar").addEventListener("click", async ()=>{
    setLog("muted","Guardando venta...");
    try{ await guardarVentaDesdeTicket(); }
    catch(err){ console.error(err); setLog("err", formatErr(err)); }
  });

  $("btnStartCam").addEventListener("click", async ()=>{
    try{ await startCamera(); }
    catch(err){ console.error(err); setLog("err", "No pude abrir cámara: " + formatErr(err)); stopCamera(); }
  });

  $("btnStopCam").addEventListener("click", ()=> stopCamera());

  $("btnSnap").addEventListener("click", async ()=>{
    try{
      if(!camStream) throw new Error("Cámara no está encendida.");
      setLog("muted","Tomando foto...");
      snapToCanvas();
      await runOCRFromCanvas();
    }catch(err){
      console.error(err);
      setLog("err", "OCR falló: " + formatErr(err));
    }
  });

  $("fileTicket").addEventListener("change", async (e)=>{
    try{
      const f = e.target.files?.[0];
      if(!f) return;
      setLog("muted","Leyendo foto (OCR)...");
      await runOCRFromFile(f);
    }catch(err){
      console.error(err);
      setLog("err", "OCR falló: " + formatErr(err));
    }finally{
      e.target.value = "";
    }
  });

  $("btnReloadPhones").addEventListener("click", async ()=>{
    try{
      setMsg("muted","Recargando teléfonos...");
      await cargarTelefonosGuardados();
      setMsg("ok","Teléfonos actualizados ✅");
    }catch(err){
      console.error(err);
      setMsg("err", "No pude recargar: " + formatErr(err));
    }
  });

  $("tel").addEventListener("input", ()=> Promise.resolve().then(()=>onTelefonoInputAutofill()));

  $("btnVerOCR").addEventListener("click", ()=>{
    $("rawPre").textContent = rawOcrText || "(vacío)";
    $("rawBox").style.display = rawOcrText ? "block" : "block";
    $("rawBox").open = true;
  });

  window.addEventListener("beforeunload", stopCamera);
  document.addEventListener("visibilitychange", ()=>{ if(document.hidden) stopCamera(); });

  diag();
  renderStatus();
  renderDetalleEditable();
  cargarClientePorQuery();
  cargarTelefonosGuardados();
</script>
</body>
</html>
