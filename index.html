
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>VDC360¬∞ ‚Äî Cliente (QR) + Ticket (QR) + Inventario</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root{
      --brand:#22c55e;
      --bg:#0b1220;
      --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.10);
      --ink:#e5e7eb;
      --muted:rgba(229,231,235,.75);
      --warn:#f59e0b;
      --bad:#fb7185;
      --shadow:0 18px 50px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    header{padding:14px 16px;background:#111827;border-bottom:1px solid rgba(255,255,255,.08);font-weight:1100}
    .wrap{max-width:1000px;margin:0 auto;padding:14px 16px;display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:14px;box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:820px){.grid{grid-template-columns:1fr}}
    label{display:block;font-weight:900;margin-top:10px}
    input,select,textarea,button{width:100%;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.15);color:var(--ink);font-size:16px}
    textarea{min-height:120px;resize:vertical}
    button{border:0;background:#60a5fa;color:#071a2f;font-weight:1100;cursor:pointer}
    button.secondary{background:#111;color:#fff;border:1px solid rgba(255,255,255,.12)}
    button.warn{background:var(--warn);color:#1f1300}
    button.ok{background:var(--brand);color:#052e16}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    .muted{color:var(--muted);font-size:12px}
    .log{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;opacity:.95}
    .okTxt{color:var(--brand)} .badTxt{color:var(--bad)} .warnTxt{color:var(--warn)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);font-weight:1100;font-size:12px}
    .pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    /* QR cliente */
    #qrClienteBox{
      display:grid;place-items:center;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:16px;
      min-height:240px;
      margin-top:10px;
      padding:12px;
    }
    #qrClienteBox img{width:220px;height:220px;border-radius:12px;background:#fff}
    code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:10px;border:1px solid rgba(255,255,255,.08)}

    /* Totales bonitos */
    .totals{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    .bigTotal{
      background:rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.25);
      border-radius:18px;
      padding:14px;
      text-align:center;
    }
    .bigTotal .t1{opacity:.85;font-weight:1100}
    .bigTotal .t2{font-size:44px;line-height:1;margin-top:8px;font-weight:1200;color:var(--brand)}
    .bigTotal .t3{opacity:.85;font-weight:1100;margin-top:6px}
    .miniGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .miniGrid{grid-template-columns:1fr;} }
    .miniCard{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
    }
    .miniCard b{display:block;font-size:12px;opacity:.85}
    .miniCard .val{font-size:20px;font-weight:1200;margin-top:6px}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid rgba(255,255,255,.10);padding:8px;text-align:left;vertical-align:top}
    th{background:rgba(255,255,255,.06)}
    .right{text-align:right}

    input[type="file"]{display:none}
  </style>
</head>

<body>
<header>VDC360¬∞ ‚Äî QR Cliente + QR Ticket (Guardar compra + Inventario)</header>

<div class="wrap">

  <!-- 1) Cliente -->
  <section class="card">
    <h3 style="margin:0 0 6px">1) Cliente (QR √∫nico por cliente)</h3>

    <div class="grid">
      <div>
        <label>Nombre</label>
        <input id="nombre" placeholder="Ej. Taquer√≠a Don Chuy" list="nombreList" />
        <datalist id="nombreList"></datalist>
        <div class="muted">Tip: escribe y selecciona del autocompletado.</div>
      </div>
      <div>
        <label>Tel√©fono</label>
        <input id="tel" inputmode="numeric" placeholder="4621234567" />
        <div class="muted">Se autocompleta si eliges cliente existente.</div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnBuscar">Buscar</button>
      <button id="btnCrear" class="secondary">Crear / Actualizar</button>
      <button id="btnReloadNames" class="secondary" type="button">‚Üª Recargar</button>
    </div>

    <div class="pills">
      <span class="pill" id="stCliente">Cliente: ‚Äî</span>
      <span class="pill" id="stPuntos">Puntos: ‚Äî</span>
      <span class="pill" id="stSaldo">Saldo kg: ‚Äî</span>
    </div>

    <div id="msg" class="muted" style="margin-top:10px">‚Äî</div>

    <!-- ‚úÖ QR DEL CLIENTE -->
    <div class="grid" style="margin-top:12px">
      <div>
        <div class="muted">Este QR es √∫nico por cliente: abre esta p√°gina con <code>?cid=</code> y lo carga autom√°tico.</div>
        <div id="qrClienteBox"><span class="muted">Selecciona un cliente para generar el QR</span></div>
        <div class="muted" id="qrClienteText" style="margin-top:10px"></div>
      </div>
      <div>
        <div class="muted">
          Uso recomendado:
          <ul>
            <li>Impr√≠melo y p√©galo en la libreta del cliente</li>
            <li>O gu√°rdalo en WhatsApp del cliente como ‚ÄúMi QR VDC‚Äù</li>
          </ul>
        </div>
        <div class="row">
          <button id="btnCopiarUrl" class="secondary" type="button">Copiar URL del QR</button>
          <button id="btnAbrirUrl" class="secondary" type="button">Abrir URL</button>
        </div>
      </div>
    </div>
  </section>

  <!-- 2) Esc√°ner QR Ticket -->
  <section class="card">
    <h3 style="margin:0 0 6px">2) Escanear QR del Ticket (productos/kg)</h3>
    <div class="muted">Requisito: selecciona un cliente antes de escanear.</div>

    <div id="reader" style="width:100%;margin-top:10px"></div>

    <div class="muted" style="margin-top:10px">
      Si el QR est√° pesado y no lo lee en vivo, usa <b>Subir foto</b> (modo seguro).
    </div>

    <div class="row" style="margin-top:10px">
      <button class="secondary" id="toggle">Iniciar c√°mara</button>
      <button class="warn" id="switchCam" style="display:none">Cambiar c√°mara</button>
    </div>

    <label class="ok" for="filePick" style="margin-top:10px;display:block;text-align:center;cursor:pointer">
      üì∏ Subir foto del QR (modo seguro)
    </label>
    <input id="filePick" type="file" accept="image/*" capture="environment">

    <label style="margin-top:10px">Contenido del QR (debug)</label>
    <textarea id="qrPayload" placeholder='Aqu√≠ se pega / aparecer√° lo escaneado...'></textarea>

    <!-- Totales -->
    <div class="totals">
      <div class="bigTotal">
        <div class="t1">TOTAL KG DEL TICKET</div>
        <div class="t2" id="totalKg">0.00</div>
        <div class="t3">kg</div>
      </div>

      <div class="miniGrid">
        <div class="miniCard">
          <b># Productos (l√≠neas)</b>
          <div class="val" id="countLines">0</div>
        </div>
        <div class="miniCard">
          <b>Ticket (fingerprint)</b>
          <div class="val" id="fpShort">‚Äî</div>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div>
        <label>Tipo de venta</label>
        <select id="tipo">
          <option value="mostrador">mostrador (S√ç puntos)</option>
          <option value="credito">cr√©dito (NO puntos)</option>
        </select>
        <div class="muted">Para puntos: solo mostrador.</div>
      </div>
      <div>
        <label>Total kg (editable)</label>
        <input id="kgAuto" inputmode="decimal" placeholder="0.00" />
        <div class="muted">Se llena autom√°tico; puedes corregir.</div>
      </div>
    </div>

    <div id="detalleBox" class="muted" style="margin-top:10px">‚Äî</div>

    <div class="row" style="margin-top:10px">
      <button id="btnProcesarPegado" class="warn" type="button">Procesar QR pegado</button>
      <button id="btnLimpiar" class="secondary" type="button">Limpiar</button>
    </div>
  </section>

  <!-- 3) Log -->
  <section class="card">
    <div class="muted">Resultado:</div>
    <div id="out" class="log">Listo.</div>
  </section>

</div>

<script>
  // =========================
  // === Credenciales ===
  // =========================
  const SUPABASE_URL = "https://eqynjddcosvdqjzztznn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeW5qZGRjb3N2ZHFqenp0em5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMzYwMzIsImV4cCI6MjA3MTcxMjAzMn0.Q51wsGelUvxRfqsMYRY5JduCGyZ7s6AzOhqsRf3kOhk";
  const sb = window.sb || (window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY));

  // =========================
  // === Tablas clientes/ventas ===
  // =========================
  const T_CLIENTES = "clientes";
  const T_VENTAS   = "ventas";
  const T_ITEMS    = "ventas_items";

  // =========================
  // === UI refs ===
  // =========================
  const $ = (id)=>document.getElementById(id);

  const out = $("out");
  const toggleBtn = $("toggle");
  const switchBtn = $("switchCam");
  const filePick = $("filePick");

  const totalKgEl = $("totalKg");
  const countLinesEl = $("countLines");
  const fpShortEl = $("fpShort");

  // =========================
  // === Estado ===
  // =========================
  let currentClient = null;
  let clientsCache = [];

  let scanner = null;
  let running = false;
  let cameras = [];
  let camIndex = 0;

  // anti spam
  let busy = false;
  const BUSY_COOLDOWN_MS = 900;

  // items actuales
  let ticketItemsUi = [];      // [{producto, sku, kg, _kgTotal}]
  let ticketItemsInv = [];     // [{sku, kg}]
  let lastClientQrUrl = "";

  // =========================
  // ‚úÖ REGLAS CAJAS COMPLETAS
  // =========================
  const BOX_FULL_KG = 27.22;

  function normalizeLine(s){ return String(s||"").replace(/\s+/g," ").trim(); }
  function toNum(s){
    const v = Number(String(s ?? "").replace(",", ".").trim());
    return Number.isFinite(v) ? v : NaN;
  }
  function cleanPhone(s){ return String(s||"").replace(/\D/g,"").slice(-10); }
  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function log(txt, cls=""){ out.innerHTML = cls ? `<span class="${cls}">${txt}</span>` : txt; }
  function setMsg(type, text){
    const el = $("msg");
    el.className = type === "badTxt" ? "badTxt" : (type==="okTxt" ? "okTxt" : "muted");
    el.textContent = text;
  }
  function renderStatus(){
    $("stCliente").textContent = "Cliente: " + (currentClient ? (currentClient.nombre || currentClient.telefono) : "‚Äî");
    $("stPuntos").textContent  = "Puntos: " + (currentClient ? currentClient.puntos : "‚Äî");
    $("stSaldo").textContent   = "Saldo kg: " + (currentClient ? Number(currentClient.saldo_kg||0).toFixed(3) : "‚Äî");
  }

  // =========================
  // ‚úÖ URL base (para QR cliente)
  // =========================
  function siteBaseUrl(){
    const u = new URL(window.location.href);
    // deja el mismo archivo, solo quitamos query/hash
    return u.origin + u.pathname;
  }

  async function renderClientQR(){
    const box = $("qrClienteBox");
    const txt = $("qrClienteText");
    box.innerHTML = "";
    txt.textContent = "";

    if(!currentClient?.id){
      box.innerHTML = `<span class="muted">Selecciona un cliente para generar el QR</span>`;
      lastClientQrUrl = "";
      return;
    }

    const url = `${siteBaseUrl()}?cid=${encodeURIComponent(currentClient.id)}`;
    lastClientQrUrl = url;

    const img = document.createElement("img");
    img.alt = "QR del cliente";
    img.src = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(url)}`;
    box.appendChild(img);

    txt.innerHTML = `URL en QR: <code>${url}</code>`;
  }

  $("btnCopiarUrl").addEventListener("click", async ()=>{
    if(!lastClientQrUrl) return setMsg("badTxt","No hay URL. Selecciona cliente primero.");
    try{
      await navigator.clipboard.writeText(lastClientQrUrl);
      setMsg("okTxt","URL copiada ‚úÖ");
    }catch{
      setMsg("badTxt","No pude copiar (permiso del navegador).");
    }
  });

  $("btnAbrirUrl").addEventListener("click", ()=>{
    if(!lastClientQrUrl) return setMsg("badTxt","No hay URL. Selecciona cliente primero.");
    window.open(lastClientQrUrl, "_blank");
  });

  // =========================
  // ‚úÖ CANONIZADOR SKU (tu versi√≥n)
  // =========================
  function canonSku(productoOriginal){
    let t = String(productoOriginal || "")
      .trim()
      .toUpperCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "");

    if(/PATA[\s_-]*MORENA/.test(t)) return "PATA_MORENA";
    if(/^CAJA\s+AZUL\b/.test(t) || t.includes("CAJA AZUL")) return "CAJA_MENUDO_NATIONAL";
    if(/^CAJA\s+CANADIAN\b/.test(t) || t.includes("CAJA CANADIAN")) return "MENUDO_CANADIAN";
    if(t.includes("NATIONAL")) return "CAJA_MENUDO_NATIONAL";

    return t.replace(/\s+/g, "_");
  }

  function applyBoxRules(productoOriginal, qty){
    const name = String(productoOriginal || "").toUpperCase();
    const q = Number(qty);

    const isCajaCompleta =
      name.includes("CAJA") &&
      name.includes("COMPLETA") &&
      Number.isFinite(q) &&
      Math.abs(q - 1) < 1e-9;

    let kgForInv = Number.isFinite(q) ? q : 0;
    let kgForTotal = kgForInv;

    if(isCajaCompleta){
      if(name.includes("AZUL") || name.includes("CANADIAN") || name.includes("NATIONAL")){
        kgForInv = BOX_FULL_KG;
        kgForTotal = 0;
      }
    }
    return { kgForInv, kgForTotal };
  }

  function hashQr(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return "QR_" + (h >>> 0).toString(16);
  }

  function safeParseJson(text){
    return JSON.parse((text||"").trim());
  }

  function normalizePayload(raw, decodedText){
    if(Array.isArray(raw)){
      const itemsUi = raw.map(x => {
        const producto = String(x.producto || x.sku || "").trim();
        const qty = Number(x.cantidad ?? x.kg ?? 0);
        const sku = canonSku(producto);
        const { kgForInv, kgForTotal } = applyBoxRules(producto, qty);
        return { producto: producto || sku, sku, kg: kgForInv, _kgTotal: kgForTotal };
      }).filter(it => it.sku && Number.isFinite(it.kg));

      const itemsForRpc = itemsUi.map(({sku, kg}) => ({ sku, kg }));
      return { qr_id: hashQr(decodedText), items: itemsForRpc, _itemsUi: itemsUi };
    }

    if(raw && typeof raw === "object"){
      let items = raw.items;
      if(!Array.isArray(items) && Array.isArray(raw.productos)) items = raw.productos;

      const itemsUi = (items || []).map(x => {
        const producto = String(x.sku || x.producto || "").trim();
        const qty = Number(x.kg ?? x.cantidad ?? 0);
        const sku = canonSku(producto);
        const { kgForInv, kgForTotal } = applyBoxRules(producto, qty);
        return { producto: producto || sku, sku, kg: kgForInv, _kgTotal: kgForTotal };
      }).filter(it => it.sku && Number.isFinite(it.kg));

      const itemsForRpc = itemsUi.map(({sku, kg}) => ({ sku, kg }));
      return { qr_id: String(raw.qr_id || hashQr(decodedText)), items: itemsForRpc, _itemsUi: itemsUi };
    }
    return null;
  }

  function calcTotalKgVisual(itemsUi){
    let sum = 0;
    for(const it of (itemsUi||[])){
      const k = Number(it._kgTotal ?? it.kg);
      if(Number.isFinite(k)) sum += k;
    }
    return sum;
  }

  function updateTotalsUI(payload, fingerprint){
    const itemsUi = payload._itemsUi || [];
    const totalKg = calcTotalKgVisual(itemsUi);
    totalKgEl.textContent = totalKg.toFixed(2);
    countLinesEl.textContent = String((payload.items || []).length || 0);
    fpShortEl.textContent = fingerprint ? fingerprint.slice(0, 10) : "‚Äî";
    $("kgAuto").value = totalKg.toFixed(2);
  }

  function renderDetalleEditable(){
    const box = $("detalleBox");
    if(!ticketItemsUi.length){
      box.className = "muted";
      box.textContent = "‚Äî";
      return;
    }
    const rows = ticketItemsUi.map((it, idx)=>`
      <tr>
        <td style="width:55%">
          <input data-idx="${idx}" data-field="producto" value="${escapeHtml(it.producto)}" />
          <div class="muted">sku: ${escapeHtml(it.sku)}</div>
        </td>
        <td style="width:25%">
          <input data-idx="${idx}" data-field="kg" inputmode="decimal" value="${Number(it.kg).toFixed(3)}" />
          <div class="muted">total: ${Number(it._kgTotal ?? it.kg).toFixed(3)}</div>
        </td>
        <td class="right" style="width:20%">
          <button class="secondary" data-del="${idx}" style="margin:0;padding:10px;border-radius:12px">X</button>
        </td>
      </tr>
    `).join("");

    box.className = "";
    box.innerHTML = `
      <div class="muted">Puedes corregir antes de guardar (afecta venta + inventario).</div>
      <table>
        <thead><tr><th>Producto</th><th>Kg</th><th class="right">Del</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;

    box.querySelectorAll('input[data-idx]').forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const idx = Number(inp.getAttribute("data-idx"));
        const field = inp.getAttribute("data-field");
        if(!ticketItemsUi[idx]) return;

        if(field === "kg"){
          const v = toNum(inp.value);
          ticketItemsUi[idx].kg = Number.isFinite(v) ? v : 0;
          ticketItemsUi[idx]._kgTotal = ticketItemsUi[idx].kg;
        }else{
          ticketItemsUi[idx].producto = normalizeLine(inp.value);
          ticketItemsUi[idx].sku = canonSku(ticketItemsUi[idx].producto);
        }

        ticketItemsInv = ticketItemsUi.map(it=>({ sku: it.sku, kg: Number(it.kg)||0 }))
          .filter(it=>it.sku && Number.isFinite(it.kg) && it.kg>0);

        const total = calcTotalKgVisual(ticketItemsUi);
        $("kgAuto").value = total.toFixed(2);
        totalKgEl.textContent = total.toFixed(2);
        countLinesEl.textContent = String(ticketItemsInv.length);
      });
    });

    box.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const idx = Number(btn.getAttribute("data-del"));
        ticketItemsUi.splice(idx, 1);

        ticketItemsInv = ticketItemsUi.map(it=>({ sku: it.sku, kg: Number(it.kg)||0 }))
          .filter(it=>it.sku && Number.isFinite(it.kg) && it.kg>0);

        const total = calcTotalKgVisual(ticketItemsUi);
        $("kgAuto").value = total.toFixed(2);
        totalKgEl.textContent = total.toFixed(2);
        countLinesEl.textContent = String(ticketItemsInv.length);

        renderDetalleEditable();
      });
    });
  }

  // =========================
  // ‚úÖ 1) INVENTARIO: RPC procesar_venta_qr
  // =========================
  async function descontarInventarioConRPC(payload, fingerprint){
    const { data, error } = await sb.rpc('procesar_venta_qr', {
      payload: { qr_id: payload.qr_id, items: payload.items },
      p_fingerprint: fingerprint
    });
    if(error) return { ok:false, error: error.message };
    if(data?.code === 'DUPLICATE') return { ok:false, duplicate:true, data };
    if(!data?.ok) return { ok:false, error: "NO OK:\n" + JSON.stringify(data, null, 2), data };
    return { ok:true, data };
  }

  // =========================
  // ‚úÖ 2) Guardar venta + puntos (clientes/ventas/ventas_items)
  // =========================
  async function guardarVentaClienteDesdeQR(decodedText, fingerprint){
    if(!currentClient) throw new Error("Primero selecciona un cliente.");

    const tipo = $("tipo").value;
    const kg = toNum($("kgAuto").value);
    if(!Number.isFinite(kg) || kg <= 0) throw new Error("Total kg inv√°lido.");

    const items = ticketItemsInv
      .map(it=>({ producto: it.sku, kg: Number(it.kg) }))
      .filter(it=>it.producto && Number.isFinite(it.kg) && it.kg>0);

    const ventaInsert = {
      tipo,
      cliente_id: currentClient.id,
      total_kg: kg,
      puntos_otorgados: 0,
      raw_ticket: decodedText || null,
      captura: "ticket_qr_mostrador",
      fingerprint: fingerprint // si no existe en tabla, har√° fallback
    };

    let venta;
    {
      const { data, error } = await sb
        .from(T_VENTAS)
        .insert(ventaInsert)
        .select("id,tipo,total_kg,puntos_otorgados,created_at")
        .single();

      if(error){
        if((error.message||"").toLowerCase().includes("fingerprint")){
          delete ventaInsert.fingerprint;
          const r2 = await sb.from(T_VENTAS).insert(ventaInsert).select("id,tipo,total_kg,puntos_otorgados,created_at").single();
          if(r2.error) throw r2.error;
          venta = r2.data;
        }else{
          throw error;
        }
      }else{
        venta = data;
      }
    }

    if(items.length){
      const payloadItems = items.map(it=>({ venta_id: venta.id, producto: it.producto, kg: it.kg }));
      const { error: e2 } = await sb.from(T_ITEMS).insert(payloadItems);
      if(e2) throw e2;
    }

    // puntos/saldo (solo mostrador)
    let puntosGanados = 0;
    if(tipo === "mostrador"){
      const acumulado = Number(currentClient.saldo_kg || 0) + kg;
      puntosGanados = Math.floor(acumulado / 100);
      const nuevoSaldo = acumulado % 100;

      const { data: cli2, error: e3 } = await sb
        .from(T_CLIENTES)
        .update({ puntos: Number(currentClient.puntos||0) + puntosGanados, saldo_kg: nuevoSaldo })
        .eq("id", currentClient.id)
        .select("id,telefono,nombre,puntos,saldo_kg")
        .single();
      if(e3) throw e3;
      currentClient = cli2;

      const { error: e4 } = await sb.from(T_VENTAS).update({ puntos_otorgados: puntosGanados }).eq("id", venta.id);
      if(e4) throw e4;
    }

    renderStatus();
    await renderClientQR();
    return { venta_id: venta.id, puntosGanados, itemsCount: items.length };
  }

  // =========================
  // ‚úÖ Pipeline unido
  // =========================
  async function handleDecoded(decodedText){
    if(busy) return;
    busy = true;

    try{
      if(!currentClient){
        log("Selecciona un cliente primero (o abre con ?cid=).", "warnTxt");
        return;
      }

      $("qrPayload").value = decodedText;

      const raw = safeParseJson(decodedText);
      const payload = normalizePayload(raw, decodedText);

      if(!payload?.items?.length){
        log("QR inv√°lido: no pude formar items\n\n" + decodedText, "badTxt");
        return;
      }

      const fingerprint = hashQr(decodedText);

      updateTotalsUI(payload, fingerprint);
      ticketItemsUi = payload._itemsUi || [];
      ticketItemsInv = payload.items || [];
      renderDetalleEditable();

      log("1) Descontando inventario‚Ä¶");

      const invRes = await descontarInventarioConRPC(payload, fingerprint);

      if(invRes.duplicate){
        log("Ticket ya procesado (DUPLICATE). No se descont√≥ otra vez ‚úÖ\n(No se guard√≥ venta cliente para evitar duplicado)", "okTxt");
        return;
      }
      if(!invRes.ok){
        log("ERROR INVENTARIO:\n" + (invRes.error || "‚Äî"), "badTxt");
        return;
      }

      log("2) Guardando venta del cliente‚Ä¶");

      const saveRes = await guardarVentaClienteDesdeQR(decodedText, fingerprint);

      log(
        "‚úÖ LISTO\n" +
        "Inventario: descontado ‚úÖ\n" +
        `Venta guardada ‚úÖ (ID: ${saveRes.venta_id})\n` +
        `Items: ${saveRes.itemsCount}\n` +
        `Puntos ganados: ${saveRes.puntosGanados}\n\n` +
        "Respuesta inventario:\n" + JSON.stringify(invRes.data, null, 2),
        "okTxt"
      );

    }catch(e){
      log("ERROR:\n" + (e?.message || String(e)) + "\n\nContenido:\n" + decodedText, "badTxt");
    }finally{
      setTimeout(()=> busy = false, BUSY_COOLDOWN_MS);
    }
  }

  // =========================
  // Scanner QR
  // =========================
  async function onScanSuccess(decodedText){ await handleDecoded(decodedText); }

  async function refreshCameras(){
    cameras = await Html5Qrcode.getCameras();
    if(!Array.isArray(cameras)) cameras = [];
    switchBtn.style.display = (cameras.length >= 2) ? "block" : "none";
    const idxBack = cameras.findIndex(c => /back|rear|environment|trasera/i.test(c.label || ""));
    if(idxBack >= 0) camIndex = idxBack;
  }

  async function startWithCurrentCamera(){
    if(!scanner) scanner = new Html5Qrcode("reader");
    if(!cameras.length) await refreshCameras();

    running = true;
    toggleBtn.textContent = "Detener c√°mara";

    const config = {
      fps: 15,
      qrbox: (vw, vh) => {
        const size = Math.min(vw, vh) * 0.78;
        return { width: Math.floor(size), height: Math.floor(size) };
      },
      disableFlip: true,
      experimentalFeatures: { useBarCodeDetectorIfSupported: true }
    };

    const constraints = cameras.length
      ? { deviceId: { exact: cameras[camIndex].id } }
      : { facingMode: { ideal: "environment" }, width:{ ideal:1920 }, height:{ ideal:1080 } };

    try{
      await scanner.start(constraints, config, onScanSuccess);
      log("C√°mara lista. Escanea un ticket (y el cliente ya seleccionado).", "muted");
    }catch(e){
      running = false;
      toggleBtn.textContent = "Iniciar c√°mara";
      log("No pude iniciar c√°mara. Revisa permisos y HTTPS.", "badTxt");
    }
  }

  async function start(){ if(running) return; await refreshCameras(); await startWithCurrentCamera(); }
  async function stop(){
    if(!running) return;
    running = false;
    toggleBtn.textContent = "Iniciar c√°mara";
    try{ await scanner.stop(); }catch(e){}
    log("C√°mara detenida.", "muted");
  }
  async function switchCamera(){
    if(cameras.length < 2){ log("Solo hay 1 c√°mara disponible.", "badTxt"); return; }
    camIndex = (camIndex + 1) % cameras.length;
    const name = cameras[camIndex]?.label || `C√°mara ${camIndex+1}`;
    log("Cambiando a: " + name + "‚Ä¶", "muted");
    if(running){ await stop(); await start(); }
  }

  filePick.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      if(!scanner) scanner = new Html5Qrcode("reader");
      log("Leyendo foto‚Ä¶ (modo seguro)", "muted");
      const decodedText = await scanner.scanFile(file, true);
      await handleDecoded(decodedText);
    }catch(err){
      console.error(err);
      log("No pude leer la foto. Tip: QR grande, sin reflejo, m√°s cerca.", "badTxt");
    }finally{
      filePick.value = "";
    }
  });

  toggleBtn.addEventListener('click', async ()=>{ if(!running) await start(); else await stop(); });
  switchBtn.addEventListener('click', switchCamera);

  // =========================
  // Clientes: datalist + CRUD + cargar por ?cid=
  // =========================
  async function loadNameDatalist(){
    const dl = $("nombreList");
    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .order("nombre", { ascending: true })
      .limit(5000);

    if(error){ console.error(error); return; }

    clientsCache = (data || []).filter(c => (c.nombre || "").trim().length > 0);
    dl.innerHTML = "";
    for(const c of clientsCache){
      const opt = document.createElement("option");
      opt.value = c.nombre;
      opt.label = `${c.nombre} ‚Äî ${c.telefono || ""}`;
      dl.appendChild(opt);
    }
  }

  function findClientByName(name){
    const n = normalizeLine(name).toLowerCase();
    return clientsCache.find(c => normalizeLine(c.nombre || "").toLowerCase() === n) || null;
  }

  $("nombre").addEventListener("input", async ()=>{
    const c = findClientByName($("nombre").value);
    if(c){
      $("tel").value = c.telefono || "";
      currentClient = c;
      renderStatus();
      await renderClientQR(); // ‚úÖ QR cliente al cargar
      setMsg("okTxt", "Cliente cargado ‚úÖ");
    }
  });

  async function buscarClientePorNombreOTel(){
    const nombre = normalizeLine($("nombre").value);
    const tel = cleanPhone($("tel").value);
    if(!nombre) throw new Error("Nombre es obligatorio.");

    const cached = findClientByName(nombre);
    if(cached){
      currentClient = cached;
      $("tel").value = cached.telefono || tel;
      renderStatus();
      await renderClientQR();
      setMsg("okTxt","Cliente encontrado ‚úÖ");
      return;
    }

    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .ilike("nombre", nombre)
      .maybeSingle();

    if(error) throw error;

    currentClient = data || null;
    if(data) $("tel").value = data.telefono || tel;
    renderStatus();
    await renderClientQR();

    setMsg(data ? "okTxt" : "muted", data ? "Cliente encontrado ‚úÖ" : "No existe: crea el cliente.");
  }

  async function crearOActualizarCliente(){
    const nombre = normalizeLine($("nombre").value);
    const tel = cleanPhone($("tel").value);

    if(!nombre) throw new Error("Nombre es obligatorio.");
    if(tel && tel.length !== 10) throw new Error("Tel√©fono inv√°lido (si lo pones debe ser de 10 d√≠gitos).");

    const payload = { nombre };
    if(tel) payload.telefono = tel;

    let res;
    if(tel){
      res = await sb.from(T_CLIENTES).upsert(payload, { onConflict: "telefono" })
        .select("id,telefono,nombre,puntos,saldo_kg").single();
    }else{
      res = await sb.from(T_CLIENTES).insert(payload)
        .select("id,telefono,nombre,puntos,saldo_kg").single();
    }

    if(res.error) throw res.error;

    currentClient = res.data;
    renderStatus();
    await renderClientQR();
    setMsg("okTxt", "Cliente creado/actualizado ‚úÖ");
    await loadNameDatalist();
  }

  $("btnBuscar").addEventListener("click", async ()=>{
    setMsg("muted","Buscando...");
    try{ await buscarClientePorNombreOTel(); }
    catch(e){ console.error(e); setMsg("badTxt", e.message || String(e)); }
  });

  $("btnCrear").addEventListener("click", async ()=>{
    setMsg("muted","Guardando...");
    try{ await crearOActualizarCliente(); }
    catch(e){ console.error(e); setMsg("badTxt", e.message || String(e)); }
  });

  $("btnReloadNames").addEventListener("click", async ()=>{
    setMsg("muted","Recargando...");
    await loadNameDatalist();
    setMsg("okTxt","Listo ‚úÖ");
  });

  $("btnProcesarPegado").addEventListener("click", async ()=>{
    const txt = $("qrPayload").value.trim();
    if(!txt) return log("Pega el contenido del QR primero.", "warnTxt");
    await handleDecoded(txt);
  });

  function limpiar(){
    $("qrPayload").value = "";
    totalKgEl.textContent = "0.00";
    countLinesEl.textContent = "0";
    fpShortEl.textContent = "‚Äî";
    $("kgAuto").value = "";
    ticketItemsUi = [];
    ticketItemsInv = [];
    renderDetalleEditable();
    log("Listo.", "muted");
  }
  $("btnLimpiar").addEventListener("click", limpiar);

  async function cargarClientePorQuery(){
    const u = new URL(window.location.href);
    const cid = u.searchParams.get("cid");
    if(!cid) return;

    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .eq("id", cid)
      .maybeSingle();

    if(error){ console.error(error); setMsg("badTxt", "Error cargando cid: " + error.message); return; }
    if(!data){ setMsg("badTxt", "Este cid no existe."); return; }

    currentClient = data;
    $("nombre").value = data.nombre || "";
    $("tel").value = data.telefono || "";
    renderStatus();
    await renderClientQR();
    setMsg("okTxt", "Cliente cargado desde ?cid= ‚úÖ");
  }

  // init
  (async function init(){
    renderStatus();
    renderDetalleEditable();
    await loadNameDatalist();
    await cargarClientePorQuery();
    await refreshCameras();
    log("Listo. Selecciona cliente y escanea QR del ticket.", "muted");
  })();
</script>

</body>
</html>
