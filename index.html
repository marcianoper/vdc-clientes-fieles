<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VDC360° — Clientes Fieles (QR + Puntos + Tickets)</title>

  <style>
    :root{--brand:#0a7a3b;--bg:#f6f7f8;--card:#fff;--ink:#111;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
    header{background:var(--brand);color:#fff;padding:14px 18px}
    header h1{margin:0;font-size:18px}
    main{max-width:980px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    label{display:block;font-weight:800;margin-top:10px}
    input,select,button,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #d1d5db;font-size:16px}
    textarea{min-height:140px;resize:vertical}
    button{background:var(--brand);color:#fff;border:none;font-weight:900;cursor:pointer;margin-top:12px}
    button.secondary{background:#111}
    button.ghost{background:#fff;color:#111;border:1px solid #d1d5db}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{display:inline-block;background:#eef7ef;border:1px solid #cfe9d1;color:#1f6f26;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px}
    .muted{color:var(--muted)}
    #qrBox{display:grid;place-items:center;padding:12px;border:1px dashed #d1d5db;border-radius:12px;min-height:240px}
    code{background:#f1f5f9;padding:2px 6px;border-radius:8px}
    .err{background:#fff1f2;border:1px solid #fecdd3;color:#b91c1c;padding:10px;border-radius:12px;white-space:pre-wrap}
    .ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:10px;border-radius:12px;white-space:pre-wrap}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}
    th{background:#f9fafb}
    .mini{font-size:12px;color:var(--muted)}
    .right{text-align:right}

    .camWrap{display:grid;gap:10px;margin-top:10px}
    video{width:100%;border-radius:12px;border:1px solid #e5e7eb;background:#000;max-height:360px}
    canvas{display:none}
    .progressBar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .progressBar > div{height:100%;width:0%;background:var(--brand)}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body>
<header>
  <h1>VDC360° — Clientes Fieles (QR + Puntos + Tickets)</h1>
</header>

<main>

  <!-- =========================
       1) CLIENTE (INVERTIDO)
       - Nombre: obligatorio + muestra nombres guardados
       - Teléfono: se autollena al elegir nombre (editable)
       ========================= -->
  <section class="card">
    <h2 style="margin:0 0 6px">1) Buscar / Crear cliente</h2>

    <div class="grid">
      <div>
        <label>Nombre (obligatorio)</label>
        <input id="nombre" placeholder="Ej. Taquería Don Chuy" list="nombreList" />
        <datalist id="nombreList"></datalist>
        <div class="muted" style="margin-top:6px">
          Tip: pica el campo y te mostrará nombres guardados. Puedes escribir y te filtra.
        </div>
      </div>

      <div>
        <label>Teléfono (10 dígitos)</label>
        <input id="tel" inputmode="numeric" placeholder="Ej. 4621234567" />
        <div class="mini">Se llena automático si seleccionas un nombre existente.</div>
      </div>
    </div>

    <div class="row">
      <button id="btnBuscar">Buscar cliente</button>
      <button id="btnCrear" class="secondary">Crear / Actualizar</button>
      <button id="btnReloadNames" class="ghost" type="button">↻ Recargar nombres</button>
    </div>

    <div id="msg" class="muted" style="margin-top:10px"></div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">2) QR del cliente</h2>
    <p class="muted" style="margin-top:0">El QR contiene una URL del sitio con <code>?cid=</code> para cargar al cliente automáticamente.</p>

    <div id="qrBox"><span class="muted">Aquí aparecerá el QR</span></div>
    <div class="muted" id="qrText" style="margin-top:10px"></div>

    <div class="row" style="margin-top:10px">
      <span class="pill" id="stCliente">Cliente: —</span>
      <span class="pill" id="stPuntos">Puntos: —</span>
      <span class="pill" id="stSaldo">Saldo kg: —</span>
    </div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">3) Capturar compra por Ticket</h2>
    <p class="muted" style="margin-top:0">
      Puedes pegar el texto o <b>escanear aquí mismo</b> con cámara (OCR).
      La caja mostrará una <b>vista filtrada</b> (solo números chicos), pero el sistema guardará el OCR completo para procesar productos.
    </p>

    <div class="row">
      <button id="btnStartCam" class="ghost">Escanear con cámara (OCR)</button>
      <button id="btnStopCam" class="ghost" disabled>Apagar cámara</button>
      <label class="ghost" style="display:block;margin-top:12px;padding:10px;border-radius:10px;border:1px solid #d1d5db;cursor:pointer">
        Subir foto (alternativa)
        <input id="fileTicket" type="file" accept="image/*" capture="environment" style="display:none" />
      </label>
    </div>

    <div class="camWrap" id="camWrap" style="display:none">
      <video id="video" playsinline></video>
      <canvas id="canvas"></canvas>
      <div class="row">
        <button id="btnSnap" class="ghost">Tomar foto y leer</button>
      </div>
      <div class="mini" id="ocrStatus">—</div>
      <div class="progressBar"><div id="ocrBar"></div></div>
    </div>

    <label>Texto del ticket (vista filtrada / pegado)</label>
    <textarea id="ticketText" placeholder="Aquí aparecerán solo números chicos. El OCR completo se guarda en segundo plano."></textarea>

    <div class="row">
      <button id="btnProcesar" class="ghost">Procesar ticket</button>
      <button id="btnLimpiar" class="ghost">Limpiar</button>
    </div>

    <div class="grid" style="margin-top:10px">
      <div>
        <label>Total kg detectado</label>
        <input id="kgAuto" inputmode="decimal" placeholder="0.00" />
        <div class="mini">Se llena automático; puedes editar si hace falta.</div>
      </div>
      <div>
        <label>Tipo de venta</label>
        <select id="tipo">
          <option value="mostrador">mostrador (SÍ puntos)</option>
          <option value="credito">crédito (NO puntos)</option>
        </select>
        <div class="mini">Para puntos: solo mostrador.</div>
      </div>
    </div>

    <div id="detalleBox" class="muted" style="margin-top:10px">—</div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">4) Guardar venta (guarda encabezado + detalle)</h2>
    <button id="btnGuardar">Guardar venta desde ticket</button>
    <div id="log" class="muted" style="margin-top:10px"></div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">5) Historial del cliente (rango de fechas)</h2>
    <p class="muted" style="margin-top:0">
      Selecciona un rango y te muestro: compras, kg totales, puntos en el periodo y resumen por producto.
    </p>

    <div class="grid">
      <div>
        <label>Desde</label>
        <input id="histFrom" type="date" />
      </div>
      <div>
        <label>Hasta</label>
        <input id="histTo" type="date" />
      </div>
    </div>

    <div class="row">
      <button id="btnHist" class="ghost" type="button">Ver historial</button>
      <button id="btnHist7" class="ghost" type="button">Últimos 7 días</button>
      <button id="btnHist30" class="ghost" type="button">Últimos 30 días</button>
    </div>

    <div class="row" style="margin-top:10px">
      <span class="pill" id="stHistCompras">Compras: —</span>
      <span class="pill" id="stHistKg">Kg en periodo: —</span>
      <span class="pill" id="stHistPts">Puntos en periodo: —</span>
    </div>

    <div id="histResumen" class="muted" style="margin-top:10px">—</div>
    <div id="histDetalle" class="muted" style="margin-top:10px">—</div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">Diagnóstico</h2>
    <div id="diag" class="muted">—</div>
  </section>

</main>

<script>
  /* ===== CONFIG ===== */
  const SUPABASE_URL = "https://eqynjddcosvdqjzztznn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeW5qZGRjb3N2ZHFqenp0em5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMzYwMzIsImV4cCI6MjA3MTcxMjAzMn0.Q51wsGelUvxRfqsMYRY5JduCGyZ7s6AzOhqsRf3kOhk";

  const sb = (window.supabase && window.supabase.createClient)
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    : null;

  /* ===== TABLAS ===== */
  const T_CLIENTES = "clientes";
  const T_VENTAS   = "ventas";
  const T_ITEMS    = "ventas_items";

  /* ===== Estado ===== */
  let currentClient = null;
  let ticketItems = [];
  let camStream = null;

  let rawOcrText = "";
  let filteredOcrView = "";

  /* ===== Catálogo (NO CAJAS) ===== */
  const PRODUCT_CATALOG = [
    { key: "Cabeza Congelada",    aliases: [/^CABEZA\s+CONGELAD/i, /^CABEZA\s+CONGELADA\b/i] },
    { key: "Cabeza de Rastro",    aliases: [/^CABEZA\s+DE\s+RASTRO\b/i, /^CABEZA\s+RASTRO\b/i] },
    { key: "Cabeza sin lengua",   aliases: [/^CABEZA\s+SIN\s+LENGUA\b/i, /^CABEZA\s+S\/\s*LENGUA\b/i] },
    { key: "Cabeza de res",       aliases: [/^CABEZA\s+DE\s+RES\b/i, /^CABEZA\b/i, /^CABEZ[AÃ]\b/i] },
    { key: "Corazon",             aliases: [/^CORAZON\b/i, /^CORAZ[OÓ]N\b/i] },
    { key: "Higado",              aliases: [/^HIGADO\b/i, /^H[IÍ]GADO\b/i] },
    { key: "Lengua",              aliases: [/^LENGUA\b/i] },
    { key: "Libro",               aliases: [/^LIBRO\b/i] },
    { key: "Menudo Canadian",     aliases: [/^MENUDO\s+CANADIAN\b/i, /^CANADIAN\b/i] },
    { key: "Nana",                aliases: [/^NANA\b/i] },
    { key: "Panza",               aliases: [/^PANZA\b/i] },
    { key: "Pata Blanca",         aliases: [/^PATA\s*BLANCA\b/i] },
    { key: "Pata Morena",         aliases: [/^PATA\s*MORENA\b/i, /^PATAS\s*MORENA\b/i] },
    { key: "Cuajo",               aliases: [/^CUAJO\b/i] },
    { key: "SEBO",                aliases: [/^SEBO\b/i] },
    { key: "Teleco",              aliases: [/^TELECO\b/i] },
    { key: "Tripa",               aliases: [/^TRIPA\b/i] },
    { key: "Tripa de rastro",      aliases: [/^TRIPA\s+DE\s+RASTRO\b/i, /^TRIPA\s+RASTRO\b/i] },
    { key: "Tripa Gorda",          aliases: [/^TRIPA\s+GORDA\b/i] },
    { key: "Producto Libre",       aliases: [/^PRODUCTO\s+LIBRE\b/i] },
    { key: "Bofe",                 aliases: [/^BOFE\b/i] },
    { key: "Canadian",             aliases: [/^CANADIAN\b/i] },
    
  ];

  const MAX_KG_LINE = 250.00;

  /* ===== Helpers ===== */
  const $ = (id)=>document.getElementById(id);

  function setMsg(type, text){
    const el = $("msg");
    if(!el) return;
    el.className = type === "err" ? "err" : (type==="ok" ? "ok" : "muted");
    el.textContent = text;
  }

  function setLog(type, text){
    const el = $("log");
    if(!el) return;
    el.className = type === "err" ? "err" : (type==="ok" ? "ok" : "muted");
    el.textContent = text;
  }

  function cleanPhone(s){
    return String(s || "").replace(/\D/g, "").slice(-10);
  }

  function normalizeLine(s){
    return String(s||"")
      .replace(/[•·]/g," ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function stripDiacritics(s){
    return String(s || "")
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
  }

  function isCajaLine(line){
    const u = stripDiacritics(String(line||"").toUpperCase());
    return u.startsWith("CAJA ");
  }

  function renderStatus(){
    $("stCliente").textContent = "Cliente: " + (currentClient ? (currentClient.nombre || currentClient.telefono) : "—");
    $("stPuntos").textContent  = "Puntos: " + (currentClient ? currentClient.puntos : "—");
    $("stSaldo").textContent   = "Saldo kg: " + (currentClient ? Number(currentClient.saldo_kg).toFixed(3) : "—");
  }

  function siteBaseUrl(){
    const u = new URL(window.location.href);
    return u.origin + u.pathname.replace(/index\.html$/,'');
  }

  async function renderQR(){
    const box = $("qrBox");
    box.innerHTML = "";
    $("qrText").textContent = "";

    if(!currentClient){
      box.innerHTML = '<span class="muted">Primero crea/selecciona un cliente</span>';
      return;
    }

    const payload = `${siteBaseUrl()}?cid=${currentClient.id}`;
    const img = document.createElement("img");
    img.alt = "QR del cliente";
    img.style.width = "240px";
    img.style.height = "240px";
    img.src = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(payload)}`;
    box.appendChild(img);
    $("qrText").innerHTML = `URL en QR: <code>${payload}</code>`;
  }

  function formatErr(err){
    if(!err) return "Error desconocido";
    if(typeof err === "string") return err;
    if(err.message) return err.message;
    if(err.error_description) return err.error_description;
    try { return JSON.stringify(err, null, 2); } catch { return String(err); }
  }

  function toNum(s){
    const v = Number(String(s ?? "").replace(",", ".").trim());
    return Number.isFinite(v) ? v : NaN;
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function mapToCatalogProduct(line){
    const cleaned = stripDiacritics(normalizeLine(line)).toUpperCase();
    if(isCajaLine(cleaned)) return null;

    for(const p of PRODUCT_CATALOG){
      for(const rx of p.aliases){
        if(rx.test(cleaned)) return p.key;
      }
    }
    return null;
  }

  function filterSmallNumbersOnly(text){
    const tokens = String(text || "")
      .replace(/\r/g, "")
      .split(/\s+/)
      .filter(Boolean);

    const keep = [];
    for(const t of tokens){
      const s = t.replace(/,/g, "");
      const m = s.match(/^(\d{1,6})(?:\.(\d{1,6}))?$/);
      if(!m) continue;
      const intPart = m[1];
      if(intPart.length > 2) continue;
      keep.push(s);
    }
    return keep.join("\n");
  }

  function getTicketTextForParsing(){
    return (rawOcrText && rawOcrText.trim()) ? rawOcrText : ($("ticketText").value || "");
  }

  function parseTicketText(raw){
    const text = String(raw || "").replace(/\r/g, "");
    const lines = text
      .split("\n")
      .map(l => normalizeLine(l))
      .filter(Boolean);

    const STOP = [
      "PRODUCTOS", "PRODUCTOS DE LA", "PRODUCTOS DE LA VENTA",
      "CANTIDAD", "PU", "IMPORTE",
      "TOTAL", "PAGADO", "CAMBIO", "DESCUENTO", "ABONADO", "SALDO",
      "FOLIO", "FECHA", "CAJERO", "VENDEDOR", "CLIENTE", "VENTA", "CREDITO", "CONTADO"
    ];

    function isStopLine(line){
      const U = stripDiacritics(String(line||"").toUpperCase());
      return STOP.some(w => U.includes(w));
    }

    function cleanLineForProduct(line){
      return normalizeLine(line)
        .replace(/[^\p{L}\s]/gu, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function extractNumbers(line){
      let s = String(line || "").trim();
      s = s.replace(/(\d),(\d{2})(\b)/g, "$1.$2");
      s = s.replace(/(\d),(?=\d{3}\b)/g, "");
      s = s.replace(/[^\d.\s]/g, " ");
      return s.split(/\s+/).filter(Boolean)
        .map(x => Number(x))
        .filter(n => Number.isFinite(n) && n > 0);
    }

    function detectProduct(line){
      const cleaned = cleanLineForProduct(line);
      if(!cleaned) return null;
      if(isStopLine(cleaned)) return null;
      if(isCajaLine(cleaned)) return null;
      return mapToCatalogProduct(cleaned);
    }

    const out = [];

    for(let i=0; i<lines.length; i++){
      const prod = detectProduct(lines[i]);
      if(!prod) continue;

      const nums1 = extractNumbers(lines[i+1] || "");
      const nums2 = extractNumbers(lines[i+2] || "");
      const nums = nums1.length ? nums1 : nums2;
      if(!nums.length) continue;

      const qty = nums[0];
      if(!Number.isFinite(qty) || qty <= 0 || qty > MAX_KG_LINE) continue;

      out.push({ producto: prod, kg: qty });
    }

    const map = new Map();
    for(const it of out){
      const key = it.producto.toLowerCase();
      map.set(key, (map.get(key) || 0) + it.kg);
    }

    return [...map.entries()]
      .map(([k,kg])=>({ producto: k.charAt(0).toUpperCase()+k.slice(1), kg: Number(kg) }))
      .sort((a,b)=>b.kg-a.kg);
  }

  function calcTotalKg(items){
    return items.reduce((acc,it)=>acc + (Number(it.kg)||0), 0);
  }

  function renderDetalleEditable(){
    const box = $("detalleBox");
    if(!ticketItems.length){
      box.className = "muted";
      box.textContent = "—";
      return;
    }

    const rows = ticketItems.map((it, idx)=>`
      <tr>
        <td style="width:65%">
          <input data-idx="${idx}" data-field="producto" value="${escapeHtml(it.producto)}" />
        </td>
        <td style="width:25%">
          <input data-idx="${idx}" data-field="kg" inputmode="decimal" value="${Number(it.kg).toFixed(3)}" />
        </td>
        <td class="right" style="width:10%">
          <button class="ghost" data-del="${idx}" style="margin:0;padding:8px;border-radius:10px">X</button>
        </td>
      </tr>
    `).join("");

    box.className = "";
    box.innerHTML = `
      <div class="mini">Puedes corregir nombres y kilos antes de guardar.</div>
      <table>
        <thead>
          <tr><th>Producto</th><th>Kg</th><th class="right">Del</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="row" style="margin-top:10px">
        <button id="btnAgregarLinea" class="ghost">+ Agregar línea</button>
      </div>
    `;

    box.querySelectorAll('input[data-idx]').forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const idx = Number(inp.getAttribute("data-idx"));
        const field = inp.getAttribute("data-field");
        if(!ticketItems[idx]) return;

        if(field === "kg"){
          const v = toNum(inp.value);
          ticketItems[idx].kg = Number.isFinite(v) ? v : 0;
        }else{
          ticketItems[idx].producto = normalizeLine(inp.value);
        }
        $("kgAuto").value = calcTotalKg(ticketItems).toFixed(2);
      });
    });

    box.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const idx = Number(btn.getAttribute("data-del"));
        ticketItems.splice(idx, 1);
        $("kgAuto").value = calcTotalKg(ticketItems).toFixed(2);
        renderDetalleEditable();
      });
    });

    const addBtn = $("btnAgregarLinea");
    if(addBtn){
      addBtn.addEventListener("click", ()=>{
        ticketItems.push({ producto:"Producto", kg:0 });
        renderDetalleEditable();
      });
    }
  }

  /* =========================================================
     ✅ NUEVO: LISTA DE NOMBRES (datalist) + AUTOLLENADO TEL
     - Al elegir nombre existente => se llena teléfono y se carga cliente
     - Botón recargar nombres
  ========================================================= */
  let clientsCache = [];

  async function loadNameDatalist(){
    if(!sb) return;
    const dl = $("nombreList");
    if(!dl) return;

    // Trae clientes (si son demasiados, baja limit o paginación)
    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .order("nombre", { ascending: true })
      .limit(5000);

    if(error){
      console.error(error);
      return;
    }

    clientsCache = (data || []).filter(c => (c.nombre || "").trim().length > 0);

    // Para evitar duplicados por mismo nombre, lo dejamos tal cual pero con label
    dl.innerHTML = "";
    for(const c of clientsCache){
      const opt = document.createElement("option");
      opt.value = c.nombre;
      opt.label = `${c.nombre} — ${c.telefono || ""}`;
      dl.appendChild(opt);
    }
  }

  function findClientByName(name){
    const n = normalizeLine(name).toLowerCase();
    return clientsCache.find(c => normalizeLine(c.nombre || "").toLowerCase() === n) || null;
  }

  // Cuando el usuario escribe/selecciona un nombre
  $("nombre").addEventListener("input", async ()=>{
    const c = findClientByName($("nombre").value);
    if(c){
      $("tel").value = c.telefono || "";
      currentClient = c;
      renderStatus();
      await renderQR();
      setMsg("ok", "Cliente cargado por nombre.");
    }
  });

  $("btnReloadNames").addEventListener("click", async ()=>{
    setMsg("muted","Cargando nombres...");
    await loadNameDatalist();
    setMsg("ok","Nombres recargados ✅");
  });

  /* ===== Acciones Cliente (AJUSTADAS A NOMBRE OBLIGATORIO) ===== */
  async function buscarClientePorNombreOTel(){
    if(!sb) throw new Error("Supabase no cargó. Revisa internet o CDN.");

    const nombre = normalizeLine($("nombre").value);
    const tel = cleanPhone($("tel").value);

    if(!nombre) throw new Error("Nombre es obligatorio.");

    // 1) Si el nombre existe en cache, úsalo directo
    const cached = findClientByName(nombre);
    if(cached){
      currentClient = cached;
      $("tel").value = cached.telefono || tel;
      renderStatus();
      await renderQR();
      setMsg("ok","Cliente encontrado (por nombre).");
      return;
    }

    // 2) Busca por nombre exacto en BD
    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .ilike("nombre", nombre)  // si quieres exacto, cambia a .eq("nombre", nombre)
      .maybeSingle();

    if(error) throw error;

    currentClient = data || null;
    if(data){
      $("tel").value = data.telefono || tel;
    }
    renderStatus();
    await renderQR();

    setMsg(data ? "ok" : "muted", data ? "Cliente encontrado." : "No existe: crea el cliente.");
  }

  async function crearOActualizarCliente(){
    if(!sb) throw new Error("Supabase no cargó. Revisa internet o CDN.");

    const nombre = normalizeLine($("nombre").value);
    const tel = cleanPhone($("tel").value);

    if(!nombre) throw new Error("Nombre es obligatorio.");
    if(tel && tel.length !== 10) throw new Error("Teléfono inválido (si lo pones debe ser de 10 dígitos).");

    const payload = { nombre };
    if(tel) payload.telefono = tel;

    // Si tú tienes UNIQUE por teléfono, ok. Si NO, conviene UNIQUE por nombre o un campo "telefono" único.
    // Aquí hacemos upsert por teléfono si existe; si no hay teléfono, hacemos insert normal.
    let res;
    if(tel){
      res = await sb
        .from(T_CLIENTES)
        .upsert(payload, { onConflict: "telefono" })
        .select("id,telefono,nombre,puntos,saldo_kg")
        .single();
    }else{
      res = await sb
        .from(T_CLIENTES)
        .insert(payload)
        .select("id,telefono,nombre,puntos,saldo_kg")
        .single();
    }

    const { data, error } = res;
    if(error) throw error;

    currentClient = data;
    renderStatus();
    await renderQR();

    setMsg("ok", "Cliente creado/actualizado y QR generado.");

    await loadNameDatalist();
  }

  /* ===== Guardar venta + detalle + puntos ===== */
  async function guardarVentaDesdeTicket(){
    if(!sb) throw new Error("Supabase no cargó. Revisa internet o CDN.");
    if(!currentClient) throw new Error("Primero selecciona un cliente.");

    const tipo = $("tipo").value;
    const rawTicket = getTicketTextForParsing().trim();

    const kg = toNum($("kgAuto").value);
    if(!Number.isFinite(kg) || kg <= 0) throw new Error("Total kg inválido.");

    const items = (ticketItems || [])
      .map(it=>({ producto: normalizeLine(it.producto), kg: Number(it.kg) }))
      .filter(it=>it.producto && Number.isFinite(it.kg) && it.kg > 0);

    const ventaInsert = {
      tipo,
      cliente_id: currentClient.id,
      total_kg: kg,
      puntos_otorgados: 0,
      raw_ticket: rawTicket || null,
      captura: "ticket_ocr"
    };

    const { data: venta, error: e1 } = await sb
      .from(T_VENTAS)
      .insert(ventaInsert)
      .select("id,tipo,total_kg,puntos_otorgados,created_at")
      .single();

    if(e1) throw e1;

    if(items.length){
      const payloadItems = items.map(it=>({
        venta_id: venta.id,
        producto: it.producto,
        kg: it.kg
      }));

      const { error: e2 } = await sb.from(T_ITEMS).insert(payloadItems);
      if(e2) throw e2;
    }

    let puntosGanados = 0;
    let nuevoSaldo = Number(currentClient.saldo_kg);

    if(tipo === "mostrador"){
      const acumulado = Number(currentClient.saldo_kg) + kg;
      puntosGanados = Math.floor(acumulado / 100);
      nuevoSaldo = acumulado % 100;

      const { data: cli2, error: e3 } = await sb
        .from(T_CLIENTES)
        .update({
          puntos: currentClient.puntos + puntosGanados,
          saldo_kg: nuevoSaldo
        })
        .eq("id", currentClient.id)
        .select("id,telefono,nombre,puntos,saldo_kg")
        .single();

      if(e3) throw e3;
      currentClient = cli2;

      const { error: e4 } = await sb
        .from(T_VENTAS)
        .update({ puntos_otorgados: puntosGanados })
        .eq("id", venta.id);

      if(e4) throw e4;
    }

    renderStatus();
    setLog("ok",
      `✅ Venta guardada.
Cliente: ${currentClient.nombre || currentClient.telefono}
Tipo: ${tipo}
Total kg: ${kg.toFixed(2)}
Puntos ganados: ${puntosGanados}
Items guardados: ${items.length}
Venta ID: ${venta.id}`
    );

    limpiarTicket();
  }

  /* ===== OCR + Cámara ===== */
  function setOcrUI(status, progress){
    const st = $("ocrStatus");
    if(st) st.textContent = status || "—";
    const p = Math.max(0, Math.min(1, Number(progress||0)));
    $("ocrBar").style.width = (p*100).toFixed(0) + "%";
  }

  async function runOCRFromCanvas(){
    if(typeof Tesseract === "undefined") throw new Error("OCR no cargó (Tesseract). Revisa internet/CDN.");

    setOcrUI("Leyendo ticket... (OCR)", 0.02);
    const canvas = $("canvas");

    const { data: { text } } = await Tesseract.recognize(
      canvas,
      "spa",
      {
        logger: (m)=>{
          if(m && m.status){
            const prog = (typeof m.progress === "number") ? m.progress : 0;
            setOcrUI(`OCR: ${m.status} ${(prog*100).toFixed(0)}%`, prog);
          }
        }
      }
    );

    const cleaned = (text || "")
      .replace(/\r/g, "")
      .replace(/[ \t]+\n/g, "\n")
      .trim();

    rawOcrText = cleaned;
    filteredOcrView = filterSmallNumbersOnly(cleaned);
    $("ticketText").value = filteredOcrView || cleaned;

    setOcrUI("OCR terminado ✅", 1);

    try { procesarTicket(); } catch(e){ console.error(e); }
  }

  async function runOCRFromFile(file){
    const img = await fileToImage(file);
    drawToCanvas(img);
    await runOCRFromCanvas();
  }

  function fileToImage(file){
    return new Promise((resolve,reject)=>{
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = ()=>{ URL.revokeObjectURL(url); resolve(img); };
      img.onerror = (e)=>{ URL.revokeObjectURL(url); reject(e); };
      img.src = url;
    });
  }

  function drawToCanvas(img){
    const canvas = $("canvas");
    const ctx = canvas.getContext("2d");

    const maxW = 1400;
    const scale = Math.min(1, maxW / img.width);
    const w = Math.round(img.width * scale);
    const h = Math.round(img.height * scale);

    canvas.width = w;
    canvas.height = h;
    ctx.drawImage(img, 0, 0, w, h);
  }

  async function startCamera(){
    if(!navigator.mediaDevices?.getUserMedia) throw new Error("Este navegador no soporta cámara por web.");

    $("camWrap").style.display = "grid";
    $("btnStartCam").disabled = true;
    $("btnStopCam").disabled = false;

    const video = $("video");
    camStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } },
      audio: false
    });
    video.srcObject = camStream;
    await video.play();
    setOcrUI("Cámara lista. Pon el ticket centrado y toma la foto.", 0);
  }

  function stopCamera(){
    try{
      if(camStream){
        camStream.getTracks().forEach(t=>t.stop());
        camStream = null;
      }
    }catch(_){}
    $("video").srcObject = null;
    $("camWrap").style.display = "none";
    $("btnStartCam").disabled = false;
    $("btnStopCam").disabled = true;
    setOcrUI("—", 0);
  }

  function snapToCanvas(){
    const video = $("video");
    const canvas = $("canvas");
    const ctx = canvas.getContext("2d");

    const w = video.videoWidth || 1280;
    const h = video.videoHeight || 720;

    const maxW = 1400;
    const scale = Math.min(1, maxW / w);
    canvas.width = Math.round(w * scale);
    canvas.height = Math.round(h * scale);
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  }

  /* ===== Procesar ticket ===== */
  function procesarTicket(){
    const raw = getTicketTextForParsing();
    const items = parseTicketText(raw);

    ticketItems = items;
    const total = calcTotalKg(ticketItems);

    $("kgAuto").value = Number.isFinite(total) ? total.toFixed(2) : "";
    renderDetalleEditable();

    if(!items.length){
      setLog("err", "No pude detectar productos. Tip: escanea con buena luz y que se vea el texto del producto.");
    }else{
      setLog("ok", `Ticket procesado. Líneas detectadas: ${items.length}. Total kg: ${total.toFixed(2)}.`);
    }
  }

  function limpiarTicket(){
    $("ticketText").value = "";
    $("kgAuto").value = "";
    ticketItems = [];
    rawOcrText = "";
    filteredOcrView = "";
    renderDetalleEditable();
    setLog("muted","Listo.");
  }

  /* ===== Historial ===== */
  function setDateInputsDefault(){
    const to = new Date();
    const from = new Date();
    from.setDate(to.getDate() - 7);
    $("histTo").value = to.toISOString().slice(0,10);
    $("histFrom").value = from.toISOString().slice(0,10);
  }

  function dateRangeToISO(fromDate, toDate){
    const start = new Date(fromDate + "T00:00:00.000Z");
    const end   = new Date(toDate   + "T23:59:59.999Z");
    return { startISO: start.toISOString(), endISO: end.toISOString() };
  }

  function fmtDate(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString("es-MX", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch{
      return iso;
    }
  }

  function renderHistResumen({count, totalKg, totalPts, byProduct}){
    $("stHistCompras").textContent = `Compras: ${count}`;
    $("stHistKg").textContent      = `Kg en periodo: ${totalKg.toFixed(2)}`;
    $("stHistPts").textContent     = `Puntos en periodo: ${totalPts}`;

    if(!count){
      $("histResumen").className = "muted";
      $("histResumen").textContent = "—";
      return;
    }

    const rows = Object.entries(byProduct)
      .sort((a,b)=>b[1]-a[1])
      .map(([prod,kg])=>`
        <tr>
          <td>${escapeHtml(prod)}</td>
          <td class="right">${Number(kg).toFixed(3)}</td>
        </tr>
      `).join("");

    $("histResumen").className = "";
    $("histResumen").innerHTML = `
      <div class="mini">Resumen por producto (kg):</div>
      <table>
        <thead><tr><th>Producto</th><th class="right">Kg</th></tr></thead>
        <tbody>${rows || `<tr><td colspan="2" class="muted">Sin items</td></tr>`}</tbody>
      </table>
    `;
  }

  function renderHistDetalle(ventas){
    const box = $("histDetalle");
    if(!ventas?.length){
      box.className = "muted";
      box.textContent = "—";
      return;
    }

    const rows = ventas.map(v=>{
      const items = (v.ventas_items || []);
      const itemTxt = items.length
        ? items.map(it=>`${escapeHtml(it.producto)}: ${Number(it.kg||0).toFixed(3)} kg`).join("<br>")
        : `<span class="mini muted">Sin detalle</span>`;

      return `
        <tr>
          <td style="white-space:nowrap">${fmtDate(v.created_at)}</td>
          <td>${escapeHtml(v.tipo || "")}</td>
          <td class="right">${Number(v.total_kg||0).toFixed(2)}</td>
          <td class="right">${Number(v.puntos_otorgados||0)}</td>
          <td>${itemTxt}</td>
        </tr>
      `;
    }).join("");

    box.className = "";
    box.innerHTML = `
      <div class="mini">Detalle de compras:</div>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th class="right">Kg</th>
            <th class="right">Pts</th>
            <th>Items</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  async function fetchHistorial(){
    if(!sb) throw new Error("Supabase no cargó.");
    if(!currentClient) throw new Error("Primero selecciona un cliente.");

    const from = $("histFrom").value;
    const to = $("histTo").value;
    if(!from || !to) throw new Error("Selecciona Desde y Hasta.");

    const { startISO, endISO } = dateRangeToISO(from, to);

    const { data, error } = await sb
      .from(T_VENTAS)
      .select(`
        id, created_at, tipo, total_kg, puntos_otorgados,
        ventas_items:ventas_items ( producto, kg )
      `)
      .eq("cliente_id", currentClient.id)
      .gte("created_at", startISO)
      .lte("created_at", endISO)
      .order("created_at", { ascending: false });

    if(error) throw error;

    const ventas = data || [];
    let totalKg = 0;
    let totalPts = 0;
    const byProduct = {};

    for(const v of ventas){
      totalKg += Number(v.total_kg || 0);
      totalPts += Number(v.puntos_otorgados || 0);

      const items = v.ventas_items || [];
      for(const it of items){
        const prod = normalizeLine(it.producto || "Producto");
        const kg = Number(it.kg || 0);
        byProduct[prod] = (byProduct[prod] || 0) + kg;
      }
    }

    renderHistResumen({ count: ventas.length, totalKg, totalPts, byProduct });
    renderHistDetalle(ventas);
  }

  function setQuickRange(days){
    const to = new Date();
    const from = new Date();
    from.setDate(to.getDate() - days);
    $("histTo").value = to.toISOString().slice(0,10);
    $("histFrom").value = from.toISOString().slice(0,10);
  }

  async function cargarClientePorQuery(){
    const u = new URL(window.location.href);
    const cid = u.searchParams.get("cid");
    if(!cid || !sb) return;

    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .eq("id", cid)
      .maybeSingle();

    if(error){
      console.error(error);
      setMsg("err", "Error cargando cliente por QR: " + formatErr(error));
      return;
    }
    if(!data){
      setMsg("err", "Este QR no encontró cliente (cid no existe).");
      return;
    }
    currentClient = data;
    $("nombre").value = data.nombre || "";
    $("tel").value = data.telefono || "";
    renderStatus();
    await renderQR();
    setMsg("ok", "Cliente cargado desde QR.");
  }

  /* ===== Listeners ===== */
  $("btnBuscar").addEventListener("click", async ()=>{
    setMsg("muted","Buscando...");
    try{ await buscarClientePorNombreOTel(); }
    catch(err){ console.error(err); setMsg("err", formatErr(err)); }
  });

  $("btnCrear").addEventListener("click", async ()=>{
    setMsg("muted","Guardando...");
    try{ await crearOActualizarCliente(); }
    catch(err){ console.error(err); setMsg("err", formatErr(err)); }
  });

  $("btnProcesar").addEventListener("click", ()=>{
    try{ procesarTicket(); }
    catch(err){ console.error(err); setLog("err", formatErr(err)); }
  });

  $("btnLimpiar").addEventListener("click", ()=>{
    limpiarTicket();
  });

  $("btnGuardar").addEventListener("click", async ()=>{
    setLog("muted","Guardando venta...");
    try{ await guardarVentaDesdeTicket(); }
    catch(err){ console.error(err); setLog("err", formatErr(err)); }
  });

  $("btnStartCam").addEventListener("click", async ()=>{
    try{ await startCamera(); }
    catch(err){ console.error(err); setLog("err", "No pude abrir cámara: " + formatErr(err)); stopCamera(); }
  });

  $("btnStopCam").addEventListener("click", ()=>{
    stopCamera();
  });

  $("btnSnap").addEventListener("click", async ()=>{
    try{
      if(!camStream) throw new Error("Cámara no está encendida.");
      setLog("muted","Tomando foto...");
      snapToCanvas();
      await runOCRFromCanvas();
    }catch(err){
      console.error(err);
      setLog("err", "OCR falló: " + formatErr(err));
    }
  });

  $("fileTicket").addEventListener("change", async (e)=>{
    try{
      const f = e.target.files?.[0];
      if(!f) return;
      setLog("muted","Leyendo foto (OCR)...");
      await runOCRFromFile(f);
    }catch(err){
      console.error(err);
      setLog("err", "OCR falló: " + formatErr(err));
    }finally{
      e.target.value = "";
    }
  });

  $("btnHist").addEventListener("click", async ()=>{
    setLog("muted","Cargando historial...");
    try{
      await fetchHistorial();
      setLog("ok","Historial cargado ✅");
    }catch(err){
      console.error(err);
      setLog("err", formatErr(err));
    }
  });

  $("btnHist7").addEventListener("click", ()=>{
    setQuickRange(7);
    $("btnHist").click();
  });

  $("btnHist30").addEventListener("click", ()=>{
    setQuickRange(30);
    $("btnHist").click();
  });

  window.addEventListener("beforeunload", stopCamera);
  document.addEventListener("visibilitychange", ()=>{
    if(document.hidden) stopCamera();
  });

  /* ===== INIT ===== */
  (function init(){
    const d = [];
    d.push("Supabase cargado: " + (!!sb));
    d.push("OCR cargado: " + (typeof Tesseract !== "undefined"));
    d.push("Base URL del sitio: " + siteBaseUrl());
    d.push("HTTPS recomendado para cámara.");
    $("diag").textContent = d.join("\n");

    renderStatus();
    renderDetalleEditable();
    cargarClientePorQuery();
    loadNameDatalist();
    setDateInputsDefault();
  })();
</script>
</body>
</html>
