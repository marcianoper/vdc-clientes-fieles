<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>VDC360¬∞ ‚Äî Clientes</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root{
      --bg:#f6f7f8; --paper:#ffffff; --paper2:#f9fafb; --line:#e5e7eb;
      --ink:#0f172a; --muted:#64748b;
      --brand:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --shadow: 0 14px 36px rgba(2,6,23,.10); --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 520px at 10% -10%, rgba(34,197,94,.12), transparent 60%),
                  radial-gradient(1000px 520px at 90% 10%, rgba(245,158,11,.10), transparent 60%),
                  var(--bg);
      color:var(--ink);
    }
    header{
      background:linear-gradient(90deg, rgba(22,163,74,.95), rgba(34,197,94,.95));
      color:#fff;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.18);
      position:sticky;top:0;z-index:5;
    }
    .headRow{max-width:1040px;margin:0 auto;display:flex;gap:10px;align-items:center;justify-content:space-between}
    header b{font-weight:1000}
    header .chip{
      background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.22);
      padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;
    }
    .wrap{max-width:1040px;margin:0 auto;padding:14px 16px;display:grid;gap:12px}
    .card{background:var(--paper);border:1px solid var(--line);border-radius:var(--r);padding:14px;box-shadow:var(--shadow);}
    .titleRow{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap}
    h3{margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:820px){.grid{grid-template-columns:1fr}}
    label{display:block;font-weight:900;margin-top:10px}
    input,select,textarea,button{
      width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--line);
      background:var(--paper2);color:var(--ink);font-size:16px;outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    input:focus,select:focus,textarea:focus{box-shadow:0 0 0 4px rgba(34,197,94,.14);border-color:rgba(34,197,94,.55)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    button{border:0;background:var(--brand);color:#052e16;font-weight:1000;cursor:pointer;box-shadow:0 10px 22px rgba(22,163,74,.18);}
    button.secondary{background:#0f172a;color:#fff;box-shadow:none}
    button.ghost{background:transparent;color:var(--ink);border:1px solid var(--line);box-shadow:none}
    button.warn{background:var(--warn);color:#1f1300;box-shadow:none}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    .pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:var(--paper2);font-weight:900;font-size:12px;color:var(--ink);}
    #qrClienteBox{
      display:grid;place-items:center;border:1px dashed #cbd5e1;border-radius:16px;min-height:240px;
      margin-top:10px;padding:12px;background:linear-gradient(180deg, rgba(34,197,94,.06), transparent);
    }
    #qrClienteBox img{width:220px;height:220px;border-radius:12px;background:#fff}
    code{background:rgba(2,6,23,.06);padding:2px 6px;border-radius:10px;border:1px solid rgba(2,6,23,.08)}
    .totals{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    .bigTotal{background:rgba(34,197,94,.10);border:1px solid rgba(34,197,94,.22);border-radius:18px;padding:14px;text-align:center;}
    .bigTotal .t1{opacity:.85;font-weight:1000}
    .bigTotal .t2{font-size:44px;line-height:1;margin-top:8px;font-weight:1100;color:var(--brand)}
    .bigTotal .t3{opacity:.85;font-weight:1000;margin-top:6px}
    .miniGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .miniGrid{grid-template-columns:1fr;} }
    .miniCard{background:var(--paper2);border:1px solid var(--line);border-radius:16px;padding:12px;}
    .miniCard b{display:block;font-size:12px;color:var(--muted)}
    .miniCard .val{font-size:18px;font-weight:1100;margin-top:6px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
    th{background:var(--paper2)}
    .right{text-align:right}
    input[type="file"]{display:none}
    .toast{display:none;margin-top:10px;padding:12px 14px;border-radius:16px;border:1px solid var(--line);background:#fff;box-shadow:var(--shadow);}
    .toast.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.08)}
    .toast.bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.06)}
    .toast .t{font-weight:1100}
    .toast .d{margin-top:6px;color:var(--muted);font-size:12px;white-space:pre-wrap}
    .adminOnly{display:block}
    .opOnly{display:none}
    body.role-op #roleChip, body.role-op #btnCambiarUsuario{display:none !important;}
    .modalBg{position:fixed; inset:0;background:rgba(2,6,23,.55);display:none;place-items:center;z-index:50;padding:16px;}
    .modal{width:min(520px,100%);background:#fff;border-radius:22px;border:1px solid var(--line);box-shadow:0 30px 80px rgba(0,0,0,.25);padding:16px;}
    .modal h4{margin:0 0 6px}
    .seg{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .seg button{flex:1; min-width:140px}

    /* Ventas */
    .ventaCard{border:1px solid var(--line);background:var(--paper2);padding:12px;border-radius:16px;margin-top:10px;}
    .ventaTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .ventaTop b{font-size:14px}
    .ventaMini{font-size:12px;color:var(--muted);margin-top:4px}
    .ventaItems{margin-top:8px}
    .ventaItems div{font-size:12px;margin-left:8px}
    .ventaResume{margin-top:10px;padding:12px;border-radius:16px;border:1px solid rgba(34,197,94,.25);background:rgba(34,197,94,.10);font-weight:900;}
    .ventaBtnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .ventaBtnRow button{flex:1}
    .errBox{margin-top:10px;padding:12px;border-radius:16px;border:1px solid rgba(239,68,68,.30);background:rgba(239,68,68,.06);color:#7f1d1d;font-weight:900;white-space:pre-wrap;}
  </style>
</head>

<body>
<header>
  <div class="headRow">
    <div>
      <b>VDC360¬∞ ‚Äî Clientes</b>
      <div class="muted" style="color:rgba(255,255,255,.85)">Guardar compras + Inventario</div>
    </div>
    <div class="row" style="max-width:520px;align-items:center">
      <span class="chip" id="roleChip">Modo: ‚Äî</span>
      <button class="ghost" id="btnCambiarUsuario" type="button" style="background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.22);color:#fff;box-shadow:none">
        Cambiar usuario
      </button>
    </div>
  </div>
</header>

<div class="wrap">

  <!-- 1) Cliente -->
  <section class="card">
    <div class="titleRow">
      <div>
        <h3>1) Cliente</h3>
        <div class="sub">Cada cliente tiene su QR √∫nico para cargarlo autom√°tico.</div>
      </div>
      <div class="pills">
        <span class="pill" id="stCliente">Cliente: ‚Äî</span>
        <span class="pill" id="stPuntos">Puntos: ‚Äî</span>
        <span class="pill" id="stSaldo">Saldo kg: ‚Äî</span>
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div>
        <label>Nombre</label>
        <input id="nombre" placeholder="Ej. Taquer√≠a Don Chuy" list="nombreList" />
        <datalist id="nombreList"></datalist>
        <div class="muted">Tip: escribe y selecciona del autocompletado.</div>
      </div>
      <div>
        <label>Tel√©fono</label>
        <input id="tel" inputmode="numeric" placeholder="4621234567" />
        <div class="muted">Se autocompleta si eliges cliente existente.</div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnBuscar" type="button">Buscar</button>
      <button id="btnCrear" class="secondary" type="button">Crear / Actualizar</button>
      <button id="btnReloadNames" class="ghost" type="button">‚Üª Recargar</button>
    </div>

    <div id="msg" class="muted" style="margin-top:10px">‚Äî</div>

    <div class="grid" style="margin-top:12px">
      <div>
        <div id="qrClienteBox"><span class="muted">Selecciona un cliente para generar su QR</span></div>
        <div class="adminOnly">
          <div class="muted" id="qrClienteText" style="margin-top:10px"></div>
          <div class="row" style="margin-top:10px">
            <button id="btnCopiarUrl" class="ghost" type="button">Copiar URL del QR</button>
            <button id="btnAbrirUrl" class="ghost" type="button">Abrir URL</button>
          </div>
        </div>
        <div class="opOnly">
          <div class="muted" style="margin-top:10px">QR listo para imprimir o guardar.</div>
        </div>
      </div>
      <div class="muted">
        Uso recomendado:
        <ul>
          <li>Impr√≠melo y p√©galo en la libreta del cliente</li>
          <li>O gu√°rdalo en WhatsApp del cliente como ‚ÄúMi QR VDC‚Äù</li>
        </ul>
        <div class="muted">Tip: para cargar cliente r√°pido, abre esta misma p√°gina con el QR del cliente.</div>
      </div>
    </div>
  </section>

  <!-- ‚úÖ Ventas del cliente (Admin) -->
  <section class="card adminOnly">
    <div class="titleRow">
      <div>
        <h3>Ventas del Cliente</h3>
        <div class="sub">Historial + detalle. (Ahora con debug si algo falla)</div>
      </div>
      <div class="ventaBtnRow" style="max-width:420px">
        <button class="ghost" id="btnVerVentas" type="button">Ver / Actualizar</button>
        <button class="ghost" id="btnLimpiarVentas" type="button">Limpiar</button>
      </div>
    </div>
    <div id="ventasClienteBox" class="muted" style="margin-top:10px">Selecciona un cliente‚Ä¶</div>
  </section>

  <!-- 2) QR Ticket -->
  <section class="card">
    <div class="titleRow">
      <div>
        <h3>2) Escanear QR del Ticket</h3>
        <div class="sub">Primero selecciona cliente. Luego escanea QR del ticket.</div>
      </div>
      <div class="row" style="min-width:260px;max-width:420px">
        <button class="ghost" id="toggle" type="button">Iniciar c√°mara</button>
        <button class="warn" id="switchCam" type="button" style="display:none">Cambiar c√°mara</button>
      </div>
    </div>

    <div id="reader" style="width:100%;margin-top:10px"></div>

    <div class="muted" style="margin-top:10px">
      Si no lo lee en vivo, usa <b>Subir foto</b>.
    </div>

    <label class="ghost" for="filePick" style="margin-top:10px;display:block;text-align:center;cursor:pointer">
      üì∏ Subir foto del QR
      <input id="filePick" type="file" accept="image/*" capture="environment">
    </label>

    <div class="adminOnly" style="margin-top:10px">
      <label>Contenido del QR (debug)</label>
      <textarea id="qrPayload" placeholder='Aqu√≠ se pega / aparecer√° lo escaneado...'></textarea>
      <div class="row" style="margin-top:10px">
        <button id="btnProcesarPegado" class="warn" type="button">Procesar QR pegado</button>
        <button id="btnLimpiar" class="ghost" type="button">Limpiar</button>
      </div>
    </div>

    <div class="totals">
      <div class="bigTotal">
        <div class="t1">TOTAL KG DEL TICKET</div>
        <div class="t2" id="totalKg">0.00</div>
        <div class="t3">kg</div>
      </div>

      <div class="miniGrid adminOnly">
        <div class="miniCard">
          <b># Productos (l√≠neas)</b>
          <div class="val" id="countLines">0</div>
        </div>
        <div class="miniCard">
          <b>Ticket (fingerprint)</b>
          <div class="val" id="fpShort">‚Äî</div>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div>
        <label>Tipo de venta</label>
        <select id="tipo">
          <option value="mostrador">mostrador (S√ç puntos)</option>
          <option value="credito">cr√©dito (NO puntos)</option>
        </select>
      </div>

      <div class="adminOnly">
        <label>Total kg (editable)</label>
        <input id="kgAuto" inputmode="decimal" placeholder="0.00" />
      </div>

      <div class="opOnly">
        <label>Total kg</label>
        <input id="kgAutoOp" disabled />
      </div>
    </div>

    <div id="detalleBox" class="adminOnly muted" style="margin-top:10px">‚Äî</div>
    <div id="opToast" class="toast" aria-live="polite"></div>
  </section>

  <section class="card adminOnly">
    <div class="muted">Resultado (t√©cnico):</div>
    <div id="out" class="log">Listo.</div>
  </section>
</div>

<div class="modalBg" id="modalBg">
  <div class="modal">
    <h4>Cambiar usuario</h4>
    <p class="sub muted">Operador = solo OK. Admin = todo el detalle.</p>

    <div class="seg">
      <button id="btnSetOp" class="ghost" type="button">Soy Operador</button>
      <button id="btnSetAdmin" class="secondary" type="button">Soy Admin</button>
    </div>

    <div id="pinBox" style="display:none;margin-top:12px">
      <label>PIN Admin</label>
      <input id="adminPin" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <div class="row" style="margin-top:10px">
        <button id="btnOkPin" class="secondary" type="button">Entrar como Admin</button>
        <button id="btnCancelPin" class="ghost" type="button">Cancelar</button>
      </div>
      <div id="pinMsg" class="muted" style="margin-top:10px"></div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnCloseModal" class="ghost" type="button">Cerrar</button>
    </div>
  </div>
</div>

<script>
  // =========================
  // === Credenciales ===
  // =========================
  const SUPABASE_URL = "https://eqynjddcosvdqjzztznn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeW5qZGRjb3N2ZHFqenp0em5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMzYwMzIsImV4cCI6MjA3MTcxMjAzMn0.Q51wsGelUvxRfqsMYRY5JduCGyZ7s6AzOhqsRf3kOhk";
  const sb = window.sb || (window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY));
  const T_CLIENTES = "clientes";

  // =========================
  // === Roles UI ===
  // =========================
  const ADMIN_PIN = "1234";
  const ROLE_KEY = "vdc_role_ui";
  let role = localStorage.getItem(ROLE_KEY) || "op";

  const $ = (id)=>document.getElementById(id);

  const roleChip = $("roleChip");
  const btnCambiarUsuario = $("btnCambiarUsuario");

  const modalBg = $("modalBg");
  const btnSetOp = $("btnSetOp");
  const btnSetAdmin = $("btnSetAdmin");
  const pinBox = $("pinBox");
  const adminPin = $("adminPin");
  const pinMsg = $("pinMsg");
  const btnOkPin = $("btnOkPin");
  const btnCancelPin = $("btnCancelPin");
  const btnCloseModal = $("btnCloseModal");

  const toggleBtn = $("toggle");
  const switchBtn = $("switchCam");
  const filePick = $("filePick");

  const totalKgEl = $("totalKg");
  const countLinesEl = $("countLines");
  const fpShortEl = $("fpShort");

  const opToast = $("opToast");
  const out = $("out");

  const ventasBox = $("ventasClienteBox");
  const btnVerVentas = $("btnVerVentas");
  const btnLimpiarVentas = $("btnLimpiarVentas");

  let currentClient = null;
  let clientsCache = [];

  let scanner = null;
  let running = false;
  let cameras = [];
  let camIndex = 0;

  let busy = false;
  const BUSY_COOLDOWN_MS = 900;

  let ticketItemsUi = [];
  let ticketItemsInv = [];
  let lastClientQrUrl = "";

  // =========================
  // ‚úÖ EXCLUSIONES (NO SUMAR NI DESCONTAR)
  // =========================
  const EXCLUDE_PRODUCTS_RE = /(PELLEJO|BOLSA|BOLSAS|PLASTICO|PL√ÅSTICO)/i;
  const BOX_FULL_KG = 27.22;

  function normalizeLine(s){ return String(s||"").replace(/\s+/g," ").trim(); }
  function toNum(s){
    const v = Number(String(s ?? "").replace(",", ".").trim());
    return Number.isFinite(v) ? v : NaN;
  }
  function cleanPhone(s){ return String(s||"").replace(/\D/g,"").slice(-10); }
  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function isExcludedProduct(name){ return EXCLUDE_PRODUCTS_RE.test(String(name||"")); }

  function logAdmin(txt){ if(out) out.textContent = txt; }

  function showOpToast(type, title, details){
    opToast.style.display = "block";
    opToast.className = "toast " + (type === "ok" ? "ok" : "bad");
    opToast.innerHTML = `<div class="t">${escapeHtml(title||"")}</div><div class="d">${escapeHtml(details||"")}</div>`;
    setTimeout(()=>{ opToast.style.display = "none"; }, 4500);
  }

  function setMsg(type, text){
    const el = $("msg");
    el.className = "muted";
    el.textContent = text;
  }

  function renderStatus(){
    $("stCliente").textContent = "Cliente: " + (currentClient ? (currentClient.nombre || currentClient.telefono) : "‚Äî");
    $("stPuntos").textContent  = "Puntos: " + (currentClient ? currentClient.puntos : "‚Äî");
    $("stSaldo").textContent   = "Saldo kg: " + (currentClient ? Number(currentClient.saldo_kg||0).toFixed(3) : "‚Äî");
  }

  function applyRoleUI(){
    roleChip.textContent = "Modo: " + (role === "admin" ? "Admin" : "Operador");
    document.body.classList.toggle("role-op", role !== "admin");

    document.querySelectorAll(".adminOnly").forEach(el=> el.style.display = (role==="admin") ? "" : "none");
    document.querySelectorAll(".opOnly").forEach(el=> el.style.display = (role==="admin") ? "none" : "");
  }

  function openModal(){ modalBg.style.display="grid"; pinBox.style.display="none"; pinMsg.textContent=""; adminPin.value=""; }
  function closeModal(){ modalBg.style.display="none"; pinBox.style.display="none"; pinMsg.textContent=""; adminPin.value=""; }

  btnCambiarUsuario.addEventListener("click", ()=>{ if(role!=="admin") return; openModal(); });
  btnCloseModal.addEventListener("click", closeModal);

  btnSetOp.addEventListener("click", ()=>{
    role="op"; localStorage.setItem(ROLE_KEY, role); applyRoleUI(); closeModal();
  });
  btnSetAdmin.addEventListener("click", ()=>{ pinBox.style.display="block"; adminPin.focus(); });
  btnCancelPin.addEventListener("click", ()=>{ pinBox.style.display="none"; pinMsg.textContent=""; adminPin.value=""; });

  btnOkPin.addEventListener("click", ()=>{
    if(String(adminPin.value||"").trim() === ADMIN_PIN){
      role="admin"; localStorage.setItem(ROLE_KEY, role); applyRoleUI(); closeModal();
    } else {
      pinMsg.style.color="#ef4444"; pinMsg.textContent="PIN incorrecto.";
    }
  });
  modalBg.addEventListener("click",(e)=>{ if(e.target===modalBg) closeModal(); });

  function siteBaseUrl(){
    const u = new URL(window.location.href);
    return u.origin + u.pathname;
  }

  async function renderClientQR(){
    const box = $("qrClienteBox");
    const txt = $("qrClienteText");
    box.innerHTML = "";
    if(txt) txt.textContent = "";

    if(!currentClient?.id){
      box.innerHTML = `<span class="muted">Selecciona un cliente para generar su QR</span>`;
      lastClientQrUrl = "";
      return;
    }

    const url = `${siteBaseUrl()}?cid=${encodeURIComponent(currentClient.id)}`;
    lastClientQrUrl = url;

    const img = document.createElement("img");
    img.alt = "QR del cliente";
    img.src = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(url)}`;
    box.appendChild(img);

    if(txt) txt.innerHTML = `URL en QR: <code>${url}</code>`;
  }

  $("btnCopiarUrl")?.addEventListener("click", async ()=>{
    if(!lastClientQrUrl) return setMsg("bad","No hay URL. Selecciona cliente primero.");
    try{ await navigator.clipboard.writeText(lastClientQrUrl); setMsg("ok","URL copiada ‚úÖ"); }
    catch{ setMsg("bad","No pude copiar (permiso del navegador)."); }
  });

  $("btnAbrirUrl")?.addEventListener("click", ()=>{
    if(!lastClientQrUrl) return setMsg("bad","No hay URL. Selecciona cliente primero.");
    window.open(lastClientQrUrl, "_blank");
  });

  // =========================
  // ‚úÖ Ventas del cliente (ROBUSTO)
  // =========================
  function showVentasError(errText){
    if(!ventasBox) return;
    ventasBox.innerHTML = `<div class="errBox">NO PUDE CARGAR VENTAS:\n${escapeHtml(errText)}</div>`;
  }

  async function fetchVentas(clienteId){
    // ojo: tus columnas seg√∫n screenshot: fecha, tipo, cliente_id, total_kg, puntos_otorgados
    const res = await sb
      .from("ventas")
      .select("id,fecha,tipo,total_kg,puntos_otorgados,cliente_id")
      .eq("cliente_id", clienteId)
      .order("fecha", { ascending:false })
      .limit(200);

    if(res.error) throw res.error;
    return res.data || [];
  }

  async function fetchItemsForVentas(ventaIds){
    if(!ventaIds.length) return { tableUsed:null, byVentaId:{} };

    // 1) intentar ventas_items
    let r1 = await sb
      .from("ventas_items")
      .select("venta_id,sku,kg")
      .in("venta_id", ventaIds);

    if(!r1.error){
      const by = {};
      for(const it of (r1.data||[])){
        const vid = it.venta_id;
        if(!by[vid]) by[vid] = [];
        by[vid].push(it);
      }
      return { tableUsed:"ventas_items", byVentaId: by };
    }

    // 2) intentar venta_detalle (por si ah√≠ est√° el detalle)
    let r2 = await sb
      .from("venta_detalle")
      .select("venta_id,sku,kg")
      .in("venta_id", ventaIds);

    if(!r2.error){
      const by = {};
      for(const it of (r2.data||[])){
        const vid = it.venta_id;
        if(!by[vid]) by[vid] = [];
        by[vid].push(it);
      }
      return { tableUsed:"venta_detalle", byVentaId: by };
    }

    // si fallan ambas, regresamos error combinado
    throw new Error(`No pude leer ventas_items (${r1.error?.message || "?"}) ni venta_detalle (${r2.error?.message || "?"}).`);
  }

  async function renderVentasCliente(){
    if(!ventasBox) return;
    if(!currentClient){
      ventasBox.textContent = "Selecciona un cliente‚Ä¶";
      return;
    }

    ventasBox.textContent = "Cargando ventas‚Ä¶";

    try{
      const ventas = await fetchVentas(currentClient.id);

      if(!ventas.length){
        ventasBox.textContent = "Este cliente no tiene ventas a√∫n.";
        return;
      }

      const ids = ventas.map(v=>v.id);
      let itemsMap = {};
      let tableUsed = null;

      try{
        const pack = await fetchItemsForVentas(ids);
        itemsMap = pack.byVentaId || {};
        tableUsed = pack.tableUsed;
      }catch(e){
        // si no hay items, igual mostramos ventas sin detalle
        tableUsed = null;
        itemsMap = {};
        // mostramos aviso leve, no bloquea
        console.warn("Sin detalle items:", e);
      }

      let totalKg = 0;
      let totalPts = 0;

      const cards = ventas.map(v=>{
        totalKg += Number(v.total_kg || 0);
        totalPts += Number(v.puntos_otorgados || 0);

        const items = (itemsMap[v.id] || []).map(it =>
          `<div>‚Ä¢ ${escapeHtml(it.sku)} ‚Äî ${Number(it.kg||0).toFixed(3)} kg</div>`
        ).join("");

        const head = `${String(v.fecha||"‚Äî")} ‚Äî ${String(v.tipo||"")}`;

        return `
          <div class="ventaCard">
            <div class="ventaTop">
              <b>${escapeHtml(head)}</b>
              <div><b>${Number(v.total_kg||0).toFixed(3)} kg</b></div>
            </div>
            <div class="ventaMini">
              Puntos: ${Number(v.puntos_otorgados||0)} ¬∑ ID: ${escapeHtml(String(v.id).slice(0,8))}‚Ä¶
              ${tableUsed ? ` ¬∑ Detalle: ${escapeHtml(tableUsed)}` : ` ¬∑ (sin detalle)` }
            </div>
            <div class="ventaItems">${items || `<div class="muted">Sin detalle de productos</div>`}</div>
          </div>
        `;
      }).join("");

      ventasBox.innerHTML = `
        <div class="ventaResume">Total acumulado: ${totalKg.toFixed(3)} kg ¬∑ ${totalPts} puntos</div>
        ${cards}
      `;
    }catch(e){
      showVentasError(e?.message || String(e));
    }
  }

  btnVerVentas?.addEventListener("click", renderVentasCliente);
  btnLimpiarVentas?.addEventListener("click", ()=>{ ventasBox.textContent = "Selecciona un cliente‚Ä¶"; });

  // =========================
  // Clientes: datalist + CRUD
  // =========================
  async function loadNameDatalist(){
    const dl = $("nombreList");
    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .order("nombre", { ascending: true })
      .limit(5000);

    if(error){ console.error(error); return; }

    clientsCache = (data || []).filter(c => (c.nombre || "").trim().length > 0);
    dl.innerHTML = "";
    for(const c of clientsCache){
      const opt = document.createElement("option");
      opt.value = c.nombre;
      opt.label = `${c.nombre} ‚Äî ${c.telefono || ""}`;
      dl.appendChild(opt);
    }
  }

  function findClientByName(name){
    const n = normalizeLine(name).toLowerCase();
    return clientsCache.find(c => normalizeLine(c.nombre || "").toLowerCase() === n) || null;
  }

  $("nombre").addEventListener("input", async ()=>{
    const c = findClientByName($("nombre").value);
    if(c){
      $("tel").value = c.telefono || "";
      currentClient = c;
      renderStatus();
      await renderClientQR();
      setMsg("ok","Cliente cargado ‚úÖ");
      if(role === "admin") await renderVentasCliente();
    }
  });

  async function buscarClientePorNombreOTel(){
    const nombre = normalizeLine($("nombre").value);
    const tel = cleanPhone($("tel").value);
    if(!nombre) throw new Error("Nombre es obligatorio.");

    const cached = findClientByName(nombre);
    if(cached){
      currentClient = cached;
      $("tel").value = cached.telefono || tel;
      renderStatus();
      await renderClientQR();
      setMsg("ok","Cliente encontrado ‚úÖ");
      if(role === "admin") await renderVentasCliente();
      return;
    }

    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .ilike("nombre", nombre)
      .maybeSingle();

    if(error) throw error;

    currentClient = data || null;
    if(data) $("tel").value = data.telefono || tel;
    renderStatus();
    await renderClientQR();

    setMsg("ok", data ? "Cliente encontrado ‚úÖ" : "No existe: crea el cliente.");
    if(data && role === "admin") await renderVentasCliente();
  }

  async function crearOActualizarCliente(){
    const nombre = normalizeLine($("nombre").value);
    const tel = cleanPhone($("tel").value);

    if(!nombre) throw new Error("Nombre es obligatorio.");
    if(tel && tel.length !== 10) throw new Error("Tel√©fono inv√°lido (10 d√≠gitos).");

    const payload = { nombre };
    if(tel) payload.telefono = tel;

    let res;
    if(tel){
      res = await sb.from(T_CLIENTES).upsert(payload, { onConflict: "telefono" })
        .select("id,telefono,nombre,puntos,saldo_kg").single();
    }else{
      res = await sb.from(T_CLIENTES).insert(payload)
        .select("id,telefono,nombre,puntos,saldo_kg").single();
    }

    if(res.error) throw res.error;

    currentClient = res.data;
    renderStatus();
    await renderClientQR();
    setMsg("ok", "Cliente creado/actualizado ‚úÖ");
    await loadNameDatalist();
    if(role === "admin") await renderVentasCliente();
  }

  $("btnBuscar").addEventListener("click", async ()=>{
    setMsg("muted","Buscando...");
    try{ await buscarClientePorNombreOTel(); }
    catch(e){ console.error(e); setMsg("bad", e.message || String(e)); }
  });

  $("btnCrear").addEventListener("click", async ()=>{
    setMsg("muted","Guardando...");
    try{ await crearOActualizarCliente(); }
    catch(e){ console.error(e); setMsg("bad", e.message || String(e)); }
  });

  $("btnReloadNames").addEventListener("click", async ()=>{
    setMsg("muted","Recargando...");
    await loadNameDatalist();
    setMsg("ok","Listo ‚úÖ");
  });

  // =========================
  // Cargar cliente por ?cid=
  // =========================
  async function cargarClientePorQuery(){
    const u = new URL(window.location.href);
    const cid = u.searchParams.get("cid");
    if(!cid) return;

    const { data, error } = await sb
      .from(T_CLIENTES)
      .select("id,telefono,nombre,puntos,saldo_kg")
      .eq("id", cid)
      .maybeSingle();

    if(error){ console.error(error); setMsg("bad", "Error cargando cid: " + error.message); return; }
    if(!data){ setMsg("bad", "Este cid no existe."); return; }

    currentClient = data;
    $("nombre").value = data.nombre || "";
    $("tel").value = data.telefono || "";
    renderStatus();
    await renderClientQR();
    setMsg("ok", "Cliente cargado desde QR ‚úÖ");
    if(role === "admin") await renderVentasCliente();
  }

  // =========================
  // INIT
  // =========================
  (async function init(){
    applyRoleUI();
    renderStatus();
    await loadNameDatalist();
    await cargarClientePorQuery();
    logAdmin("Listo.");
  })();
</script>

</body>
</html>
